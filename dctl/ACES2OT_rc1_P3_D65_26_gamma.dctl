// DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(asPQ, Encode as PQ P3-D65 48nits, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)

__CONSTANT__ int toneCurve = 1;
__CONSTANT__ int compressChroma = 1;
__CONSTANT__ int gamutCompress = 1;
__CONSTANT__ int d60Sim = 0;
__CONSTANT__ int asPQ = 0;
__CONSTANT__ int ap1Clip = 1;
__CONSTANT__ int softClip = 0;
__CONSTANT__ int hardClip = 1;
__CONSTANT__ int invert = 0;
__CONSTANT__ int JMhOut = 0;

typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// P3-D65 to XYZ matrix
    { 0.4865709486f,  0.2656676932f,  0.1982172852f },
    { 0.2289745641f,  0.6917385218f,  0.0792869141f },
    {-0.0000000000f,  0.0451133819f,  1.0439443689f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float limitJmax = 100.0f;
__CONSTANT__ float midJ = 34.0965348204f; // ~10 nits in Hellwig J
__CONSTANT__ float focusDist = 1.35f;

__CONSTANT__ float daniele_n = 100.0f; // peak white
__CONSTANT__ float daniele_m_2 = 1.0471037624f;
__CONSTANT__ float daniele_s_2 = 0.9198582542f;
__CONSTANT__ float daniele_u_2 = 0.9917990155f;  

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 1.3f;
__CONSTANT__ float sat_thr = 0.005f;
__CONSTANT__ float compr = 2.4f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 56.6186185097f,  82.7991705957f,  0.7144441816f },
    { 56.3257539736f,  83.0869759912f,  1.6043698209f },
    { 56.0301471166f,  83.3873537826f,  2.5293648066f },
    { 55.7316515798f,  83.7010920892f,  3.4936139576f },
    { 55.4300986440f,  84.0291345807f,  4.5021633543f },
    { 55.1252910861f,  84.3726358550f,  5.5611765832f },
    { 54.8169945709f,  84.7330431271f,  6.6782956942f },
    { 54.5049252401f,  85.1122201527f,  7.8631638493f },
    { 54.1887312081f,  85.5126415289f,  9.1282071122f },
    { 53.8679638478f,  85.9377096100f,  10.4898504831f },
    { 53.5420309999f,  86.3922970277f,  11.9705021835f },
    { 53.2101159219f,  86.8837335588f,  13.6019923411f },
    { 52.8710253494f,  87.4237485761f,  15.4320158901f },
    { 52.5228725486f,  88.0327267080f,  17.5375524150f },
    { 52.1623057815f,  88.7506004193f,  20.0574496456f },
    { 51.7820982579f,  89.6727391146f,  23.2938063738f },
    { 51.3585147523f,  91.1504716205f,  28.2400666861f },
    { 52.3587025581f,  87.5878992360f,  29.7993105677f },
    { 53.3300227981f,  84.3445766179f,  31.3923527408f },
    { 54.2752157191f,  81.3852915274f,  33.0172000061f },
    { 55.1965774859f,  78.6809415254f,  34.6718596614f },
    { 56.0960580951f,  76.2071602188f,  36.3542356750f },
    { 56.9753327918f,  73.9433029168f,  38.0620715197f },
    { 57.8358553265f,  71.8716838836f,  39.7929214009f },
    { 58.6788984336f,  69.9769935899f,  41.5441403069f },
    { 59.5055851194f,  68.2458473376f,  43.3128875581f },
    { 60.3169132044f,  66.6664315580f,  45.0961406629f },
    { 61.1137748317f,  65.2282239777f,  46.8907173396f },
    { 61.8969721591f,  63.9217705412f,  48.6933040608f },
    { 62.6672301169f,  62.7385065738f,  50.5004896846f },
    { 63.4252068814f,  61.6706128752f,  52.3088027998f },
    { 64.1715025513f,  60.7108996991f,  54.1147514180f },
    { 64.9066663926f,  59.8527131906f,  55.9148636515f },
    { 65.6312029345f,  59.0898600306f,  57.7057280452f },
    { 66.3455771339f,  58.4165468903f,  59.4840323027f },
    { 67.0502187788f,  57.8273319498f,  61.2465992717f },
    { 67.7455262661f,  57.3170862170f,  62.9904192196f },
    { 68.4318698584f,  56.8809627715f,  64.7126776347f },
    { 69.1095945090f,  56.5143723613f,  66.4107780141f },
    { 69.7790223219f,  56.2129640356f,  68.0823593364f },
    { 70.4404547051f,  55.9726097091f,  69.7253081433f },
    { 71.0941742623f,  55.7893917396f,  71.3377653624f },
    { 71.7404464624f,  55.6595927602f,  72.9181281824f },
    { 72.3795211181f,  55.5796871491f,  74.4650474330f },
    { 73.0116336995f,  55.5463336445f,  75.9774210210f },
    { 73.6370065060f,  55.5563687200f,  77.4543840401f },
    { 74.2558497143f,  55.6068004251f,  78.8952961935f },
    { 74.8683623186f,  55.6948024804f,  80.2997271635f },
    { 75.4747329772f,  55.8177084747f,  81.6674405332f },
    { 76.0751407754f,  55.9730060678f,  82.9983768091f },
    { 76.6697559160f,  56.1583311462f,  84.2926360369f },
    { 77.2587403459f,  56.3714619048f,  85.5504604259f },
    { 77.8422483241f,  56.6103128574f,  86.7722173308f },
    { 78.4204269410f,  56.8729287917f,  87.9583828643f },
    { 78.9934165906f,  57.1574786950f,  89.1095263502f },
    { 79.5613514036f,  57.4622496850f,  90.2262957667f },
    { 80.1243596439f,  57.7856409802f,  91.3094042768f },
    { 80.6825640720f,  58.1261579453f,  92.3596178966f },
    { 81.2360822804f,  58.4824062444f,  93.3777443209f },
    { 81.7850270017f,  58.8530861324f,  94.3646228894f },
    { 82.3295063931f,  59.2369869099f,  95.3211156594f },
    { 82.8696242995f,  59.6329815628f,  96.2480995334f },
    { 83.4054804970f,  60.0400216043f,  97.1464593760f },
    { 83.9371709184f,  60.4571321315f,  98.0170820507f },
    { 84.4647878626f,  60.8834071049f,  98.8608513010f },
    { 84.9884201894f,  61.3180048572f,  99.6786433994f },
    { 85.5081535008f,  61.7601438332f,  100.4713234912f },
    { 86.0240703094f,  62.2090985589f,  101.2397425575f },
    { 86.5362501965f,  62.6641958389f,  101.9847349321f },
    { 87.0447699586f,  63.1248111761f,  102.7071163045f },
    { 87.5497037456f,  63.5903654078f,  103.4076821520f },
    { 88.0511231888f,  64.0603215506f,  104.0872065440f },
    { 88.5490975225f,  64.5341818471f,  104.7464412698f },
    { 89.0436936965f,  65.0114850033f,  105.3861152450f },
    { 89.5349764824f,  65.4918036100f,  106.0069341551f },
    { 90.0230085741f,  65.9747417368f,  106.6095803025f },
    { 90.5078506812f,  66.4599326907f,  107.1947126220f },
    { 90.2918826650f,  66.5035438717f,  107.7718564318f },
    { 90.0752262668f,  66.5545183214f,  108.3513883086f },
    { 89.8578749584f,  66.6129621853f,  108.9332055058f },
    { 89.6398221056f,  66.6789813468f,  109.5172026380f },
    { 89.4210609660f,  66.7526813786f,  110.1032717771f },
    { 89.2015846866f,  66.8341674949f,  110.6913025537f },
    { 88.9813863010f,  66.9235445052f,  111.2811822674f },
    { 88.7604587269f,  67.0209167700f,  111.8727960033f },
    { 88.5387947631f,  67.1263881584f,  112.4660267541f },
    { 88.3163870872f,  67.2400620084f,  113.0607555508f },
    { 88.0932282520f,  67.3620410889f,  113.6568615968f },
    { 87.8693106832f,  67.4924275650f,  114.2542224102f },
    { 87.6446266756f,  67.6313229654f,  114.8527139692f },
    { 87.4191683906f,  67.7788281541f,  115.4522108640f },
    { 87.1929278523f,  67.9350433035f,  116.0525864524f },
    { 86.9658969444f,  68.1000678730f,  116.6537130197f },
    { 86.7380674070f,  68.2740005895f,  117.2554619417f },
    { 86.5094308320f,  68.4569394323f,  117.8577038512f },
    { 86.2799786607f,  68.6489816225f,  118.4603088069f },
    { 86.0497021786f,  68.8502236157f,  119.0631464638f },
    { 85.8185925124f,  69.0607610988f,  119.6660862457f },
    { 85.5866406255f,  69.2806889924f,  120.2689975177f },
    { 85.3538373134f,  69.5101014561f,  120.8717497598f },
    { 85.1201732001f,  69.7490918994f,  121.4742127399f },
    { 84.8856387327f,  69.9977529972f,  122.0762566852f },
    { 84.6502241772f,  70.2561767098f,  122.6777524537f },
    { 84.4139196135f,  70.5244543079f,  123.2785717023f },
    { 84.1767149302f,  70.8026764025f,  123.8785870531f },
    { 83.9385998196f,  71.0909329798f,  124.4776722565f },
    { 83.6995637721f,  71.3893134412f,  125.0757023509f },
    { 83.4595960707f,  71.6979066479f,  125.6725538182f },
    { 83.2186857851f,  72.0168009716f,  126.2681047350f },
    { 82.9768217659f,  72.3460843490f,  126.8622349184f },
    { 82.7339926379f,  72.6858443422f,  127.4548260674f },
    { 82.4901867942f,  73.0361682042f,  128.0457618978f },
    { 82.2453923890f,  73.3971429490f,  128.6349282714f },
    { 81.9995973309f,  73.7688554271f,  129.2222133186f },
    { 81.7527892758f,  74.1513924059f,  129.8075075553f },
    { 81.5049556189f,  74.5448406553f,  130.3907039913f },
    { 81.2560834873f,  74.9492870381f,  130.9716982336f },
    { 81.0061597320f,  75.3648186052f,  131.5503885806f },
    { 80.7551709190f,  75.7915226961f,  132.1266761106f },
    { 80.5031033212f,  76.2294870440f,  132.7004647619f },
    { 80.2499429086f,  76.6787998860f,  133.2716614054f },
    { 79.9956753394f,  77.1395500776f,  133.8401759103f },
    { 79.7402859501f,  77.6118272129f,  134.4059212018f },
    { 79.4837597447f,  78.0957217486f,  134.9688133114f },
    { 79.2260813848f,  78.5913251340f,  135.5287714201f },
    { 78.9672351780f,  79.0987299442f,  136.0857178939f },
    { 78.7072050664f,  79.6180300200f,  136.6395783124f },
    { 78.4459746146f,  80.1493206110f,  137.1902814906f },
    { 78.1835269972f,  80.6926985246f,  137.7377594933f },
    { 77.9198449854f,  81.2482622799f,  138.2819476434f },
    { 77.6549109333f,  81.8161122659f,  138.8227845238f },
    { 77.3887067641f,  82.3963509056f,  139.3602119728f },
    { 77.1212139545f,  82.9890828253f,  139.8941750738f },
    { 76.8524135193f,  83.5944150285f,  140.4246221394f },
    { 76.5822859953f,  84.2124570766f,  140.9515046901f },
    { 76.3108114238f,  84.8433212738f,  141.4747774283f },
    { 76.0379693331f,  85.4871228597f,  141.9943982064f },
    { 76.2683033902f,  82.6786238548f,  143.1060240885f },
    { 76.4929655271f,  80.1977486945f,  144.1640530868f },
    { 76.7131623440f,  77.9694675074f,  145.1827096486f },
    { 76.9297025630f,  75.9435659259f,  146.1714927979f },
    { 77.1431590358f,  74.0845407103f,  147.1370943062f },
    { 77.3539548919f,  72.3662265810f,  148.0844201282f },
    { 77.5624131244f,  70.7687032424f,  149.0171788999f },
    { 77.7687869300f,  69.2764027817f,  149.9382422185f },
    { 77.9732791967f,  67.8768938312f,  150.8498761239f },
    { 78.1760555292f,  66.5600688352f,  151.7538958099f },
    { 78.3772532470f,  65.3175824947f,  152.6517724789f },
    { 78.5769877771f,  64.1424527416f,  153.5447092252f },
    { 78.7753573057f,  63.0287703051f,  154.4336962291f },
    { 78.9724462350f,  61.9714828646f,  155.3195517478f },
    { 79.1683277983f,  60.9662316760f,  156.2029531230f },
    { 79.3630660714f,  60.0092259023f,  157.0844606254f },
    { 79.5567175415f,  59.0971445474f,  157.9645360663f },
    { 79.7493323468f,  58.2270589383f,  158.8435575226f },
    { 79.9409552679f,  57.3963707342f,  159.7218311375f },
    { 80.1316265282f,  56.6027618279f,  160.5996006902f },
    { 80.3213824470f,  55.8441534711f,  161.4770554462f },
    { 80.5102559766f,  55.1186726294f,  162.3543366687f },
    { 80.6982771478f,  54.4246240692f,  163.2315430786f },
    { 80.8854734426f,  53.7604670260f,  164.1087354821f },
    { 81.0718701071f,  53.1247955718f,  164.9859407353f },
    { 81.2574904165f,  52.5163219902f,  165.8631551759f },
    { 81.4423559011f,  51.9338626181f,  166.7403476272f },
    { 81.6264865400f,  51.3763257222f,  167.6174620532f },
    { 81.8099009269f,  50.8427010680f,  168.4944199315f },
    { 81.9926164143f,  50.3320509032f,  169.3711223932f },
    { 82.1746492388f,  49.8435021307f,  170.2474521731f },
    { 82.3560146298f,  49.3762394889f,  171.1232754020f },
    { 82.5367269054f,  48.9294995874f,  171.9984432663f },
    { 82.7167995564f,  48.5025656744f,  172.8727935591f },
    { 82.8962453201f,  48.0947630317f,  173.7461521369f },
    { 83.0750762466f,  47.7054549119f,  174.6183342954f },
    { 83.2533037565f,  47.3340389444f,  175.4891460778f },
    { 83.4309386935f,  46.9799439492f,  176.3583855191f },
    { 83.6079913703f,  46.6426271068f,  177.2258438375f },
    { 83.7844716105f,  46.3215714401f,  178.0913065736f },
    { 83.9603887861f,  46.0162835702f,  178.9545546834f },
    { 84.1357518510f,  45.7262917137f,  179.8153655859f },
    { 84.3105693716f,  45.4511438937f,  180.6735141679f },
    { 84.4848495541f,  45.1904063395f,  181.5287737461f },
    { 84.6586002696f,  44.9436620552f,  182.3809169867f },
    { 84.8318290771f,  44.7105095372f,  183.2297167833f },
    { 85.0045432437f,  44.4905616252f,  184.0749470919f },
    { 85.1767497638f,  44.2834444727f,  184.9163837226f },
    { 85.3484553762f,  44.0887966237f,  185.7538050880f },
    { 85.5196665800f,  43.9062681847f,  186.5869929068f },
    { 85.6903896492f,  43.7355200824f,  187.4157328625f },
    { 85.8606306457f,  43.5762233973f,  188.2398152166f },
    { 86.0303954322f,  43.4280587671f,  189.0590353755f },
    { 86.1996896828f,  43.2907158502f,  189.8731944114f },
    { 86.3685188941f,  43.1638928451f,  190.6820995368f },
    { 86.5368883943f,  43.0472960591f,  191.4855645326f },
    { 86.7048033529f,  42.9406395211f,  192.2834101306f },
    { 86.8722687883f,  42.8436446333f,  193.0754643497f },
    { 87.0392895758f,  42.7560398591f,  193.8615627886f },
    { 87.2058704549f,  42.6775604415f,  194.6415488735f },
    { 86.6963039523f,  42.3244713275f,  195.4286427246f },
    { 86.1831122385f,  41.9761908305f,  196.2359788899f },
    { 85.6662223326f,  41.6330680061f,  197.0640938990f },
    { 85.1455587931f,  41.2954708438f,  197.9135241422f },
    { 84.6210436006f,  40.9637870751f,  198.7848035433f },
    { 84.0925960330f,  40.6384249799f,  199.6784609310f },
    { 83.5601325332f,  40.3198141862f,  200.5950170916f },
    { 83.0235665684f,  40.0084064549f,  201.5349814822f },
    { 82.4828084794f,  39.7046764422f,  202.4988485909f },
    { 81.9377653215f,  39.4091224286f,  203.4870939296f },
    { 81.3883406935f,  39.1222670074f,  204.5001696510f },
    { 80.8344345557f,  38.8446577180f,  205.5384997877f },
    { 80.2759430356f,  38.5768676142f,  206.6024751153f },
    { 79.7127582192f,  38.3194957544f,  207.6924476520f },
    { 79.1447679290f,  38.0731675989f,  208.8087248157f },
    { 78.5718554841f,  37.8385353025f,  209.9515632702f },
    { 77.9938994448f,  37.6162778873f,  211.1211625064f },
    { 77.4107733365f,  37.4071012821f,  212.3176582167f },
    { 76.8223453539f,  37.2117382171f,  213.5411155372f },
    { 76.2284780422f,  37.0309479612f,  214.7915222491f },
    { 75.6290279525f,  36.8655158934f,  216.0687820460f },
    { 75.0238452717f,  36.7162529022f,  217.3727079935f },
    { 74.4127734202f,  36.5839946088f,  218.7030163200f },
    { 73.7956486183f,  36.4696004177f,  220.0593206978f },
    { 73.1722994152f,  36.3739523997f,  221.4411271803f },
    { 72.5425461778f,  36.2979540216f,  222.8478299755f },
    { 71.9062005355f,  36.2425287416f,  224.2787082375f },
    { 71.2630647749f,  36.2086185005f,  225.7329240587f },
    { 70.6129311801f,  36.1971821422f,  227.2095218377f },
    { 69.9555813116f,  36.2091938122f,  228.7074291846f },
    { 69.2907852179f,  36.2456413861f,  230.2254595035f },
    { 68.6183005694f,  36.3075249943f,  231.7623163635f },
    { 67.9378717088f,  36.3958557154f,  233.3165997326f },
    { 67.2492286045f,  36.5116545206f,  234.8868141082f },
    { 66.5520856962f,  36.6559515602f,  236.4713785279f },
    { 65.8461406196f,  36.8297858894f,  238.0686383979f },
    { 65.1310727918f,  37.0342057397f,  239.6768790216f },
    { 64.4065418418f,  37.2702694459f,  241.2943406648f },
    { 63.6721858613f,  37.5390471463f,  242.9192349494f },
    { 62.9276194531f,  37.8416233791f,  244.5497623285f },
    { 62.1724315457f,  38.1791007042f,  246.1841303738f },
    { 61.4061829393f,  38.5526044878f,  247.8205725854f },
    { 60.6284035431f,  38.9632889986f,  249.4573674403f },
    { 59.8385892529f,  39.4123449790f,  251.0928574022f },
    { 59.0361984121f,  39.9010088747f,  252.7254676522f },
    { 58.2206477843f,  40.4305739383f,  254.3537243359f },
    { 57.3913079542f,  41.0024034597f,  255.9762721864f },
    { 56.5474980533f,  41.6179464327f,  257.5918914507f },
    { 55.6884796851f,  42.2787560422f,  259.1995141328f },
    { 54.8134498971f,  42.9865114552f,  260.7982396605f },
    { 53.9215330083f,  43.7430435314f,  262.3873501976f },
    { 53.0117710584f,  44.5503652503f,  263.9663259413f },
    { 52.0831125802f,  45.4107078866f,  265.5348608961f },
    { 51.1343993233f,  46.3265642893f,  267.0928797833f },
    { 50.1643504507f,  47.3007410575f,  268.6405569587f },
    { 49.1715435941f,  48.3364220013f,  270.1783384841f },
    { 48.1543919691f,  49.4372461130f,  271.7069688523f },
    { 47.1111164965f,  50.6074044413f,  273.2275243588f },
    { 46.0397115306f,  51.8517619405f,  274.7414558003f },
    { 44.9379022974f,  53.1760128066f,  276.2506441708f },
    { 45.4471446073f,  52.9297939840f,  278.2596592216f },
    { 45.9486777175f,  52.7478010287f,  280.2316106466f },
    { 46.4428453771f,  52.6258434037f,  282.1642990570f },
    { 46.9299661186f,  52.5599266969f,  284.0558553443f },
    { 47.4103357861f,  52.5462478250f,  285.9047397303f },
    { 47.8842297460f,  52.5811911570f,  287.7097342425f },
    { 48.3519048293f,  52.6613250461f,  289.4699296895f },
    { 48.8136010415f,  52.7833983967f,  291.1847082551f },
    { 49.2695430758f,  52.9443370129f,  292.8537228123f },
    { 49.7199416550f,  53.1412395672f,  294.4768739931f },
    { 50.1649947258f,  53.3713731104f,  296.0542859459f },
    { 50.6048885248f,  53.6321680980f,  297.5862815925f },
    { 51.0397985322f,  53.9212129550f,  299.0733580619f },
    { 51.4698903285f,  54.2362482291f,  300.5161628439f },
    { 51.8953203644f,  54.5751604040f,  301.9154710784f },
    { 52.3162366555f,  54.9359754497f,  303.2721642799f },
    { 52.7327794108f,  55.3168521944f,  304.5872106944f },
    { 53.1450816014f,  55.7160755989f,  305.8616474006f },
    { 53.5532694771f,  56.1320500073f,  307.0965641954f },
    { 53.9574630366f,  56.5632924438f,  308.2930892488f },
    { 54.3577764558f,  57.0084260130f,  309.4523764712f },
    { 54.7543184794f,  57.4661734532f,  310.5755945057f },
    { 55.1471927785f,  57.9353508849f,  311.6639172365f },
    { 55.5364982794f,  58.4148617838f,  312.7185156940f },
    { 55.9223294639f,  58.9036912033f,  313.7405512296f },
    { 56.3047766474f,  59.4009002637f,  314.7311698337f },
    { 56.6839262330f,  59.9056209160f,  315.6914974726f },
    { 57.0598609477f,  60.4170509883f,  316.6226363259f },
    { 57.4326600589f,  60.9344495134f,  317.5256618127f },
    { 57.8023995760f,  61.4571323353f,  318.4016203043f },
    { 58.1691524365f,  61.9844679889f,  319.2515274294f },
    { 58.5329886785f,  62.5158738446f,  320.0763668863f },
    { 58.8939756009f,  63.0508125080f,  320.8770896871f },
    { 59.2521779131f,  63.5887884643f,  321.6546137648f },
    { 59.6076578728f,  64.1293449552f,  322.4098238854f },
    { 59.9604754161f,  64.6720610754f,  323.1435718118f },
    { 60.3106882778f,  65.2165490786f,  323.8566766735f },
    { 60.6583521038f,  65.7624518778f,  324.5499255045f },
    { 61.0035205566f,  66.3094407298f,  325.2240739133f },
    { 61.3462454141f,  66.8572130911f,  325.8798468573f },
    { 61.6865766613f,  67.4054906340f,  326.5179394968f },
    { 62.0245625774f,  67.9540174112f,  327.1390181070f },
    { 62.3602498166f,  68.5025581601f,  327.7437210303f },
    { 62.6936834845f,  69.0508967351f,  328.3326596553f },
    { 63.0249072100f,  69.5988346590f,  328.9064194080f },
    { 63.3539632124f,  70.1461897856f,  329.4655607481f },
    { 63.6808923653f,  70.6927950639f,  330.0106201586f },
    { 64.0057342563f,  71.2384973976f,  330.5421111246f },
    { 64.3285272435f,  71.7831565907f,  331.0605250952f },
    { 64.6493085087f,  72.3266443753f,  331.5663324236f },
    { 64.9681141082f,  72.8688435128f,  332.0599832828f },
    { 65.2849790197f,  73.4096469637f,  332.5419085543f },
    { 65.5999371879f,  73.9489571218f,  333.0125206881f },
    { 65.9130215671f,  74.4866851058f,  333.4722145327f },
    { 66.2242641613f,  75.0227501050f,  333.9213681340f },
    { 66.5336960624f,  75.5570787754f,  334.3603435035f },
    { 66.8413474871f,  76.0896046802f,  334.7894873555f },
    { 67.1472478108f,  76.6202677743f,  335.2091318133f },
    { 67.4514256004f,  77.1490139262f,  335.6195950846f },
    { 67.7539086457f,  77.6757944764f,  336.0211821076f },
    { 67.5282729789f,  77.6851881583f,  336.4197140081f },
    { 67.3016496454f,  77.6978944429f,  336.8230287193f },
    { 67.0740245873f,  77.7139981753f,  337.2312239304f },
    { 66.8453833608f,  77.7335865208f,  337.6444013915f },
    { 66.6157111194f,  77.7567490400f,  338.0626672051f },
    { 66.3849925956f,  77.7835777696f,  338.4861321443f },
    { 66.1532120815f,  77.8141673057f,  338.9149120025f },
    { 65.9203534081f,  77.8486148915f,  339.3491279753f },
    { 65.6863999231f,  77.8870205102f,  339.7889070802f },
    { 65.4513344672f,  77.9294869822f,  340.2343826183f },
    { 65.2151393489f,  77.9761200677f,  340.6856946820f },
    { 64.9777963170f,  78.0270285754f,  341.1429907152f },
    { 64.7392865310f,  78.0823244781f,  341.6064261315f },
    { 64.4995905302f,  78.1421230347f,  342.0761649986f },
    { 64.2586881987f,  78.2065429212f,  342.5523807961f },
    { 64.0165587290f,  78.2757063696f,  343.0352572571f },
    { 63.7731805816f,  78.3497393186f,  343.5249893044f },
    { 63.5285314415f,  78.4287715738f,  344.0217840932f },
    { 63.2825881711f,  78.5129369820f,  344.5258621765f },
    { 63.0353267581f,  78.6023736206f,  345.0374588086f },
    { 62.7867222588f,  78.6972240028f,  345.5568254082f },
    { 62.5367487362f,  78.7976353037f,  346.0842312029f },
    { 62.2853791915f,  78.9037596079f,  346.6199650841f },
    { 62.0325854884f,  79.0157541850f,  347.1643377030f },
    { 61.7783382699f,  79.1337817952f,  347.7176838478f },
    { 61.5226068650f,  79.2580110323f,  348.2803651458f },
    { 61.2653591851f,  79.3886167103f,  348.8527731463f },
    { 61.0065616087f,  79.5257803030f,  349.4353328488f },
    { 60.7461788502f,  79.6696904456f,  350.0285067560f },
    { 60.4841738138f,  79.8205435143f,  350.6327995461f },
    { 60.2205074262f,  79.9785442984f,  351.2487634832f },
    { 59.9551384470f,  80.1439067873f,  351.8770047058f },
    { 59.6880232513f,  80.3168550999f,  352.5181905743f },
    { 59.4191155791f,  80.4976245906f,  353.1730582933f },
    { 59.1483662459f,  80.6864631788f,  353.8424250878f },
    { 58.8757228037f,  80.8836329584f,  354.5272002782f },
    { 58.6011291452f,  81.0894121682f,  355.2283996999f },
    { 58.3245250338f,  81.3040976247f,  355.9471630330f },
    { 58.0458455447f,  81.5280077568f,  356.6847747837f },
    { 57.7650203927f,  81.7614864300f,  357.4426898816f },
    { 57.4819731158f,  82.0049078189f,  358.2225651787f },
    { 57.1966200756f,  82.2586826856f,  359.0262985700f },
    { 56.9088692165f,  82.5232665673f,  359.8560780839f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    166.785f,
    168.475f,
    170.129f,
    171.753f,
    173.340f,
    174.878f,
    176.367f,
    177.802f,
    179.181f,
    180.505f,
    181.763f,
    182.965f,
    184.106f,
    185.187f,
    186.212f,
    187.177f,
    188.086f,
    188.947f,
    189.758f,
    190.527f,
    191.254f,
    191.949f,
    192.615f,
    193.250f,
    193.872f,
    194.360f,
    187.091f,
    180.402f,
    174.237f,
    168.524f,
    163.226f,
    158.301f,
    153.711f,
    149.426f,
    145.416f,
    141.663f,
    138.135f,
    134.821f,
    131.702f,
    128.766f,
    125.995f,
    123.376f,
    120.898f,
    118.555f,
    116.339f,
    114.233f,
    112.244f,
    110.345f,
    108.551f,
    106.842f,
    105.219f,
    103.680f,
    102.209f,
    100.818f,
    99.487f,
    98.224f,
    97.021f,
    95.874f,
    94.781f,
    93.744f,
    92.761f,
    91.821f,
    90.930f,
    90.082f,
    89.276f,
    88.513f,
    87.787f,
    87.103f,
    86.450f,
    85.840f,
    85.260f,
    84.711f,
    84.198f,
    83.716f,
    83.264f,
    82.843f,
    82.452f,
    82.086f,
    81.750f,
    81.445f,
    81.165f,
    80.908f,
    80.682f,
    80.481f,
    80.304f,
    80.151f,
    80.023f,
    79.919f,
    79.840f,
    79.791f,
    79.761f,
    79.755f,
    79.773f,
    79.816f,
    79.889f,
    79.980f,
    80.096f,
    80.243f,
    80.408f,
    80.603f,
    80.817f,
    81.061f,
    81.335f,
    81.635f,
    81.958f,
    82.312f,
    82.690f,
    83.099f,
    83.539f,
    84.009f,
    84.509f,
    85.046f,
    85.614f,
    86.212f,
    86.847f,
    87.518f,
    88.226f,
    88.977f,
    89.764f,
    90.601f,
    91.473f,
    92.395f,
    93.359f,
    94.379f,
    95.447f,
    96.570f,
    97.748f,
    98.993f,
    100.293f,
    101.660f,
    103.101f,
    104.614f,
    106.201f,
    107.880f,
    109.637f,
    111.493f,
    113.446f,
    115.503f,
    117.670f,
    119.965f,
    122.382f,
    124.939f,
    127.649f,
    130.518f,
    133.563f,
    136.792f,
    140.222f,
    143.878f,
    141.687f,
    138.110f,
    134.729f,
    131.525f,
    128.491f,
    125.616f,
    122.888f,
    120.300f,
    117.841f,
    115.497f,
    113.269f,
    111.151f,
    109.131f,
    107.202f,
    105.371f,
    103.619f,
    101.947f,
    100.354f,
    98.828f,
    97.375f,
    95.984f,
    94.659f,
    93.390f,
    92.175f,
    91.016f,
    89.911f,
    88.849f,
    87.836f,
    86.871f,
    85.950f,
    85.065f,
    84.222f,
    83.417f,
    82.654f,
    81.921f,
    81.226f,
    80.560f,
    79.926f,
    79.327f,
    78.754f,
    78.217f,
    77.698f,
    77.216f,
    76.758f,
    76.324f,
    75.916f,
    75.537f,
    75.177f,
    74.847f,
    74.536f,
    74.249f,
    73.987f,
    73.743f,
    73.523f,
    73.328f,
    73.151f,
    72.992f,
    72.858f,
    72.742f,
    72.650f,
    72.577f,
    72.522f,
    72.491f,
    72.479f,
    72.485f,
    72.516f,
    72.565f,
    72.632f,
    72.717f,
    72.827f,
    72.961f,
    73.108f,
    73.279f,
    73.474f,
    73.688f,
    73.926f,
    74.182f,
    74.463f,
    74.768f,
    75.092f,
    75.446f,
    75.818f,
    76.215f,
    76.642f,
    77.094f,
    77.570f,
    78.070f,
    78.601f,
    79.163f,
    79.749f,
    80.371f,
    81.024f,
    81.708f,
    82.422f,
    83.173f,
    83.960f,
    84.784f,
    85.645f,
    86.548f,
    87.488f,
    88.477f,
    89.508f,
    90.588f,
    91.711f,
    92.889f,
    94.122f,
    95.404f,
    96.747f,
    98.157f,
    99.622f,
    101.154f,
    102.759f,
    104.437f,
    106.195f,
    108.032f,
    109.949f,
    111.963f,
    114.069f,
    116.272f,
    118.585f,
    121.002f,
    120.929f,
    119.934f,
    118.988f,
    118.085f,
    117.230f,
    116.418f,
    115.643f,
    114.911f,
    114.221f,
    113.568f,
    112.952f,
    112.372f,
    111.823f,
    111.316f,
    110.840f,
    110.394f,
    109.985f,
    109.607f,
    109.265f,
    108.948f,
    108.661f,
    108.411f,
    108.185f,
    107.990f,
    107.825f,
    107.684f,
    107.581f,
    107.501f,
    107.446f,
    107.422f,
    107.428f,
    107.458f,
    107.520f,
    107.611f,
    107.727f,
    107.874f,
    108.044f,
    108.246f,
    108.472f,
    108.728f,
    109.015f,
    109.332f,
    109.674f,
    110.046f,
    110.449f,
    110.883f,
    111.346f,
    111.841f,
    112.366f,
    112.921f,
    113.507f,
    114.124f,
    114.777f,
    115.460f,
    116.180f,
    116.931f,
    117.719f,
    118.536f,
    119.397f,
    120.288f,
    121.216f,
    122.186f,
    123.187f,
    124.225f,
    125.305f,
    126.422f,
    127.582f,
    128.772f,
    130.005f,
    131.281f,
    132.593f,
    133.942f,
    135.327f,
    136.755f,
    138.220f,
    139.722f,
    141.254f,
    142.822f,
    144.421f,
    146.057f,
    147.711f,
    149.396f,
    151.099f,
    152.826f,
    154.565f,
    156.317f,
    158.075f,
    159.833f,
    161.584f,
    163.336f,
    165.070f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 61.3051297231f,  110.2006267945f,  0.5891365528f },
    { 61.0695374074f,  110.5603548638f,  1.2503259821f },
    { 60.8319417166f,  110.9274758064f,  1.9339628932f },
    { 60.5922374527f,  111.3021256931f,  2.6424973537f },
    { 60.3503045400f,  111.6844602651f,  3.3788235665f },
    { 60.1060044124f,  112.0746643304f,  4.1463953456f },
    { 59.8591751483f,  112.4729659456f,  4.9493824361f },
    { 59.6096247726f,  112.8796581467f,  5.7928866534f },
    { 59.3571218045f,  113.2951328895f,  6.6832481317f },
    { 59.1013815221f,  113.7199353460f,  7.6284918358f },
    { 58.8420453075f,  114.1548534005f,  8.6390010196f },
    { 58.5786482716f,  114.6010707961f,  9.7285753334f },
    { 58.3105658683f,  115.0604419306f,  10.9161789592f },
    { 58.0369200525f,  115.5360161028f,  12.2290179906f },
    { 57.7563999708f,  116.0331226339f,  13.7084261956f },
    { 57.4668779178f,  116.5618865827f,  15.4224770652f },
    { 57.1644363719f,  117.1441348475f,  17.4979337245f },
    { 56.8401051368f,  117.8386179305f,  20.2273113248f },
    { 56.4589933392f,  118.9205378224f,  24.7521440678f },
    { 57.3429126212f,  114.5499828111f,  26.0899588644f },
    { 58.2021027967f,  110.5110987097f,  27.4538913190f },
    { 59.0389317527f,  106.7699135198f,  28.8445225162f },
    { 59.8553887545f,  103.2982110117f,  30.2621704450f },
    { 60.6531652136f,  100.0722826427f,  31.7069019463f },
    { 61.4337145392f,  97.0719995751f,  33.1785398326f },
    { 62.1982973298f,  94.2801094358f,  34.6766670178f },
    { 62.9480160653f,  91.6816942904f,  36.2006291018f },
    { 63.6838421341f,  89.2637465079f,  37.7495365791f },
    { 64.4066371691f,  87.0148323644f,  39.3222676296f },
    { 65.1171700914f,  84.9248220194f,  40.9174722849f },
    { 65.8161308735f,  82.9846704839f,  42.5335786170f },
    { 66.5041417630f,  81.1862383516f,  44.1688014598f },
    { 67.1817665165f,  79.5221439886f,  45.8211540328f },
    { 67.8495180614f,  77.9856409729f,  47.4884626922f },
    { 68.5078648999f,  76.5705160799f,  49.1683848824f },
    { 69.1572364998f,  75.2710042152f,  50.8584302089f },
    { 69.7980278628f,  74.0817174992f,  52.5559843973f },
    { 70.4306034179f,  72.9975863029f,  54.2583357580f },
    { 71.0553003599f,  72.0138104670f,  55.9627036496f },
    { 71.6724315255f,  71.1258192573f,  57.6662683211f },
    { 72.2822878850f,  70.3292388460f,  59.3662014407f },
    { 72.8851407095f,  69.6198662770f,  61.0596965712f },
    { 73.4812434654f,  68.9936490066f,  62.7439988492f },
    { 74.0708334764f,  68.4466692063f,  64.4164331516f },
    { 74.6541333872f,  67.9751320919f,  66.0744301016f },
    { 75.2313524581f,  67.5753576110f,  67.7155493575f },
    { 75.8026877130f,  67.2437748760f,  69.3374997432f },
    { 76.3683249614f,  66.9769187891f,  70.9381559113f },
    { 76.9284397110f,  66.7714283565f,  72.5155713628f },
    { 77.4831979848f,  66.6240462489f,  74.0679877798f },
    { 78.0327570545f,  66.5316192156f,  75.5938407510f },
    { 78.5772661015f,  66.4910990209f,  77.0917620753f },
    { 79.1168668135f,  66.4995436207f,  78.5605789162f },
    { 79.6516939234f,  66.5541183527f,  79.9993101455f },
    { 80.1818756999f,  66.6520969641f,  81.4071602570f },
    { 80.7075343916f,  66.7908623406f,  82.7835112556f },
    { 81.2287866330f,  66.9679068488f,  84.1279129289f },
    { 81.7457438143f,  67.1808322312f,  85.4400718978f },
    { 82.2585124199f,  67.4273490297f,  86.7198398184f },
    { 82.7671943391f,  67.7052755320f,  87.9672010724f },
    { 83.2718871499f,  68.0125362595f,  89.1822602469f },
    { 83.7726843821f,  68.3471600254f,  90.3652296579f },
    { 84.2696757573f,  68.7072776058f,  91.5164171335f },
    { 84.7629474127f,  69.0911190692f,  92.6362142261f },
    { 85.2525821059f,  69.4970108163f,  93.7250849875f },
    { 85.7386594056f,  69.9233723829f,  94.7835554038f },
    { 86.2212558681f,  70.3687130541f,  95.8122035533f },
    { 86.7004452010f,  70.8316283417f,  96.8116505290f },
    { 87.1762984152f,  71.3107963668f,  97.7825521372f },
    { 87.6488839666f,  71.8049741913f,  98.7255913730f },
    { 88.1182678880f,  72.3129941325f,  99.6414716520f },
    { 88.5845139124f,  72.8337600948f,  100.5309107713f },
    { 89.0476835874f,  73.3662439452f,  101.3946355617f },
    { 89.5078363832f,  73.9094819546f,  102.2333771893f },
    { 89.9650297927f,  74.4625713266f,  103.0478670598f },
    { 90.4193194261f,  75.0246668267f,  103.8388332777f },
    { 90.8707590989f,  75.5949775245f,  104.6069976144f },
    { 91.3194009153f,  76.1727636583f,  105.3530729341f },
    { 91.7652953458f,  76.7573336282f,  106.0777610366f },
    { 91.5010168191f,  76.8348502913f,  106.7926551121f },
    { 91.2356823168f,  76.9253729171f,  107.5106753151f },
    { 90.9692792066f,  77.0291128087f,  108.2316218154f },
    { 90.7017945984f,  77.1462799260f,  108.9552896607f },
    { 90.4332153370f,  77.2770827433f,  109.6814690949f },
    { 90.1635279944f,  77.4217281151f,  110.4099458977f },
    { 89.8927188619f,  77.5804211510f,  111.1405017446f },
    { 89.6207739414f,  77.7533650996f,  111.8729145859f },
    { 89.3476789374f,  77.9407612440f,  112.6069590432f },
    { 89.0734192472f,  78.1428088080f,  113.3424068216f },
    { 88.7979799525f,  78.3597048753f,  114.0790271360f },
    { 88.5213458088f,  78.5916443222f,  114.8165871498f },
    { 88.2435012361f,  78.8388197634f,  115.5548524234f },
    { 87.9644303079f,  79.1014215136f,  116.2935873707f },
    { 87.6841167405f,  79.3796375643f,  117.0325557221f },
    { 87.4025438817f,  79.6736535757f,  117.7715209898f },
    { 87.1196946987f,  79.9836528870f,  118.5102469364f },
    { 86.8355517662f,  80.3098165419f,  119.2484980406f },
    { 86.5500972534f,  80.6523233330f,  119.9860399610f },
    { 86.2633129105f,  81.0113498633f,  120.7226399943f },
    { 85.9751800549f,  81.3870706263f,  121.4580675258f },
    { 85.6856795566f,  81.7796581037f,  122.1920944698f },
    { 85.3947918232f,  82.1892828827f,  122.9244956992f },
    { 85.1024967838f,  82.6161137912f,  123.6550494609f },
    { 84.8087738726f,  83.0603180512f,  124.3835377755f },
    { 84.5136020115f,  83.5220614521f,  125.1097468207f },
    { 84.2169595924f,  84.0015085413f,  125.8334672955f },
    { 83.9188244578f,  84.4988228340f,  126.5544947645f },
    { 83.6191738813f,  85.0141670408f,  127.2726299812f },
    { 83.3179845469f,  85.5477033137f,  127.9876791893f },
    { 83.0152325273f,  86.0995935101f,  128.6994544001f },
    { 82.7108932612f,  86.6699994741f,  129.4077736475f },
    { 82.4049415297f,  87.2590833359f,  130.1124612176f },
    { 82.0973514309f,  87.8670078279f,  130.8133478547f },
    { 81.7880963541f,  88.4939366185f,  131.5102709418f },
    { 81.4771489522f,  89.1400346624f,  132.2030746573f },
    { 81.1644811129f,  89.8054685678f,  132.8916101064f },
    { 80.8500639283f,  90.4904069805f,  133.5757354291f },
    { 80.5338676630f,  91.1950209847f,  134.2553158840f },
    { 80.2158617205f,  91.9194845199f,  134.9302239095f },
    { 79.8960146081f,  92.6639748159f,  135.6003391619f },
    { 79.5742938995f,  93.4286728430f,  136.2655485327f },
    { 79.2506661956f,  94.2137637810f,  136.9257461448f },
    { 78.9250970834f,  95.0194375048f,  137.5808333295f },
    { 78.5975510920f,  95.8458890885f,  138.2307185843f },
    { 78.2679916470f,  96.6933193279f,  138.8753175142f },
    { 77.9363810212f,  97.5619352829f,  139.5145527555f },
    { 77.6026802841f,  98.4519508388f,  140.1483538858f },
    { 77.2668492463f,  99.3635872909f,  140.7766573191f },
    { 76.9288464031f,  100.2970739494f,  141.3994061892f },
    { 76.5886288724f,  101.2526487697f,  142.0165502211f },
    { 76.2461523305f,  102.2305590072f,  142.6280455928f },
    { 75.9013709435f,  103.2310618994f,  143.2338547875f },
    { 75.5542372940f,  104.2544253775f,  143.8339464391f },
    { 75.2047023038f,  105.3009288086f,  144.4282951704f },
    { 74.8527151513f,  106.3708637728f,  145.0168814263f },
    { 74.4982231839f,  107.4645348759f,  145.5996913028f },
    { 74.1411718243f,  108.5822606030f,  146.1767163727f },
    { 73.7815044709f,  109.7243742145f,  146.7479535094f },
    { 73.4191623911f,  110.8912246894f,  147.3134047090f },
    { 73.6492982806f,  106.9690129397f,  148.8051356817f },
    { 73.8665446102f,  103.7865043776f,  150.1229328195f },
    { 74.0753233362f,  101.0835091053f,  151.3285579587f },
    { 74.2779661594f,  98.7229096611f,  152.4546308928f },
    { 74.4758767148f,  96.6222132046f,  153.5207802297f },
    { 74.6699758151f,  94.7273385655f,  154.5398552022f },
    { 74.8609053511f,  93.0006149945f,  155.5207792011f },
    { 75.0491335382f,  91.4145886774f,  156.4700264025f },
    { 75.2350141572f,  89.9485369836f,  157.3924547106f },
    { 75.4188221734f,  88.5863727844f,  158.2918074990f },
    { 75.6007762973f,  87.3153171357f,  159.1710319230f },
    { 75.7810538902f,  86.1250223576f,  160.0324895329f },
    { 75.9598011620f,  85.0069720667f,  160.8781005643f },
    { 76.1371403571f,  83.9540584274f,  161.7094457374f },
    { 76.3131749461f,  82.9602766898f,  162.5278399034f },
    { 76.4879934599f,  82.0204996216f,  163.3343864960f },
    { 76.6616723746f,  81.1303077470f,  164.1300185629f },
    { 76.8342783203f,  80.2858594290f,  164.9155302098f },
    { 77.0058697953f,  79.4837899588f,  165.6916010596f },
    { 77.1764985169f,  78.7211321267f,  166.4588155350f },
    { 77.3462104962f,  77.9952529531f,  167.2176782455f },
    { 77.5150469046f,  77.3038027442f,  167.9686264015f },
    { 77.6830447773f,  76.6446736690f,  168.7120399300f },
    { 77.8502375920f,  76.0159657747f,  169.4482497928f },
    { 78.0166557464f,  75.4159588777f,  170.1775448860f },
    { 78.1823269565f,  74.8430891363f,  170.9001778056f },
    { 78.3472765918f,  74.2959293926f,  171.6163697004f },
    { 78.5115279575f,  73.7731725690f,  172.3263143848f },
    { 78.6751025345f,  73.2736175618f,  173.0301818445f },
    { 78.8380201855f,  72.7961571899f,  173.7281212419f },
    { 79.0002993306f,  72.3397678469f,  174.4202635073f },
    { 79.1619571003f,  71.9035005713f,  175.1067235819f },
    { 79.3230094674f,  71.4864733074f,  175.7876023702f },
    { 79.4834713622f,  71.0878641689f,  176.4629884443f },
    { 79.6433567729f,  70.7069055522f,  177.1329595393f },
    { 79.8026788347f,  70.3428789729f,  177.7975838686f },
    { 79.9614499072f,  69.9951105208f,  178.4569212846f },
    { 80.1196816435f,  69.6629668463f,  179.1110243070f },
    { 80.2773850514f,  69.3458516036f,  179.7599390343f },
    { 80.4345705479f,  69.0432022914f,  180.4037059550f },
    { 80.5912480075f,  68.7544874367f,  181.0423606705f },
    { 80.7474268058f,  68.4792040788f,  181.6759345401f },
    { 80.9031158589f,  68.2168755151f,  182.3044552579f },
    { 81.0583236580f,  67.9670492775f,  182.9279473691f },
    { 81.2130583013f,  67.7292953098f,  183.5464327315f },
    { 81.3673275225f,  67.5032043240f,  184.1599309305f },
    { 81.5211387172f,  67.2883863146f,  184.7684596498f },
    { 81.6744989657f,  67.0844692114f,  185.3720350043f },
    { 81.8274150552f,  66.8910976573f,  185.9706718381f },
    { 81.9798934989f,  66.7079318966f,  186.5643839916f },
    { 82.1319405539f,  66.5346467611f,  187.1531845399f },
    { 82.2835622375f,  66.3709307455f,  187.7370860064f },
    { 82.4347643426f,  66.2164851609f,  188.3161005524f },
    { 82.5855524509f,  66.0710233600f,  188.8902401468f },
    { 82.7359319457f,  65.9342700249f,  189.4595167154f },
    { 82.8859080238f,  65.8059605139f,  190.0239422743f },
    { 83.0354857061f,  65.6858402592f,  190.5835290459f },
    { 83.1846698472f,  65.5736642115f,  191.1382895620f },
    { 83.3334651453f,  65.4691963273f,  191.6882367527f },
    { 83.4818761500f,  65.3722090950f,  192.2333840237f },
    { 82.9822910757f,  64.8475839948f,  192.7831573497f },
    { 82.4790649309f,  64.3240715907f,  193.3467594859f },
    { 81.9721225394f,  63.8018661630f,  193.9246634508f },
    { 81.4613861245f,  63.2811753025f,  194.5173597122f },
    { 80.9467751815f,  62.7622208081f,  195.1253566163f },
    { 80.4282063424f,  62.2452396442f,  195.7491807835f },
    { 79.9055932317f,  61.7304849628f,  196.3893774620f },
    { 79.3788463126f,  61.2182271929f,  197.0465108287f },
    { 78.8478727233f,  60.7087552013f,  197.7211642260f },
    { 78.3125761022f,  60.2023775285f,  198.4139403212f },
    { 77.7728564009f,  59.6994237046f,  199.1254611735f },
    { 77.2286096839f,  59.2002456474f,  199.8563681919f },
    { 76.6797279152f,  58.7052191477f,  200.6073219653f },
    { 76.1260987283f,  58.2147454457f,  201.3790019434f },
    { 75.5676051806f,  57.7292529003f,  202.1721059457f },
    { 75.0041254881f,  57.2491987569f,  202.9873494718f },
    { 74.4355327419f,  56.7750710149f,  203.8254647863f },
    { 73.8616946014f,  56.3073903980f,  204.6871997470f },
    { 73.2824729644f,  55.8467124287f,  205.5733163428f },
    { 72.6977236107f,  55.3936296092f,  206.4845889080f },
    { 72.1072958171f,  54.9487737082f,  207.4218019730f },
    { 71.5110319404f,  54.5128181530f,  208.3857477161f },
    { 70.9087669657f,  54.0864805270f,  209.3772229740f },
    { 70.3003280162f,  53.6705251675f,  210.3970257725f },
    { 69.6855338198f,  53.2657658619f,  211.4459513387f },
    { 69.0641941289f,  52.8730686367f,  212.5247875577f },
    { 68.4361090875f,  52.4933546325f,  213.6343098421f },
    { 67.8010685397f,  52.1276030580f,  214.7752753865f },
    { 67.1588512730f,  51.7768542150f,  215.9484167914f },
    { 66.5092241887f,  51.4422125845f,  217.1544350475f },
    { 65.8519413906f,  51.1248499668f,  218.3939918908f },
    { 65.1867431819f,  50.8260086659f,  219.6677015550f },
    { 64.5133549590f,  50.5470047132f,  220.9761219696f },
    { 63.8314859883f,  50.2892311285f,  222.3197454813f },
    { 63.1408280518f,  50.0541612204f,  223.6989892053f },
    { 62.4410539419f,  49.8433519367f,  225.1141851506f },
    { 61.7318157866f,  49.6584472883f,  226.5655703008f },
    { 61.0127431795f,  49.5011818819f,  228.0532768771f },
    { 60.2834410861f,  49.3733846187f,  229.5773230530f },
    { 59.5434874952f,  49.2769826406f,  231.1376044395f },
    { 58.7924307717f,  49.2140056382f,  232.7338867015f },
    { 58.0297866687f,  49.1865906738f,  234.3657997119f },
    { 57.2550349389f,  49.1969877255f,  236.0328336870f },
    { 56.4676154803f,  49.2475662161f,  237.7343377769f },
    { 55.6669239351f,  49.3408228696f,  239.4695216092f },
    { 54.8523066426f,  49.4793913306f,  241.2374602960f },
    { 54.0230548278f,  49.6660540919f,  243.0371034155f },
    { 53.1783978786f,  49.9037574245f,  244.8672884770f },
    { 52.3174955295f,  50.1956301717f,  246.7267593660f },
    { 51.4394287274f,  50.5450074995f,  248.6141902586f },
    { 50.5431888964f,  50.9554609774f,  250.5282155003f },
    { 49.6276652439f,  51.4308367419f,  252.4674659766f },
    { 48.6916296518f,  51.9753039903f,  254.4306125824f },
    { 47.7337185666f,  52.5934167340f,  256.4164175602f },
    { 46.7524111222f,  53.2901926735f,  258.4237947467f },
    { 45.7460024897f,  54.0712143767f,  260.4518802234f },
    { 44.7125711130f,  54.9427598330f,  262.5001155644f },
    { 43.6499380148f,  55.9119722181f,  264.5683469555f },
    { 42.5556156859f,  56.9870828230f,  266.6569450960f },
    { 41.4267430833f,  58.1777073644f,  268.7669533000f },
    { 42.1351474425f,  57.5333296293f,  271.8160929137f },
    { 42.8265805442f,  57.0610028244f,  274.8048328867f },
    { 43.5022249197f,  56.7460531252f,  277.7233064185f },
    { 44.1631305750f,  56.5746168965f,  280.5630709240f },
    { 44.8102349048f,  56.5336164890f,  283.3172222973f },
    { 45.4443789216f,  56.6107544658f,  285.9804255798f },
    { 46.0663206004f,  56.7945151609f,  288.5488739651f },
    { 46.6767459399f,  57.0741659459f,  291.0201915351f },
    { 47.2762782008f,  57.4397534939f,  293.3932962596f },
    { 47.8654856741f,  57.8820926460f,  295.6682390249f },
    { 48.4448882554f,  58.3927471980f,  297.8460323914f },
    { 49.0149630424f,  58.9640030862f,  299.9284800286f },
    { 49.5761491263f,  59.5888351512f,  301.9180148569f },
    { 50.1288517153f,  60.2608689885f,  303.8175511962f },
    { 50.6734457000f,  60.9743394746f,  305.6303539087f },
    { 51.2102787501f,  61.7240474564f,  307.3599256974f },
    { 51.7396740160f,  62.5053159027f,  309.0099123982f },
    { 52.2619324947f,  63.3139465800f,  310.5840252105f },
    { 52.7773351102f,  64.1461780722f,  312.0859782828f },
    { 53.2861445488f,  64.9986457411f,  313.5194398097f },
    { 53.7886068837f,  65.8683440260f,  314.8879947317f },
    { 54.2849530180f,  66.7525913204f,  316.1951171965f },
    { 54.7753999707f,  67.6489975336f,  317.4441510819f },
    { 55.2601520249f,  68.5554343464f,  318.6382970657f },
    { 55.7394017570f,  69.4700080988f,  319.7806049265f },
    { 56.2133309609f,  70.3910351971f,  320.8739699536f },
    { 56.6821114803f,  71.3170198959f,  321.9211325307f },
    { 57.1459059603f,  72.2466342915f,  322.9246801177f },
    { 57.6048685271f,  73.1787003532f,  323.8870510048f },
    { 58.0591454040f,  74.1121738213f,  324.8105393314f },
    { 58.5088754721f,  75.0461298010f,  325.6973009688f },
    { 58.9541907794f,  75.9797498901f,  326.5493599524f },
    { 59.3952170064f,  76.9123106904f,  327.3686152180f },
    { 59.8320738913f,  77.8431735594f,  328.1568474558f },
    { 60.2648756185f,  78.7717754751f,  328.9157259426f },
    { 60.6937311760f,  79.6976208936f,  329.6468152468f },
    { 61.1187446831f,  80.6202744933f,  330.3515817343f },
    { 61.5400156919f,  81.5393547106f,  331.0313998221f },
    { 61.9576394653f,  82.4545279767f,  331.6875579469f },
    { 62.3717072334f,  83.3655035829f,  332.3212642293f },
    { 62.7823064308f,  84.2720291001f,  332.9336518230f },
    { 63.1895209152f,  85.1738862945f,  333.5257839489f },
    { 63.5934311716f,  86.0708874828f,  334.0986586172f },
    { 63.9941144999f,  86.9628722782f,  334.6532130457f },
    { 64.3916451908f,  87.8497046843f,  335.1903277865f },
    { 64.7860946884f,  88.7312704987f,  335.7108305730f },
    { 65.1775317418f,  89.6074749906f,  336.2154999025f },
    { 65.5660225467f,  90.4782408247f,  336.7050683676f },
    { 65.9516308775f,  91.3435062018f,  337.1802257536f },
    { 66.3344182100f,  92.2032231951f,  337.6416219147f },
    { 66.7144438374f,  93.0573562586f,  338.0898694452f },
    { 67.0917649778f,  93.9058808905f,  338.5255461581f },
    { 67.4664368757f,  94.7487824349f,  338.9491973860f },
    { 67.8385128962f,  95.5860550055f,  339.3613381157f },
    { 68.2080446148f,  96.4177005210f,  339.7624549697f },
    { 68.5750819006f,  97.2437278374f,  340.1530080449f },
    { 68.9396729951f,  98.0641519696f,  340.5334326191f },
    { 69.3018645863f,  98.8789933911f,  340.9041407363f },
    { 69.6617018782f,  99.6882774047f,  341.2655226782f },
    { 70.0192286571f,  100.4920335767f,  341.6179483316f },
    { 69.8312801136f,  100.6247090998f,  341.9666611748f },
    { 69.6425864532f,  100.7612069253f,  342.3184761683f },
    { 69.4531370769f,  100.9015902418f,  342.6734610852f },
    { 69.2629210801f,  101.0459232847f,  343.0316871928f },
    { 69.0719272373f,  101.1942713482f,  343.3932295084f },
    { 68.8801439872f,  101.3467007960f,  343.7581670779f },
    { 68.6875594159f,  101.5032790721f,  344.1265832788f },
    { 68.4941612392f,  101.6640747098f,  344.4985661526f },
    { 68.2999367834f,  101.8291573408f,  344.8742087668f },
    { 68.1048729649f,  101.9985977016f,  345.2536096124f },
    { 67.9089562681f,  102.1724676402f,  345.6368730393f },
    { 67.7121727216f,  102.3508401203f,  346.0241097349f },
    { 67.5145078724f,  102.5337892238f,  346.4154372511f },
    { 67.3159467580f,  102.7213901521f,  346.8109805853f },
    { 67.1164738759f,  102.9137192248f,  347.2108728215f },
    { 66.9160731513f,  103.1108538761f,  347.6152558410f },
    { 66.7147279004f,  103.3128726487f,  348.0242811096f },
    { 66.5124207920f,  103.5198551849f,  348.4381105533f },
    { 66.3091338041f,  103.7318822150f,  348.8569175331f },
    { 66.1048481769f,  103.9490355414f,  349.2808879337f },
    { 65.8995443611f,  104.1713980203f,  349.7102213821f },
    { 65.6932019606f,  104.3990535390f,  350.1451326142f },
    { 65.4857996691f,  104.6320869889f,  350.5858530140f },
    { 65.2773152001f,  104.8705842352f,  351.0326323485f },
    { 65.0677252082f,  105.1146320823f,  351.4857407326f },
    { 64.8570052017f,  105.3643182347f,  351.9454708588f },
    { 64.6451294447f,  105.6197312548f,  352.4121405382f },
    { 64.4320708459f,  105.8809605182f,  352.8860956037f },
    { 64.2178008339f,  106.1480961659f,  353.3677132425f },
    { 64.0022892150f,  106.4212290581f,  353.8574058340f },
    { 63.7855040112f,  106.7004507292f,  354.3556253903f },
    { 63.5674112743f,  106.9858533497f,  354.8628687148f },
    { 63.3479748717f,  107.2775296999f,  355.3796834269f },
    { 63.1271562378f,  107.5755731631f,  355.9066750306f },
    { 62.9049140853f,  107.8800777494f,  356.4445152562f },
    { 62.6812040650f,  108.1911381656f,  356.9939519608f },
    { 62.4559783649f,  108.5088499545f,  357.5558209546f },
    { 62.2291852325f,  108.8333097331f,  358.1310602226f },
    { 62.0007684030f,  109.1646155765f,  358.7207271565f },
    { 61.7706664055f,  109.5028676097f,  359.3260195995f },
    { 61.5388117179f,  109.8481689018f,  359.9483017771f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.894421386718750f,
    0.893383789062500f,
    0.892370605468750f,
    0.891369628906250f,
    0.890386962890625f,
    0.889428710937500f,
    0.888488769531250f,
    0.887573242187500f,
    0.886682128906250f,
    0.885809326171875f,
    0.884960937500000f,
    0.884136962890625f,
    0.883349609375000f,
    0.882574462890625f,
    0.881829833984375f,
    0.881115722656250f,
    0.880419921875000f,
    0.879760742187500f,
    0.879119873046875f,
    0.878497314453125f,
    0.877929687500000f,
    0.877337646484375f,
    0.876794433593750f,
    0.876300048828125f,
    0.875769042968750f,
    0.875250244140625f,
    0.874786376953125f,
    0.874377441406250f,
    0.874023437500000f,
    0.875799560546875f,
    0.878259277343750f,
    0.880517578125000f,
    0.882666015625000f,
    0.884777832031250f,
    0.886676025390625f,
    0.888562011718750f,
    0.890344238281250f,
    0.892047119140625f,
    0.893731689453125f,
    0.895269775390625f,
    0.896820068359375f,
    0.898266601562500f,
    0.899694824218750f,
    0.901074218750000f,
    0.902392578125000f,
    0.903710937500000f,
    0.904937744140625f,
    0.906182861328125f,
    0.907342529296875f,
    0.908508300781250f,
    0.909625244140625f,
    0.910723876953125f,
    0.911804199218750f,
    0.912841796875000f,
    0.913885498046875f,
    0.914868164062500f,
    0.915875244140625f,
    0.916815185546875f,
    0.917773437500000f,
    0.918695068359375f,
    0.919604492187500f,
    0.920507812500000f,
    0.921374511718750f,
    0.922271728515625f,
    0.923095703125000f,
    0.923944091796875f,
    0.924768066406250f,
    0.925579833984375f,
    0.926403808593750f,
    0.927172851562500f,
    0.927966308593750f,
    0.928729248046875f,
    0.929479980468750f,
    0.930255126953125f,
    0.930975341796875f,
    0.931701660156250f,
    0.932440185546875f,
    0.933129882812500f,
    0.933825683593750f,
    0.934533691406250f,
    0.935198974609375f,
    0.935852050781250f,
    0.936517333984375f,
    0.937176513671875f,
    0.937780761718750f,
    0.938385009765625f,
    0.938983154296875f,
    0.939569091796875f,
    0.940142822265625f,
    0.940673828125000f,
    0.941180419921875f,
    0.941662597656250f,
    0.942114257812500f,
    0.942535400390625f,
    0.942919921875000f,
    0.943249511718750f,
    0.943536376953125f,
    0.943756103515625f,
    0.943908691406250f,
    0.943945312500000f,
    0.943878173828125f,
    0.943701171875000f,
    0.943383789062500f,
    0.942822265625000f,
    0.935583496093750f,
    0.917004394531250f,
    0.897985839843750f,
    0.878265380859375f,
    0.876696777343750f,
    0.879449462890625f,
    0.882037353515625f,
    0.884484863281250f,
    0.886798095703125f,
    0.888989257812500f,
    0.891064453125000f,
    0.893035888671875f,
    0.894915771484375f,
    0.896691894531250f,
    0.898388671875000f,
    0.900006103515625f,
    0.901544189453125f,
    0.903015136718750f,
    0.904418945312500f,
    0.905755615234375f,
    0.907031250000000f,
    0.908258056640625f,
    0.909417724609375f,
    0.910534667968750f,
    0.911596679687500f,
    0.912609863281250f,
    0.913580322265625f,
    0.914508056640625f,
    0.915386962890625f,
    0.916223144531250f,
    0.917022705078125f,
    0.917779541015625f,
    0.918493652343750f,
    0.919171142578125f,
    0.919805908203125f,
    0.920404052734375f,
    0.920965576171875f,
    0.921490478515625f,
    0.921984863281250f,
    0.925201416015625f,
    0.928234863281250f,
    0.931097412109375f,
    0.933789062500000f,
    0.936328125000000f,
    0.938726806640625f,
    0.940991210937500f,
    0.943121337890625f,
    0.945135498046875f,
    0.947039794921875f,
    0.948846435546875f,
    0.950561523437500f,
    0.952191162109375f,
    0.953741455078125f,
    0.955212402343750f,
    0.956610107421875f,
    0.957928466796875f,
    0.959185791015625f,
    0.960382080078125f,
    0.961517333984375f,
    0.962603759765625f,
    0.963635253906250f,
    0.964617919921875f,
    0.965539550781250f,
    0.966418457031250f,
    0.967254638671875f,
    0.968048095703125f,
    0.968798828125000f,
    0.969512939453125f,
    0.970190429687500f,
    0.970819091796875f,
    0.971411132812500f,
    0.971966552734375f,
    0.972491455078125f,
    0.972979736328125f,
    0.973437500000000f,
    0.973858642578125f,
    0.974237060546875f,
    0.974584960937500f,
    0.974902343750000f,
    0.975189208984375f,
    0.975439453125000f,
    0.975653076171875f,
    0.975830078125000f,
    0.975970458984375f,
    0.976080322265625f,
    0.976159667968750f,
    0.976190185546875f,
    0.976184082031250f,
    0.976135253906250f,
    0.976055908203125f,
    0.975927734375000f,
    0.981390380859375f,
    0.991229248046875f,
    0.991076660156250f,
    0.990899658203125f,
    0.990722656250000f,
    0.990545654296875f,
    0.990380859375000f,
    0.990209960937500f,
    0.990045166015625f,
    0.989886474609375f,
    0.989721679687500f,
    0.989562988281250f,
    0.989404296875000f,
    0.989251708984375f,
    0.989099121093750f,
    0.988952636718750f,
    0.988793945312500f,
    0.988635253906250f,
    0.988476562500000f,
    0.988330078125000f,
    0.988189697265625f,
    0.988043212890625f,
    0.987884521484375f,
    0.987731933593750f,
    0.987591552734375f,
    0.987451171875000f,
    0.987292480468750f,
    0.987145996093750f,
    0.987011718750000f,
    0.986859130859375f,
    0.986706542968750f,
    0.986566162109375f,
    0.986425781250000f,
    0.986267089843750f,
    0.986126708984375f,
    0.985986328125000f,
    0.985827636718750f,
    0.985687255859375f,
    0.985540771484375f,
    0.985382080078125f,
    0.985247802734375f,
    0.985083007812500f,
    0.984936523437500f,
    0.984796142578125f,
    0.984625244140625f,
    0.984478759765625f,
    0.984320068359375f,
    0.984155273437500f,
    0.984014892578125f,
    0.983837890625000f,
    0.983679199218750f,
    0.983520507812500f,
    0.983343505859375f,
    0.983184814453125f,
    0.983007812500000f,
    0.982830810546875f,
    0.982666015625000f,
    0.982476806640625f,
    0.982299804687500f,
    0.982116699218750f,
    0.981921386718750f,
    0.981744384765625f,
    0.981536865234375f,
    0.981341552734375f,
    0.981146240234375f,
    0.980926513671875f,
    0.980725097656250f,
    0.980505371093750f,
    0.980279541015625f,
    0.980065917968750f,
    0.979821777343750f,
    0.979583740234375f,
    0.979351806640625f,
    0.979083251953125f,
    0.978833007812500f,
    0.978576660156250f,
    0.978289794921875f,
    0.978021240234375f,
    0.977734375000000f,
    0.977429199218750f,
    0.977130126953125f,
    0.976818847656250f,
    0.976757812500000f,
    0.976824951171875f,
    0.976861572265625f,
    0.976922607421875f,
    0.976959228515625f,
    0.977026367187500f,
    0.977050781250000f,
    0.977124023437500f,
    0.977148437500000f,
    0.977221679687500f,
    0.977246093750000f,
    0.977307128906250f,
    0.977349853515625f,
    0.977398681640625f,
    0.977459716796875f,
    0.977490234375000f,
    0.977557373046875f,
    0.977593994140625f,
    0.977642822265625f,
    0.977709960937500f,
    0.977740478515625f,
    0.977795410156250f,
    0.977856445312500f,
    0.977893066406250f,
    0.977941894531250f,
    0.978009033203125f,
    0.978051757812500f,
    0.978100585937500f,
    0.978155517578125f,
    0.978216552734375f,
    0.978277587890625f,
    0.978320312500000f,
    0.978375244140625f,
    0.978430175781250f,
    0.978491210937500f,
    0.978552246093750f,
    0.978613281250000f,
    0.978674316406250f,
    0.978735351562500f,
    0.978802490234375f,
    0.978863525390625f,
    0.978930664062500f,
    0.978997802734375f,
    0.979077148437500f,
    0.979144287109375f,
    0.979211425781250f,
    0.979284667968750f,
    0.979364013671875f,
    0.979437255859375f,
    0.979516601562500f,
    0.979602050781250f,
    0.979681396484375f,
    0.979772949218750f,
    0.979864501953125f,
    0.979949951171875f,
    0.969635009765625f,
    0.957183837890625f,
    0.944927978515625f,
    0.932836914062500f,
    0.920886230468750f,
    0.919616699218750f,
    0.918560791015625f,
    0.917498779296875f,
    0.916418457031250f,
    0.915338134765625f,
    0.914245605468750f,
    0.913140869140625f,
    0.912036132812500f,
    0.910925292968750f,
    0.909808349609375f,
    0.908685302734375f,
    0.907568359375000f,
    0.906445312500000f,
    0.905328369140625f,
    0.904205322265625f,
    0.903094482421875f,
    0.901977539062500f,
    0.900872802734375f,
    0.899774169921875f,
    0.898681640625000f,
    0.897595214843750f,
    0.896527099609375f,
    0.895465087890625f
};

#include "hellwig_lib_rc1.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1 = clamp3(AP1, 0.0f, 16384.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in = float3spow(in, 2.6f);
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
				float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
				out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-1
            if (hardClip)
            {
				out = clamp3(out, 0.0f, 1.0f);
            }
            
            if (asPQ)
            {
                out *= 48.0f;
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out, 1.0f / 2.6f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}