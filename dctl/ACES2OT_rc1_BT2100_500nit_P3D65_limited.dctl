// DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)

__CONSTANT__ int toneCurve = 1;
__CONSTANT__ int compressChroma = 1;
__CONSTANT__ int gamutCompress = 1;
__CONSTANT__ int d60Sim = 0;
__CONSTANT__ int asPQ = 1;
__CONSTANT__ int ap1Clip = 1;
__CONSTANT__ int softClip = 0;
__CONSTANT__ int hardClip = 1;
__CONSTANT__ int invert = 0;
__CONSTANT__ int JMhOut = 0;

typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// Rec.2020 to XYZ matrix
    { 0.6369580483f,  0.1446169036f,  0.1688809752f },
    { 0.2627002120f,  0.6779980715f,  0.0593017165f },
    { 0.0000000000f,  0.0280726930f,  1.0609850577f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float3x3 P3D65_to_BT2020 =
{
    { 0.7538330344f,  0.1985973691f,  0.0475695966f },
    { 0.0457438490f,  0.9417772198f,  0.0124789312f },
    {-0.0012103404f,  0.0176017173f,  0.9836086231f }
};

__CONSTANT__ float limitJmax = 208.257070f;
__CONSTANT__ float midJ = 38.9322092937f; // ~13 nits in Hellwig J
__CONSTANT__ float focusDist = 3.0013166352f;

__CONSTANT__ float daniele_n = 500.0f; // peak white  
__CONSTANT__ float daniele_m_2 = 5.0892350790f;
__CONSTANT__ float daniele_s_2 = 3.3869123661f;
__CONSTANT__ float daniele_u_2 = 0.9902637512f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 0.6730239061f;
__CONSTANT__ float sat_thr = 0.001f;
__CONSTANT__ float compr = 7.935842f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 119.4955116182f,  157.0427193055f,  0.6996436714f },
    { 118.8878599445f,  157.6146205644f,  1.5900739174f },
    { 118.2743574960f,  158.2101000642f,  2.5163012887f },
    { 117.6546914751f,  158.8306731081f,  3.4826235096f },
    { 117.0285012608f,  159.4781625008f,  4.4942231664f },
    { 116.3953652604f,  160.1548093106f,  5.5574310806f },
    { 115.7547824831f,  160.8634365428f,  6.6800973314f },
    { 115.1061459681f,  161.6076978473f,  7.8721285065f },
    { 114.4487031623f,  162.3924680692f,  9.1462913619f },
    { 113.7814944214f,  163.2244812015f,  10.5194629006f },
    { 113.1032527764f,  164.1134239943f,  12.0146702072f },
    { 112.4122302693f,  165.0739279050f,  13.6646253173f },
    { 111.7058723207f,  166.1294947813f,  15.5183480167f },
    { 110.9801382723f,  167.3211078811f,  17.6549593369f },
    { 110.2278468930f,  168.7292979053f,  20.2171686379f },
    { 109.4335063188f,  170.5469305311f,  23.5154527152f },
    { 108.5461988160f,  173.4863966358f,  28.5706055537f },
    { 110.6285772802f,  166.6291105238f,  30.1505435798f },
    { 112.6492621502f,  160.3930641277f,  31.7642524509f },
    { 114.6141222128f,  154.7093517976f,  33.4095926313f },
    { 116.5280745281f,  149.5210093950f,  35.0844239947f },
    { 118.3952943504f,  144.7803260339f,  36.7865011196f },
    { 120.2193682287f,  140.4468600047f,  38.5134166681f },
    { 122.0034081619f,  136.4859475912f,  40.2625740865f },
    { 123.7501383600f,  132.8675645056f,  42.0311797519f },
    { 125.4619622967f,  129.5654446925f,  43.8162490283f },
    { 127.1410153044f,  126.5563904841f,  45.6146228583f },
    { 128.7892063777f,  123.8197274640f,  47.4229925896f },
    { 130.4082517955f,  121.3368704933f,  49.2379312377f },
    { 131.9997024555f,  119.0909763424f,  51.0559296084f },
    { 133.5649663135f,  117.0666646403f,  52.8734357753f },
    { 135.1053269695f,  115.2497932839f,  54.6868964417f },
    { 136.6219591879f,  113.6272776172f,  56.4927987415f },
    { 138.1159419551f,  112.1869449894f,  58.2877111002f },
    { 139.5882695418f,  110.9174179976f,  60.0683218823f },
    { 141.0398609341f,  109.8080209858f,  61.8314747071f },
    { 142.4715679238f,  108.8487053486f,  63.5741995169f },
    { 143.8841820844f,  108.0299899511f,  65.2937387066f },
    { 145.2784408198f,  107.3429135958f,  66.9875678734f },
    { 146.6550326330f,  106.7789969746f,  68.6534109889f },
    { 148.0146017359f,  106.3302119787f,  70.2892500267f },
    { 149.3577521011f,  105.9889566098f,  71.8933292839f },
    { 150.6850510360f,  105.7480340586f,  73.4641548006f },
    { 151.9970323479f,  105.6006347958f,  75.0004894112f },
    { 153.2941991575f,  105.5403207667f,  76.5013440423f },
    { 154.5770264069f,  105.5610109857f,  77.9659659195f },
    { 155.8459631034f,  105.6569680078f,  79.3938243495f },
    { 157.1014343327f,  105.8227848989f,  80.7845947273f },
    { 158.3438430699f,  106.0533724488f,  82.1381413679f },
    { 159.5735718136f,  106.3439464665f,  83.4544997030f },
    { 160.7909840639f,  106.6900150714f,  84.7338583129f },
    { 161.9964256622f,  107.0873659514f,  85.9765411858f },
    { 163.1902260090f,  107.5320535961f,  87.1829905223f },
    { 164.3726991732f,  108.0203865432f,  88.3537503314f },
    { 165.5441449041f,  108.5489146909f,  89.4894509988f },
    { 166.7048495578f,  109.1144167367f,  90.5907949479f },
    { 167.8550869450f,  109.7138878083f,  91.6585434672f },
    { 168.9951191101f,  110.3445273448f,  92.6935047339f },
    { 170.1251970476f,  111.0037272879f,  93.6965230307f },
    { 171.2455613617f,  111.6890606284f,  94.6684691259f },
    { 172.3564428755f,  112.3982703515f,  95.6102317695f },
    { 173.4580631934f,  113.1292588114f,  96.5227102410f },
    { 174.5506352220f,  113.8800775609f,  97.4068078773f },
    { 175.6343636528f,  114.6489176506f,  98.2634265046f },
    { 176.7094454103f,  115.4341004087f,  99.0934616941f },
    { 177.7760700687f,  116.2340687034f,  99.8977987626f },
    { 178.8344202390f,  117.0473786854f,  100.6773094419f },
    { 179.8846719304f,  117.8726920044f,  101.4328491442f },
    { 180.9269948873f,  118.7087684884f,  102.1652547530f },
    { 181.9615529038f,  119.5544592724f,  102.8753428773f },
    { 182.9885041181f,  120.4087003602f,  103.5639085092f },
    { 184.0080012878f,  121.2705066026f,  104.2317240317f },
    { 185.0201920479f,  122.1389660722f,  104.8795385288f },
    { 186.0252191533f,  123.0132348157f,  105.5080773529f },
    { 187.0232207055f,  123.8925319649f,  106.1180419127f },
    { 188.0143303669f,  124.7761351839f,  106.7101096465f },
    { 188.9986775611f,  125.6633764362f,  107.2849341496f },
    { 188.5604037142f,  125.7481995811f,  107.8513538871f },
    { 188.1206717127f,  125.8465081175f,  108.4202183061f },
    { 187.6794676545f,  125.9585038062f,  108.9914316248f },
    { 187.2367774114f,  126.0843882699f,  109.5648954541f },
    { 186.7925866246f,  126.2243629063f,  110.1405088784f },
    { 186.3468806988f,  126.3786288049f,  110.7181685440f },
    { 185.8996447973f,  126.5473866653f,  111.2977687534f },
    { 185.4508638354f,  126.7308367190f,  111.8792015669f },
    { 185.0005224757f,  126.9291786532f,  112.4623569103f },
    { 184.5486051209f,  127.1426115395f,  113.0471226887f },
    { 184.0950959086f,  127.3713337651f,  113.6333849067f },
    { 183.6399787042f,  127.6155429695f,  114.2210277938f },
    { 183.1832370945f,  127.8754359849f,  114.8099339355f },
    { 182.7248543809f,  128.1512087822f,  115.3999844091f },
    { 182.2648135725f,  128.4430564218f,  115.9910589248f },
    { 181.8030973784f,  128.7511730106f,  116.5830359701f },
    { 181.3396882008f,  129.0757516646f,  117.1757929590f },
    { 180.8745681267f,  129.4169844786f,  117.7692063843f },
    { 180.4077189202f,  129.7750625015f,  118.3631519727f },
    { 179.9391220144f,  130.1501757195f,  118.9575048422f },
    { 179.4687585023f,  130.5425130460f,  119.5521396627f },
    { 178.9966091286f,  130.9522623198f,  120.1469308161f },
    { 178.5226542802f,  131.3796103100f,  120.7417525595f },
    { 178.0468739770f,  131.8247427302f,  121.3364791872f },
    { 177.5692478620f,  132.2878442597f,  121.9309851940f },
    { 177.0897551913f,  132.7690985744f,  122.5251454366f },
    { 176.6083748236f,  133.2686883853f,  123.1188352953f },
    { 176.1250852094f,  133.7867954867f,  123.7119308329f },
    { 175.6398643801f,  134.3236008124f,  124.3043089525f },
    { 175.1526899361f,  134.8792845024f,  124.8958475520f },
    { 174.6635390347f,  135.4540259772f,  125.4864256762f },
    { 174.1723883783f,  136.0480040225f,  126.0759236647f },
    { 173.6792142009f,  136.6613968831f,  126.6642232967f },
    { 173.1839922550f,  137.2943823658f,  127.2512079306f },
    { 172.6866977979f,  137.9471379522f,  127.8367626396f },
    { 172.1873055771f,  138.6198409209f,  128.4207743422f },
    { 171.6857898155f,  139.3126684796f,  129.0031319264f },
    { 171.1821241961f,  140.0257979058f,  129.5837263695f },
    { 170.6762818458f,  140.7594066982f,  130.1624508508f },
    { 170.1682353188f,  141.5136727369f,  130.7392008591f },
    { 169.6579565792f,  142.2887744537f,  131.3138742928f },
    { 169.1454169831f,  143.0848910114f,  131.8863715541f },
    { 168.6305872601f,  143.9022024933f,  132.4565956363f },
    { 168.1134374934f,  144.7408901014f,  133.0244522041f },
    { 167.5939371000f,  145.6011363653f,  133.5898496673f },
    { 167.0720548094f,  146.4831253598f,  134.1526992473f },
    { 166.5477586418f,  147.3870429320f,  134.7129150367f },
    { 166.0210158855f,  148.3130769391f,  135.2704140519f },
    { 165.4917930725f,  149.2614174944f,  135.8251162792f },
    { 164.9600559546f,  150.2322572245f,  136.3769447134f },
    { 164.4257694769f,  151.2257915353f,  136.9258253904f },
    { 163.8888977512f,  152.2422188883f,  137.4716874126f },
    { 163.3494040278f,  153.2817410871f,  138.0144629683f },
    { 162.8072506663f,  154.3445635742f,  138.5540873445f },
    { 162.2623991049f,  155.4308957381f,  139.0904989339f },
    { 161.7148098285f,  156.5409512310f,  139.6236392360f },
    { 161.1644423352f,  157.6749482982f,  140.1534528520f },
    { 160.6112551014f,  158.8331101177f,  140.6798874752f },
    { 160.0552055453f,  160.0156651526f,  141.2028938756f },
    { 159.4962499888f,  161.2228475148f,  141.7224258796f },
    { 159.9705906096f,  155.7902062175f,  142.8478463553f },
    { 160.4328248413f,  150.9981703716f,  143.9188624983f },
    { 160.8855333493f,  146.6996372013f,  144.9498740503f },
    { 161.3304452014f,  142.7961931873f,  145.9504946315f },
    { 161.7687847674f,  139.2182794999f,  146.9274944672f },
    { 162.2014561365f,  135.9146474972f,  147.8858349145f },
    { 162.6291492447f,  132.8462904803f,  148.8292645149f },
    { 163.0524047931f,  129.9827313899f,  149.7606839089f },
    { 163.4716559405f,  127.2996384965f,  150.6823803045f },
    { 163.8872561630f,  124.7772319353f,  151.5961841952f },
    { 164.2994984971f,  122.3991829333f,  152.5035776076f },
    { 164.7086292088f,  120.1518317859f,  153.4057709852f },
    { 165.1148577381f,  118.0236187668f,  154.3037591168f },
    { 165.5183640870f,  116.0046612674f,  155.1983626834f },
    { 165.9193044097f,  114.0864337959f,  156.0902596939f },
    { 166.3178153096f,  112.2615218756f,  156.9800096679f },
    { 166.7140171920f,  110.5234300353f,  157.8680725190f },
    { 167.1080169120f,  108.8664300615f,  158.7548235039f },
    { 167.4999098919f,  107.2854396716f,  159.6405652100f },
    { 167.8897818306f,  105.7759244819f,  160.5255372837f },
    { 168.2777100983f,  104.3338180407f,  161.4099244189f },
    { 168.6637648835f,  102.9554560231f,  162.2938629883f },
    { 169.0480101441f,  101.6375216460f,  163.1774466115f },
    { 169.4305044021f,  100.3770000570f,  164.0607308781f },
    { 169.8113014123f,  99.1711399624f,  164.9437373994f },
    { 170.1904507282f,  98.0174211443f,  165.8264573204f },
    { 170.5679981835f,  96.9135268043f,  166.7088543959f },
    { 170.9439863048f,  95.8573198906f,  167.5908677130f },
    { 171.3184546669f,  94.8468227355f,  168.4724141248f },
    { 171.6914401998f,  93.8801994604f,  169.3533904478f },
    { 172.0629774550f,  92.9557407089f,  170.2336754629f },
    { 172.4330988387f,  92.0718503475f,  171.1131317546f },
    { 172.8018348157f,  91.2270338407f,  171.9916074136f },
    { 173.1692140879f,  90.4198880549f,  172.8689376250f },
    { 173.5352637534f,  89.6490922901f,  173.7449461583f },
    { 173.9000094457f,  88.9134003688f,  174.6194467725f },
    { 174.2634754586f,  88.2116336413f,  175.4922445472f },
    { 174.6256848565f,  87.5426747869f,  176.3631371478f },
    { 174.9866595741f,  86.9054623088f,  177.2319160302f },
    { 175.3464205045f,  86.2989856375f,  178.0983675918f },
    { 175.7049875792f,  85.7222807674f,  178.9622742693f },
    { 176.0623798399f,  85.1744263636f,  179.8234155881f },
    { 176.4186155032f,  84.6545402837f,  180.6815691644f },
    { 176.7737120194f,  84.1617764674f,  181.5365116596f },
    { 177.1276861258f,  83.6953221514f,  182.3880196893f },
    { 177.4805538949f,  83.2543953753f,  183.2358706862f },
    { 177.8323307783f,  82.8382427449f,  184.0798437165f },
    { 178.1830316475f,  82.4461374261f,  184.9197202503f },
    { 178.5326708299f,  82.0773773446f,  185.7552848844f },
    { 178.8812621433f,  81.7312835687f,  186.5863260189f },
    { 179.2288189260f,  81.4071988580f,  187.4126364860f },
    { 179.5753540659f,  81.1044863578f,  188.2340141303f },
    { 179.9208800261f,  80.8225284263f,  189.0502623427f },
    { 180.2654088695f,  80.5607255790f,  189.8611905456f },
    { 180.6089522808f,  80.3184955394f,  190.6666146306f },
    { 180.9515215870f,  80.0952723838f,  191.4663573500f },
    { 181.2931277770f,  79.8905057700f,  192.2602486608f },
    { 181.6337815186f,  79.7036602423f,  193.0481260239f },
    { 181.9734931755f,  79.5342146032f,  193.8298346581f },
    { 182.3122728226f,  79.3816613449f,  194.6052277516f },
    { 181.2755293710f,  78.7475754206f,  195.3877150750f },
    { 180.2310949539f,  78.1220960282f,  196.1901472372f },
    { 179.1788138905f,  77.5058606289f,  197.0130515323f },
    { 178.1185252399f,  76.8995415310f,  197.8569555262f },
    { 177.0500625500f,  76.3038474104f,  198.7223848553f },
    { 175.9732535908f,  75.7195248367f,  199.6098607403f },
    { 174.8879200706f,  75.1473597932f,  200.5198971962f },
    { 173.7938773349f,  74.5881791803f,  201.4529979212f },
    { 172.6909340447f,  74.0428522858f,  202.4096528479f },
    { 171.5788918345f,  73.5122922079f,  203.3903343451f },
    { 170.4575449471f,  72.9974572135f,  204.3954930608f },
    { 169.3266798441f,  72.4993520112f,  205.4255534025f },
    { 168.1860747888f,  72.0190289197f,  206.4809086558f },
    { 167.0354994010f,  71.5575889088f,  207.5619157515f },
    { 165.8747141797f,  71.1161824889f,  208.6688897000f },
    { 164.7034699914f,  70.6960104262f,  209.8020977185f },
    { 163.5215075212f,  70.2983242595f,  210.9617530946f },
    { 162.3285566833f,  69.9244265925f,  212.1480088367f },
    { 161.1243359862f,  69.5756711427f,  213.3609511798f },
    { 159.9085518499f,  69.2534625231f,  214.6005930292f },
    { 158.6808978694f,  68.9592557422f,  215.8668674413f },
    { 157.4410540193f,  68.6945554086f,  217.1596212554f },
    { 156.1886857947f,  68.4609146342f,  218.4786090087f },
    { 154.9234432804f,  68.2599336378f,  219.8234872792f },
    { 153.6449601425f,  68.0932580583f,  221.1938096147f },
    { 152.3528525337f,  67.9625769993f,  222.5890222155f },
    { 151.0467179027f,  67.8696208389f,  224.0084605467f },
    { 149.7261336978f,  67.8161588510f,  225.4513470522f },
    { 148.3906559533f,  67.8039967018f,  226.9167901444f },
    { 147.0398177446f,  67.8349738987f,  228.4037846262f },
    { 145.6731274969f,  67.9109612899f,  229.9112136898f },
    { 144.2900671317f,  68.0338587255f,  231.4378526076f },
    { 142.8900900290f,  68.2055930125f,  232.9823742009f },
    { 141.4726187853f,  68.4281163119f,  234.5433561332f },
    { 140.0370427392f,  68.7034051422f,  236.1192900325f },
    { 138.5827152365f,  69.0334601696f,  237.7085923996f },
    { 137.1089505991f,  69.4203069816f,  239.3096172127f },
    { 135.6150207586f,  69.8659980512f,  240.9206700902f },
    { 134.1001515073f,  70.3726161170f,  242.5400238317f },
    { 132.5635183125f,  70.9422792146f,  244.1659351199f },
    { 131.0042416307f,  71.5771476123f,  245.7966621359f },
    { 129.4213816458f,  72.2794329235f,  247.4304828261f },
    { 127.8139323433f,  73.0514096894f,  249.0657135508f },
    { 126.1808148145f,  73.8954297608f,  250.7007278552f },
    { 124.5208696649f,  74.8139398490f,  252.3339751274f },
    { 122.8328483768f,  75.8095026762f,  253.9639989442f },
    { 121.1154034430f,  76.8848222347f,  255.5894549617f },
    { 119.3670770516f,  78.0427737753f,  257.2091282701f },
    { 117.5862880542f,  79.2864392889f,  258.8219502158f },
    { 115.7713168859f,  80.6191494416f,  260.4270147860f },
    { 113.9202880305f,  82.0445331834f,  262.0235947598f },
    { 112.0311495254f,  83.5665766002f,  263.6111579559f },
    { 110.1016488676f,  85.1896930420f,  265.1893840514f },
    { 108.1293045208f,  86.9188071935f,  266.7581826265f },
    { 106.1113719962f,  88.7594566031f,  268.3177133026f },
    { 104.0448031889f,  90.7179153636f,  269.8684091246f },
    { 101.9261972522f,  92.8013462664f,  271.4110047025f },
    { 99.7517407494f,  95.0179900522f,  272.9465711340f },
    { 97.5171340723f,  97.3774036676f,  274.4765604323f },
    { 95.2175000577f,  99.8907642334f,  276.0028632017f },
    { 96.2809782082f,  99.4071670618f,  278.0452202502f },
    { 97.3279719077f,  99.0485703725f,  280.0495854080f },
    { 98.3592177587f,  98.8066951758f,  282.0135906745f },
    { 99.3753982871f,  98.6736475163f,  283.9352257653f },
    { 100.3771473661f,  98.6419107537f,  285.8128371662f },
    { 101.3650549595f,  98.7043394149f,  287.6451198296f },
    { 102.3396712871f,  98.8541535891f,  289.4311027275f },
    { 103.3015104939f,  99.0849331222f,  291.1701295341f },
    { 104.2510538951f,  99.3906111161f,  292.8618356867f },
    { 105.1887528550f,  99.7654664357f,  294.5061229974f },
    { 106.1150313481f,  100.2041150884f,  296.1031328724f },
    { 107.0302882458f,  100.7015004614f,  297.6532190477f },
    { 107.9348993620f,  101.2528824904f,  299.1569205996f },
    { 108.8292192897f,  101.8538258906f,  300.6149358315f },
    { 109.7135830529f,  102.5001876214f,  302.0280974908f },
    { 110.5883075964f,  103.1881037657f,  303.3973496401f },
    { 111.4536931326f,  103.9139760158f,  304.7237263880f },
    { 112.3100243619f,  104.6744579417f,  306.0083325904f },
    { 113.1575715804f,  105.4664412117f,  307.2523265536f },
    { 113.9965916874f,  106.2870419096f,  308.4569047094f },
    { 114.8273291050f,  107.1335870757f,  309.6232881884f },
    { 115.6500166162f,  108.0036015777f,  310.7527111821f },
    { 116.4648761329f,  108.8947953949f,  311.8464109671f },
    { 117.2721193995f,  109.8050513820f,  312.9056194516f },
    { 118.0719486387f,  110.7324135599f,  313.9315560971f },
    { 118.8645571452f,  111.6750759668f,  314.9254220736f },
    { 119.6501298327f,  112.6313720883f,  315.8883955067f },
    { 120.4288437384f,  113.5997648763f,  316.8216276851f },
    { 121.2008684888f,  114.5788373533f,  317.7262401052f },
    { 121.9663667303f,  115.5672837978f,  318.6033222389f },
    { 122.7254945290f,  116.5639014920f,  319.4539299225f },
    { 123.4784017400f,  117.5675830181f,  320.2790842742f },
    { 124.2252323517f,  118.5773090779f,  321.0797710571f },
    { 124.9661248049f,  119.5921418134f,  321.8569404175f },
    { 125.7012122900f,  120.6112186025f,  322.6115069310f },
    { 126.4306230246f,  121.6337463043f,  323.3443499051f },
    { 127.1544805115f,  122.6589959267f,  324.0563138869f },
    { 127.8729037804f,  123.6862976902f,  324.7482093361f },
    { 128.5860076131f,  124.7150364631f,  325.4208134281f },
    { 129.2939027553f,  125.7446475424f,  326.0748709560f },
    { 129.9966961136f,  126.7746127566f,  326.7110953065f },
    { 130.6944909415f,  127.8044568684f,  327.3301694884f },
    { 131.3873870131f,  128.8337442538f,  327.9327471952f },
    { 132.0754807868f,  129.8620758397f,  328.5194538879f },
    { 132.7588655586f,  130.8890862782f,  329.0908878838f },
    { 133.4376316070f,  131.9144413415f,  329.6476214434f },
    { 134.1118663288f,  132.9378355196f,  330.1902018456f },
    { 134.7816543678f,  133.9589898053f,  330.7191524458f },
    { 135.4470777354f,  134.9776496520f,  331.2349737109f },
    { 136.1082159251f,  135.9935830911f,  331.7381442277f },
    { 136.7651460203f,  137.0065789951f,  332.2291216820f },
    { 137.4179427963f,  138.0164454775f,  332.7083438056f },
    { 138.0666788165f,  139.0230084152f,  333.1762292898f },
    { 138.7114245244f,  140.0261100874f,  333.6331786656f },
    { 139.3522483292f,  141.0256079185f,  334.0795751481f },
    { 139.9892166886f,  142.0213733187f,  334.5157854472f },
    { 140.6223941860f,  143.0132906143f,  334.9421605432f },
    { 141.2518436048f,  144.0012560595f,  335.3590364290f },
    { 141.8776259978f,  144.9851769248f,  335.7667348184f },
    { 142.4998007547f,  145.9649706542f,  336.1655638222f },
    { 142.0354288232f,  146.0167425793f,  336.5603877834f },
    { 141.5689544605f,  146.0747136578f,  336.9599393727f },
    { 141.1003476474f,  146.1390417702f,  337.3643174287f },
    { 140.6295775409f,  146.2098891173f,  337.7736249873f },
    { 140.1566124372f,  146.2874223620f,  338.1879695829f },
    { 139.6814197332f,  146.3718127788f,  338.6074635772f },
    { 139.2039658848f,  146.4632364095f,  339.0322245189f },
    { 138.7242163628f,  146.5618742274f,  339.4623755382f },
    { 138.2421356055f,  146.6679123096f,  339.8980457791f },
    { 137.7576869682f,  146.7815420186f,  340.3393708744f },
    { 137.2708326688f,  146.9029601938f,  340.7864934694f },
    { 136.7815337295f,  147.0323693541f,  341.2395637976f },
    { 136.2897499141f,  147.1699779131f,  341.6987403174f },
    { 135.7954396605f,  147.3160004069f,  342.1641904153f },
    { 135.2985600076f,  147.4706577384f,  342.6360911862f },
    { 134.7990665161f,  147.6341774369f,  343.1146302973f },
    { 134.2969131834f,  147.8067939375f,  343.6000069511f },
    { 133.7920523501f,  147.9887488823f,  344.0924329564f },
    { 133.2844345989f,  148.1802914453f,  344.5921339254f },
    { 132.7740086443f,  148.3816786853f,  345.0993506125f },
    { 132.2607212109f,  148.5931759315f,  345.6143404167f },
    { 131.7445169011f,  148.8150572055f,  346.1373790701f },
    { 131.2253380491f,  149.0476056869f,  346.6687625418f },
    { 130.7031245588f,  149.2911142293f,  347.2088091902f },
    { 130.1778137263f,  149.5458859359f,  347.7578622019f },
    { 129.6493400403f,  149.8122348056f,  348.3162923658f },
    { 129.1176349617f,  150.0904864631f,  348.8845012365f },
    { 128.5826266753f,  150.3809789901f,  349.4629247554f },
    { 128.0442398119f,  150.6840638779f,  350.0520374099f },
    { 127.5023951341f,  151.0001071286f,  350.6523570287f },
    { 126.9570091798f,  151.3294905371f,  351.2644503335f },
    { 126.4079938572f,  151.6726131966f,  351.8889393940f },
    { 125.8552559794f,  152.0298932805f,  352.5265091678f },
    { 125.2986967302f,  152.4017701712f,  353.1779163513f },
    { 124.7382110434f,  152.7887070241f,  353.8439998244f },
    { 124.1736868811f,  153.1911938847f,  354.5256930469f },
    { 123.6050043852f,  153.6097515134f,  355.2240388614f },
    { 123.0320348740f,  154.0449361232f,  355.9402072868f },
    { 122.4546396476f,  154.4973453074f,  356.6755170620f },
    { 121.8726685496f,  154.9676255304f,  357.4314619328f },
    { 121.2859582230f,  155.4564816988f,  358.2097430020f },
    { 120.6943299711f,  155.9646895261f,  359.0123089127f },
    { 120.0975871057f,  156.4931117019f,  359.8414062752f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    309.644f,
    312.787f,
    315.869f,
    318.878f,
    321.808f,
    324.640f,
    327.374f,
    330.011f,
    332.532f,
    334.949f,
    337.250f,
    339.441f,
    341.516f,
    343.488f,
    345.349f,
    347.107f,
    348.773f,
    350.354f,
    351.843f,
    353.265f,
    354.620f,
    355.914f,
    357.159f,
    358.362f,
    359.540f,
    360.687f,
    355.096f,
    342.340f,
    330.579f,
    319.696f,
    309.601f,
    300.220f,
    291.473f,
    283.313f,
    275.684f,
    268.530f,
    261.823f,
    255.511f,
    249.579f,
    243.988f,
    238.715f,
    233.734f,
    229.022f,
    224.573f,
    220.349f,
    216.351f,
    212.561f,
    208.966f,
    205.548f,
    202.301f,
    199.219f,
    196.283f,
    193.494f,
    190.845f,
    188.318f,
    185.913f,
    183.624f,
    181.451f,
    179.376f,
    177.405f,
    175.531f,
    173.749f,
    172.052f,
    170.441f,
    168.909f,
    167.456f,
    166.077f,
    164.771f,
    163.538f,
    162.372f,
    161.267f,
    160.229f,
    159.247f,
    158.331f,
    157.471f,
    156.671f,
    155.920f,
    155.231f,
    154.590f,
    153.998f,
    153.461f,
    152.979f,
    152.539f,
    152.148f,
    151.813f,
    151.520f,
    151.270f,
    151.074f,
    150.922f,
    150.812f,
    150.751f,
    150.739f,
    150.769f,
    150.848f,
    150.970f,
    151.141f,
    151.361f,
    151.624f,
    151.935f,
    152.295f,
    152.698f,
    153.156f,
    153.662f,
    154.218f,
    154.828f,
    155.487f,
    156.201f,
    156.970f,
    157.794f,
    158.673f,
    159.613f,
    160.614f,
    161.676f,
    162.805f,
    164.001f,
    165.259f,
    166.595f,
    167.999f,
    169.482f,
    171.039f,
    172.687f,
    174.414f,
    176.233f,
    178.143f,
    180.151f,
    182.257f,
    184.479f,
    186.804f,
    189.252f,
    191.827f,
    194.531f,
    197.369f,
    200.354f,
    203.497f,
    206.805f,
    210.284f,
    213.953f,
    217.816f,
    221.893f,
    226.190f,
    230.731f,
    235.535f,
    240.619f,
    245.996f,
    251.703f,
    257.764f,
    264.203f,
    268.195f,
    261.218f,
    254.633f,
    248.407f,
    242.511f,
    236.932f,
    231.641f,
    226.624f,
    221.857f,
    217.328f,
    213.025f,
    208.923f,
    205.023f,
    201.312f,
    197.766f,
    194.391f,
    191.168f,
    188.098f,
    185.162f,
    182.361f,
    179.681f,
    177.130f,
    174.683f,
    172.351f,
    170.117f,
    167.981f,
    165.942f,
    163.995f,
    162.134f,
    160.352f,
    158.649f,
    157.025f,
    155.475f,
    153.992f,
    152.576f,
    151.227f,
    149.945f,
    148.718f,
    147.552f,
    146.442f,
    145.392f,
    144.391f,
    143.445f,
    142.548f,
    141.705f,
    140.906f,
    140.155f,
    139.447f,
    138.788f,
    138.171f,
    137.598f,
    137.067f,
    136.572f,
    136.127f,
    135.718f,
    135.345f,
    135.016f,
    134.723f,
    134.473f,
    134.259f,
    134.082f,
    133.942f,
    133.838f,
    133.771f,
    133.740f,
    133.752f,
    133.795f,
    133.881f,
    133.997f,
    134.155f,
    134.351f,
    134.583f,
    134.851f,
    135.156f,
    135.504f,
    135.889f,
    136.316f,
    136.780f,
    137.286f,
    137.836f,
    138.428f,
    139.056f,
    139.734f,
    140.454f,
    141.223f,
    142.035f,
    142.896f,
    143.805f,
    144.763f,
    145.776f,
    146.838f,
    147.961f,
    149.133f,
    150.366f,
    151.660f,
    153.015f,
    154.431f,
    155.920f,
    157.471f,
    159.094f,
    160.791f,
    162.567f,
    164.423f,
    166.357f,
    168.384f,
    170.496f,
    172.699f,
    175.000f,
    177.405f,
    179.913f,
    182.538f,
    185.272f,
    188.135f,
    191.119f,
    194.238f,
    197.498f,
    200.903f,
    204.462f,
    208.185f,
    212.079f,
    216.144f,
    216.992f,
    215.265f,
    213.617f,
    212.054f,
    210.565f,
    209.155f,
    207.819f,
    206.555f,
    205.359f,
    204.230f,
    203.168f,
    202.173f,
    201.239f,
    200.366f,
    199.554f,
    198.798f,
    198.108f,
    197.467f,
    196.887f,
    196.362f,
    195.892f,
    195.477f,
    195.117f,
    194.806f,
    194.550f,
    194.342f,
    194.189f,
    194.086f,
    194.037f,
    194.037f,
    194.086f,
    194.189f,
    194.336f,
    194.537f,
    194.794f,
    195.099f,
    195.453f,
    195.856f,
    196.313f,
    196.826f,
    197.388f,
    197.998f,
    198.669f,
    199.390f,
    200.165f,
    200.995f,
    201.880f,
    202.820f,
    203.821f,
    204.877f,
    205.988f,
    207.166f,
    208.398f,
    209.692f,
    211.047f,
    212.469f,
    213.953f,
    215.503f,
    217.114f,
    218.799f,
    220.544f,
    222.363f,
    224.249f,
    226.208f,
    228.241f,
    230.341f,
    232.513f,
    234.760f,
    237.079f,
    239.471f,
    241.937f,
    244.476f,
    247.089f,
    249.774f,
    252.527f,
    255.347f,
    258.240f,
    261.188f,
    264.203f,
    267.279f,
    270.404f,
    273.578f,
    276.794f,
    280.048f,
    283.331f,
    286.633f,
    289.954f,
    293.280f,
    296.600f,
    299.908f,
    303.192f,
    306.439f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 129.1624525232f,  208.5693439331f,  0.5694240779f },
    { 128.6745400337f,  209.2780922202f,  1.2309221316f },
    { 128.1823578648f,  210.0005264715f,  1.9153906674f },
    { 127.6856814057f,  210.7368972146f,  2.6253493228f },
    { 127.1842542503f,  211.4874952104f,  3.3637749048f },
    { 126.6777804709f,  212.2526710042f,  4.1342203604f },
    { 126.1659142098f,  213.0328644418f,  4.9409758527f },
    { 125.6482453498f,  213.8286499014f,  5.7892915087f },
    { 125.1242792876f,  214.6408069446f,  6.6856930751f },
    { 124.5934075381f,  215.4704333461f,  7.6384422102f },
    { 124.0548635178f,  216.3191314042f,  8.6582308166f },
    { 123.5076532272f,  217.1893267600f,  9.7592720825f },
    { 122.9504409240f,  218.0848404746f,  10.9611032415f },
    { 122.3813481069f,  219.0119804344f,  12.2917594647f },
    { 121.7975693289f,  219.9818004507f,  13.7938448418f },
    { 121.1945491115f,  221.0153377721f,  15.5375425621f },
    { 120.5638960035f,  222.1579910683f,  17.6535763822f },
    { 119.8863845484f,  223.5320288324f,  20.4436725835f },
    { 119.0871719407f,  225.7102922535f,  25.0856052001f },
    { 120.9243606311f,  217.3182165232f,  26.4465225379f },
    { 122.7087418395f,  209.5717745400f,  27.8336672321f },
    { 124.4453825716f,  202.4045337229f,  29.2475489007f },
    { 126.1385390601f,  195.7613040842f,  30.6884025330f },
    { 127.7918297918f,  189.5956964916f,  32.1562010066f },
    { 129.4083637124f,  183.8683074611f,  33.6506629210f },
    { 130.9908370196f,  178.5453438427f,  35.1712576321f },
    { 132.5416074610f,  173.5975630810f,  36.7172089741f },
    { 134.0627522113f,  168.9994442936f,  38.2874988601f },
    { 135.5561135578f,  164.7285311883f,  39.8808717320f },
    { 137.0233353927f,  160.7649050340f,  41.4958406490f },
    { 138.4658926791f,  157.0907576089f,  43.1306956412f },
    { 139.8851154773f,  153.6900421640f,  44.7835147992f },
    { 141.2822087122f,  150.5481861591f,  46.4521784164f },
    { 142.6582685718f,  147.6518536068f,  48.1343863372f },
    { 144.0142962140f,  144.9887478037f,  49.8276785053f },
    { 145.3512093043f,  142.5474473703f,  51.5294585389f },
    { 146.6698517916f,  140.3172700838f,  53.2370200048f },
    { 147.9710022397f,  138.2881601405f,  54.9475749219f },
    { 149.2553809709f,  136.4505953259f,  56.6582838985f },
    { 150.5236562202f,  134.7955111925f,  58.3662872197f },
    { 151.7764494657f,  133.3142398055f,  60.0687361383f },
    { 153.0143400662f,  131.9984609575f,  61.7628236040f },
    { 154.2378693131f,  130.8401640087f,  63.4458136815f },
    { 155.4475439858f,  129.8316187181f,  65.1150689649f },
    { 156.6438394836f,  128.9653535880f,  66.7680753801f },
    { 157.8272025937f,  128.2341403927f,  68.4024638819f },
    { 158.9980539474f,  127.6309836889f,  70.0160286821f },
    { 160.1567902058f,  127.1491142294f,  71.6067417812f },
    { 161.3037860114f,  126.7819853217f,  73.1727637182f },
    { 162.4393957352f,  126.5232712944f,  74.7124505815f },
    { 163.5639550462f,  126.3668673489f,  76.2243574387f },
    { 164.6777823239f,  126.3068901912f,  77.7072384416f },
    { 165.7811799336f,  126.3376789481f,  79.1600439370f },
    { 166.8744353808f,  126.4537959735f,  80.5819149631f },
    { 167.9578223575f,  126.6500272488f,  81.9721755453f },
    { 169.0316016937f,  126.9213821627f,  83.3303232106f },
    { 170.0960222246f,  127.2630925331f,  84.6560181344f },
    { 171.1513215812f,  127.6706107945f,  85.9490713105f },
    { 172.1977269145f,  128.1396073274f,  87.2094321033f },
    { 173.2354555582f,  128.6659669475f,  88.4371755023f },
    { 174.2647156380f,  129.2457846024f,  89.6324893541f },
    { 175.2857066308f,  129.8753603488f,  90.7956618055f },
    { 176.2986198810f,  130.5511936948f,  91.9270691437f },
    { 177.3036390759f,  131.2699774034f,  93.0271641815f },
    { 178.3009406852f,  132.0285908550f,  94.0964652961f },
    { 179.2906943686f,  132.8240930658f,  95.1355461956f },
    { 180.2730633519f,  133.6537154557f,  96.1450264605f },
    { 181.2482047776f,  134.5148544531f,  97.1255628798f },
    { 182.2162700299f,  135.4050640158f,  98.0778415847f },
    { 183.1774050373f,  136.3220481393f,  99.0025709631f },
    { 184.1317505543f,  137.2636534138f,  99.9004753293f },
    { 185.0794424246f,  138.2278616851f,  100.7722893111f },
    { 186.0206118268f,  139.2127828619f,  101.6187529125f },
    { 186.9553855035f,  140.2166479088f,  102.4406072047f },
    { 187.8838859766f,  141.2378020518f,  103.2385905974f },
    { 188.8062317482f,  142.2746982211f,  104.0134356392f },
    { 189.7225374902f,  143.3258907475f,  104.7658663011f },
    { 190.6329142205f,  144.3900293228f,  105.4965956923f },
    { 191.5374694705f,  145.4658532328f,  106.2063241672f },
    { 191.0016313291f,  145.6156962428f,  106.9056699533f },
    { 190.4635575798f,  145.7892690726f,  107.6082277359f },
    { 189.9232213345f,  145.9869731589f,  108.3138127590f },
    { 189.3805951558f,  146.2092084349f,  109.0222352043f },
    { 188.8356510408f,  146.4563730829f,  109.7333004632f },
    { 188.2883604049f,  146.7288632991f,  110.4468094283f },
    { 187.7386940644f,  147.0270730723f,  111.1625588056f },
    { 187.1866222190f,  147.3513939774f,  111.8803414442f },
    { 186.6321144333f,  147.7022149865f,  112.5999466833f },
    { 186.0751396174f,  148.0799222984f,  113.3211607158f },
    { 185.5156660075f,  148.4848991879f,  114.0437669659f },
    { 184.9536611445f,  148.9175258774f,  114.7675464793f },
    { 184.3890918532f,  149.3781794314f,  115.4922783256f },
    { 183.8219242194f,  149.8672336754f,  116.2177400090f },
    { 183.2521235669f,  150.3850591411f,  116.9437078877f },
    { 182.6796544330f,  150.9320230383f,  117.6699575980f },
    { 182.1044805438f,  151.5084892550f,  118.3962644827f },
    { 181.5265647871f,  152.1148183875f,  119.1224040212f },
    { 180.9458691858f,  152.7513677994f,  119.8481522589f },
    { 180.3623548689f,  153.4184917135f,  120.5732862346f },
    { 179.7759820418f,  154.1165413334f,  121.2975844037f },
    { 179.1867099553f,  154.8458649993f,  122.0208270547f },
    { 178.5944968733f,  155.6068083756f,  122.7427967177f },
    { 177.9993000387f,  156.3997146727f,  123.4632785631f },
    { 177.4010756384f,  157.2249249013f,  124.1820607887f },
    { 176.7997787659f,  158.0827781624f,  124.8989349927f },
    { 176.1953633833f,  158.9736119695f,  125.6136965326f },
    { 175.5877822806f,  159.8977626063f,  126.3261448674f },
    { 174.9769870332f,  160.8555655181f,  127.0360838827f },
    { 174.3629279583f,  161.8473557372f,  127.7433221961f },
    { 173.7455540683f,  162.8734683427f,  128.4476734444f },
    { 173.1248130222f,  163.9342389542f,  129.1489565493f },
    { 172.5006510750f,  165.0300042589f,  129.8469959620f },
    { 171.8730130242f,  166.1611025734f,  130.5416218869f },
    { 171.2418421539f,  167.3278744381f,  131.2326704824f },
    { 170.6070801764f,  168.5306632457f,  131.9199840403f },
    { 169.9686671699f,  169.7698159033f,  132.6034111421f },
    { 169.3265415142f,  171.0456835280f,  133.2828067941f },
    { 168.6806398224f,  172.3586221761f,  133.9580325394f },
    { 168.0308968693f,  173.7089936062f,  134.6289565494f },
    { 167.3772455156f,  175.0971660773f,  135.2954536934f },
    { 166.7196166287f,  176.5235151805f,  135.9574055880f },
    { 166.0579389991f,  177.9884247075f,  136.6147006262f },
    { 165.3921392514f,  179.4922875540f,  137.2672339881f },
    { 164.7221417519f,  181.0355066615f,  137.9149076325f },
    { 164.0478685094f,  182.6184959972f,  138.5576302715f },
    { 163.3692390717f,  184.2416815735f,  139.1953173292f },
    { 162.6861704154f,  185.9055025095f,  139.8278908839f },
    { 161.9985768299f,  187.6104121369f,  140.4552795970f },
    { 161.3063697936f,  189.3568791507f,  141.0774186281f },
    { 160.6094578439f,  191.1453888094f,  141.6942495385f },
    { 159.9077464387f,  192.9764441869f,  142.3057201830f },
    { 159.2011378093f,  194.8505674794f,  142.9117845921f },
    { 158.4895308048f,  196.7683013714f,  143.5124028462f },
    { 157.7728207262f,  198.7302104651f,  144.1075409405f },
    { 157.0508991500f,  200.7368827781f,  144.6971706447f },
    { 156.3236537406f,  202.7889313142f,  145.2812693569f },
    { 155.5909680504f,  204.8869957151f,  145.8598199524f },
    { 154.8527213063f,  207.0317439968f,  146.4328106295f },
    { 154.1087881822f,  209.2238743815f,  147.0002347531f },
    { 154.5852461782f,  201.5971148858f,  148.5178512184f },
    { 155.0341477876f,  195.4212176971f,  149.8579483591f },
    { 155.4649601114f,  190.1848478884f,  151.0834666110f },
    { 155.8826727367f,  185.6186868888f,  152.2276485550f },
    { 156.2902880275f,  181.5607851142f,  153.3104974312f },
    { 156.6897748515f,  177.9050165209f,  154.3451074712f },
    { 157.0825052184f,  174.5774870262f,  155.3405719647f },
    { 157.4694795969f,  171.5243632603f,  156.3034881526f },
    { 157.8514537111f,  168.7050243764f,  157.2388061403f },
    { 158.2290147610f,  166.0879458970f,  158.1503402747f },
    { 158.6026296895f,  163.6480933573f,  159.0410935811f },
    { 158.9726770654f,  161.3652007632f,  159.9134724343f },
    { 159.3394688931f,  159.2225930194f,  160.7694336344f },
    { 159.7032659769f,  157.2063563699f,  161.6105881739f },
    { 160.0642890205f,  155.3047391143f,  162.4382763103f },
    { 160.4227268224f,  153.5077091586f,  163.2536230724f },
    { 160.7787424418f,  151.8066210956f,  164.0575800884f },
    { 161.1324779175f,  150.1939614732f,  164.8509576392f },
    { 161.4840579315f,  148.6631509719f,  165.6344495923f },
    { 161.8335926935f,  147.2083887251f,  166.4086530573f },
    { 162.1811802378f,  145.8245283338f,  167.1740840705f },
    { 162.5269082722f,  144.5069780517f,  167.9311902467f },
    { 162.8708556824f,  143.2516196386f,  168.6803610885f },
    { 163.2130937652f,  142.0547417973f,  169.4219364619f },
    { 163.5536872491f,  140.9129851260f,  170.1562136247f },
    { 163.8926951454f,  139.8232962488f,  170.8834530981f },
    { 164.2301714615f,  138.7828893295f,  171.6038836079f },
    { 164.5661658042f,  137.7892135713f,  172.3177062690f },
    { 164.9007238929f,  136.8399256082f,  173.0250981518f },
    { 165.2338879968f,  135.9328659223f,  173.7262153372f },
    { 165.5656973122f,  135.0660385949f,  174.4211955485f },
    { 165.8961882868f,  134.2375938363f,  175.1101604283f },
    { 166.2253949021f,  133.4458128456f,  175.7932175183f },
    { 166.5533489186f,  132.6890946335f,  176.4704619863f },
    { 166.8800800907f,  131.9659445075f,  177.1419781387f },
    { 167.2056163553f,  131.2749639732f,  177.8078407501f },
    { 167.5299839980f,  130.6148418448f,  178.4681162350f },
    { 167.8532078001f,  129.9843463942f,  179.1228636832f },
    { 168.1753111686f,  129.3823183968f,  179.7721357774f },
    { 168.4963162528f,  128.8076649498f,  180.4159796071f },
    { 168.8162440472f,  128.2593539654f,  181.0544373936f },
    { 169.1351144847f,  127.7364092481f,  181.6875471350f },
    { 169.4529465196f,  127.2379060859f,  182.3153431814f },
    { 169.7697582020f,  126.7629672892f,  182.9378567490f },
    { 170.0855667461f,  126.3107596255f,  183.5551163786f },
    { 170.4003885904f,  125.8804906023f,  184.1671483461f },
    { 170.7142394534f,  125.4714055567f,  184.7739770290f },
    { 171.0271343837f,  125.0827850193f,  185.3756252336f },
    { 171.3390878057f,  124.7139423193f,  185.9721144878f },
    { 171.6501135611f,  124.3642214058f,  186.5634653023f },
    { 171.9602249470f,  124.0329948614f,  187.1496974026f },
    { 172.2694347505f,  123.7196620886f,  187.7308299367f },
    { 172.5777552811f,  123.4236476493f,  188.3068816584f },
    { 172.8851983994f,  123.1443997441f,  188.8778710903f },
    { 173.1917755442f,  122.8813888151f,  189.4438166678f },
    { 173.4974977574f,  122.6341062614f,  190.0047368651f },
    { 173.8023757070f,  122.4020632560f,  190.5606503065f },
    { 174.1064197078f,  122.1847896538f,  191.1115758628f },
    { 174.4096397414f,  121.9818329826f,  191.6575327349f },
    { 174.7120454743f,  121.7927575099f,  192.1985405257f },
    { 173.6935588996f,  120.8506649917f,  192.7442073186f },
    { 172.6673424960f,  119.9102574433f,  193.3034658686f },
    { 171.6332358326f,  118.9718821458f,  193.8767798218f },
    { 170.5910729177f,  118.0359105125f,  194.4646300618f },
    { 169.5406819253f,  117.1027397334f,  195.0675151634f },
    { 168.4818849063f,  116.1727945323f,  195.6859518179f },
    { 167.4144974789f,  115.2465290435f,  196.3204752226f },
    { 166.3383285002f,  114.3244288150f,  196.9716394261f },
    { 165.2531797151f,  113.4070129475f,  197.6400176170f },
    { 164.1588453819f,  112.4948363740f,  198.3262023464f },
    { 163.0551118718f,  111.5884922914f,  199.0308056679f },
    { 161.9417572412f,  110.6886147486f,  199.7544591820f },
    { 160.8185507728f,  109.7958814030f,  200.4978139657f },
    { 159.6852524845f,  108.9110164495f,  201.2615403697f },
    { 158.5416126019f,  108.0347937335f,  202.0463276599f },
    { 157.3873709922f,  107.1680400525f,  202.8528834803f },
    { 156.2222565545f,  106.3116386558f,  203.6819331114f },
    { 155.0459865644f,  105.4665329477f,  204.5342184939f },
    { 153.8582659665f,  104.6337304007f,  205.4104969886f },
    { 152.6587866110f,  103.8143066830f,  206.3115398378f },
    { 151.4472264289f,  103.0094100055f,  207.2381302928f },
    { 150.2232485385f,  102.2202656899f,  208.1910613707f },
    { 148.9865002776f,  101.4481809592f,  209.1711332022f },
    { 147.7366121528f,  100.6945499503f,  210.1791499307f },
    { 146.4731966974f,  99.9608589469f,  211.2159161234f },
    { 145.1958472271f,  99.2486918270f,  212.2822326583f },
    { 143.9041364841f,  98.5597357210f,  213.3788920518f },
    { 142.5976151547f,  97.8957868710f,  214.5066731970f },
    { 141.2758102480f,  97.2587566832f,  215.6663354907f },
    { 139.9382233171f,  96.6506779643f,  216.8586123351f },
    { 138.5843285063f,  96.0737113308f,  218.0842040150f },
    { 137.2135704002f,  95.5301517850f,  219.3437699654f },
    { 135.8253616528f,  95.0224354530f,  220.6379204650f },
    { 134.4190803648f,  94.5531464859f,  221.9672078177f },
    { 132.9940671794f,  94.1250241375f,  223.3321171075f },
    { 131.5496220557f,  93.7409700407f,  224.7330566525f },
    { 130.0850006770f,  93.4040557317f,  226.1703483141f },
    { 128.5994104403f,  93.1175304893f,  227.6442178641f },
    { 127.0920059682f,  92.8848295989f,  229.1547856549f },
    { 125.5618840692f,  92.7095831928f,  230.7020578838f },
    { 124.0080780630f,  92.5956258764f,  232.2859187924f },
    { 122.4295513696f,  92.5470074287f,  233.9061241874f },
    { 120.8251902416f,  92.5680049525f,  235.5622967116f },
    { 119.1937954963f,  92.6631369709f,  237.2539233370f },
    { 117.5340730736f,  92.8371801071f,  238.9803555787f },
    { 115.8446232083f,  93.0951891640f,  240.7408129587f },
    { 114.1239279614f,  93.4425216406f,  242.5343902605f },
    { 112.3703367944f,  93.8848679959f,  244.3600691262f },
    { 110.5820497976f,  94.4282893205f,  246.2167345526f },
    { 108.7570980883f,  95.0792645094f,  248.1031968495f },
    { 106.8933207716f,  95.8447496022f,  250.0182196385f },
    { 104.9883376959f,  96.7322526939f,  251.9605545170f },
    { 103.0395170238f,  97.7499288081f,  253.9289830967f },
    { 101.0439363573f,  98.9067004623f,  255.9223672927f },
    { 98.9983357748f,  100.2124115053f,  257.9397090109f },
    { 96.8990606165f,  101.6780244039f,  259.9802208359f },
    { 94.7419911385f,  103.3158748832f,  262.0434100196f },
    { 92.5224551362f,  105.1400032613f,  264.1291791515f },
    { 90.2351181917f,  107.1665899234f,  266.2379485455f },
    { 87.8738440832f,  109.4145347045f,  268.3708079019f },
    { 89.3569223415f,  108.1444136825f,  271.4728178356f },
    { 90.8036915692f,  107.2105325106f,  274.5141059557f },
    { 92.2166864583f,  106.5839681109f,  277.4840197131f },
    { 93.5981574462f,  106.2373513751f,  280.3734343412f },
    { 94.9501134453f,  106.1448349048f,  283.1748845677f },
    { 96.2743566650f,  106.2820962191f,  285.8826025906f },
    { 97.5725112421f,  106.6263535210f,  288.4924754013f },
    { 98.8460469713f,  107.1563783533f,  291.0019387550f },
    { 100.0962991236f,  107.8524956121f,  293.4098265309f },
    { 101.3244851097f,  108.6965662746f,  295.7161933982f },
    { 102.5317185831f,  109.6719518030f,  297.9221263288f },
    { 103.7190214456f,  110.7634616073f,  300.0295573106f },
    { 104.8873341240f,  111.9572863667f,  302.0410862435f },
    { 106.0375244142f,  113.2409206506f,  303.9598198590f },
    { 107.1703951267f,  114.6030783717f,  305.7892298668f },
    { 108.2866907281f,  116.0336043335f,  307.5330314697f },
    { 109.3871031346f,  117.5233846807f,  309.1950819127f },
    { 110.4722767847f,  119.0642585195f,  310.7792977584f },
    { 111.5428131002f,  120.6489324365f,  312.2895890159f },
    { 112.5992744210f,  122.2708991547f,  313.7298079985f },
    { 113.6421874889f,  123.9243611367f,  315.1037107366f },
    { 114.6720465411f,  125.6041596036f,  316.4149288792f },
    { 115.6893160664f,  127.3057091635f,  317.6669501893f },
    { 116.6944332677f,  129.0249380399f,  318.8631059655f },
    { 117.6878102675f,  130.7582337452f,  320.0065639481f },
    { 118.6698360894f,  132.5023939411f,  321.1003254957f },
    { 119.6408784421f,  134.2545821694f,  322.1472260223f },
    { 120.6012853303f,  136.0122880966f,  323.1499378713f },
    { 121.5513865109f,  137.7732919063f,  324.1109749592f },
    { 122.4914948147f,  139.5356324727f,  325.0326986588f },
    { 123.4219073462f,  141.2975789590f,  325.9173245036f },
    { 124.3429065764f,  143.0576055050f,  326.7669293887f },
    { 125.2547613395f,  144.8143686882f,  327.5834590179f },
    { 126.1577277438f,  146.5666874678f,  328.3687354094f },
    { 127.0520500055f,  148.3135253473f,  329.1244643200f },
    { 127.9379612133f,  150.0539745116f,  329.8522424859f },
    { 128.8156840311f,  151.7872417243f,  330.5535646104f },
    { 129.6854313438f,  153.5126357869f,  331.2298300493f },
    { 130.5474068530f,  155.2295563868f,  331.8823491658f },
    { 131.4018056265f,  156.9374841765f,  332.5123493387f },
    { 132.2488146059f,  158.6359719465f,  333.1209806177f },
    { 133.0886130763f,  160.3246367674f,  333.7093210296f },
    { 133.9213731021f,  162.0031529921f,  334.2783815415f },
    { 134.7472599307f,  163.6712460208f,  334.8291106930f },
    { 135.5664323673f,  165.3286867436f,  335.3623989126f },
    { 136.3790431248f,  166.9752865834f,  335.8790825321f },
    { 137.1852391476f,  168.6108930731f,  336.3799475175f },
    { 137.9851619155f,  170.2353859060f,  336.8657329320f },
    { 138.7789477255f,  171.8486734090f,  337.3371341491f },
    { 139.5667279566f,  173.4506893892f,  337.7948058324f },
    { 140.3486293162f,  175.0413903148f,  338.2393646963f },
    { 141.1247740714f,  176.6207527930f,  338.6713920665f },
    { 141.8952802658f,  178.1887713124f,  339.0914362507f },
    { 142.6602619222f,  179.7454562212f,  339.5000147373f },
    { 143.4198292337f,  181.2908319164f,  339.8976162321f },
    { 144.1740887424f,  182.8249352204f,  340.2847025459f },
    { 144.9231435083f,  184.3478139260f,  340.6617103460f },
    { 145.6670932678f,  185.8595254913f,  341.0290527789f },
    { 146.4060345825f,  187.3601358693f,  341.3871209769f },
    { 147.1400609808f,  188.8497184567f,  341.7362854557f },
    { 146.7535887047f,  189.1353099077f,  342.0809971465f },
    { 146.3655315637f,  189.4280563867f,  342.4287914056f },
    { 145.9758669534f,  189.7280754476f,  342.7797378882f },
    { 145.5845716163f,  190.0354865699f,  343.1339098550f },
    { 145.1916216111f,  190.3504111772f,  343.4913844347f },
    { 144.7969922799f,  190.6729726544f,  343.8522429092f },
    { 144.4006582123f,  191.0032963632f,  344.2165710260f },
    { 144.0025932081f,  191.3415096552f,  344.5844593377f },
    { 143.6027702360f,  191.6877418826f,  344.9560035742f },
    { 143.2011613903f,  192.0421244069f,  345.3313050503f },
    { 142.7977378436f,  192.4047906037f,  345.7104711127f },
    { 142.3924697958f,  192.7758758649f,  346.0936156308f },
    { 141.9853264195f,  193.1555175965f,  346.4808595374f },
    { 141.5762758001f,  193.5438552129f,  346.8723314244f },
    { 141.1652848714f,  193.9410301259f,  347.2681682018f },
    { 140.7523193452f,  194.3471857290f,  347.6685158255f },
    { 140.3373436351f,  194.7624673761f,  348.0735301062f },
    { 139.9203207724f,  195.1870223538f,  348.4833776074f },
    { 139.5012123148f,  195.6209998468f,  348.8982366462f },
    { 139.0799782461f,  196.0645508968f,  349.3182984105f },
    { 138.6565768651f,  196.5178283530f,  349.7437682098f },
    { 138.2309646639f,  196.9809868146f,  350.1748668787f },
    { 137.8030961926f,  197.4541825645f,  350.6118323560f },
    { 137.3729239095f,  197.9375734945f,  351.0549214676f },
    { 136.9403980133f,  198.4313190215f,  351.5044119427f },
    { 136.5054662572f,  198.9355799949f,  351.9606047051f },
    { 136.0680737381f,  199.4505185964f,  352.4238264823f },
    { 135.6281626615f,  199.9762982336f,  352.8944327884f },
    { 135.1856720736f,  200.5130834288f,  353.3728113480f },
    { 134.7405375588f,  201.0610397082f,  353.8593860399f },
    { 134.2926908927f,  201.6203334955f,  354.3546214601f },
    { 133.8420596459f,  202.1911320182f,  354.8590282256f },
    { 133.3885667263f,  202.7736032388f,  355.3731691664f },
    { 132.9321298489f,  203.3679158259f,  355.8976665940f },
    { 132.4726609176f,  203.9742391891f,  356.4332108798f },
    { 132.0100653001f,  204.5927436100f,  356.9805706371f },
    { 131.5442409706f,  205.2236005166f,  357.5406048862f },
    { 131.0750774902f,  205.8669829646f,  358.1142776869f },
    { 130.6024547831f,  206.5230664207f,  358.7026758684f },
    { 130.1262416569f,  207.1920299817f,  359.3070306889f },
    { 129.6462939944f,  207.8740582193f,  359.9287445246f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.894042968750000f,
    0.893041992187500f,
    0.892053222656250f,
    0.891082763671875f,
    0.890130615234375f,
    0.889202880859375f,
    0.888293457031250f,
    0.887408447265625f,
    0.886547851562500f,
    0.885705566406250f,
    0.884887695312500f,
    0.884100341796875f,
    0.883343505859375f,
    0.882592773437500f,
    0.881884765625000f,
    0.881195068359375f,
    0.880529785156250f,
    0.879895019531250f,
    0.879284667968750f,
    0.878686523437500f,
    0.878143310546875f,
    0.877581787109375f,
    0.877050781250000f,
    0.876580810546875f,
    0.876092529296875f,
    0.875585937500000f,
    0.875134277343750f,
    0.874737548828125f,
    0.874395751953125f,
    0.875189208984375f,
    0.877526855468750f,
    0.879656982421875f,
    0.881768798828125f,
    0.883721923828125f,
    0.885595703125000f,
    0.887445068359375f,
    0.889123535156250f,
    0.890808105468750f,
    0.892382812500000f,
    0.893920898437500f,
    0.895416259765625f,
    0.896826171875000f,
    0.898254394531250f,
    0.899554443359375f,
    0.900885009765625f,
    0.902130126953125f,
    0.903369140625000f,
    0.904565429687500f,
    0.905725097656250f,
    0.906878662109375f,
    0.907971191406250f,
    0.909088134765625f,
    0.910113525390625f,
    0.911181640625000f,
    0.912170410156250f,
    0.913183593750000f,
    0.914147949218750f,
    0.915106201171875f,
    0.916058349609375f,
    0.916967773437500f,
    0.917901611328125f,
    0.918774414062500f,
    0.919671630859375f,
    0.920526123046875f,
    0.921380615234375f,
    0.922229003906250f,
    0.923046875000000f,
    0.923889160156250f,
    0.924670410156250f,
    0.925476074218750f,
    0.926263427734375f,
    0.927032470703125f,
    0.927813720703125f,
    0.928558349609375f,
    0.929302978515625f,
    0.930059814453125f,
    0.930761718750000f,
    0.931481933593750f,
    0.932208251953125f,
    0.932885742187500f,
    0.933569335937500f,
    0.934259033203125f,
    0.934924316406250f,
    0.935565185546875f,
    0.936199951171875f,
    0.936828613281250f,
    0.937451171875000f,
    0.938031005859375f,
    0.938598632812500f,
    0.939141845703125f,
    0.939666748046875f,
    0.940167236328125f,
    0.940637207031250f,
    0.941070556640625f,
    0.941461181640625f,
    0.941802978515625f,
    0.942095947265625f,
    0.942315673828125f,
    0.942468261718750f,
    0.942541503906250f,
    0.942486572265625f,
    0.942291259765625f,
    0.941955566406250f,
    0.941418457031250f,
    0.934191894531250f,
    0.915704345703125f,
    0.896704101562500f,
    0.877032470703125f,
    0.873461914062500f,
    0.876330566406250f,
    0.879028320312500f,
    0.881573486328125f,
    0.883984375000000f,
    0.886260986328125f,
    0.888421630859375f,
    0.890472412109375f,
    0.892425537109375f,
    0.894274902343750f,
    0.896032714843750f,
    0.897717285156250f,
    0.899316406250000f,
    0.900842285156250f,
    0.902301025390625f,
    0.903692626953125f,
    0.905017089843750f,
    0.906286621093750f,
    0.907501220703125f,
    0.908660888671875f,
    0.909771728515625f,
    0.910827636718750f,
    0.911840820312500f,
    0.912805175781250f,
    0.913726806640625f,
    0.914599609375000f,
    0.915435791015625f,
    0.916235351562500f,
    0.916986083984375f,
    0.917706298828125f,
    0.918383789062500f,
    0.919018554687500f,
    0.919616699218750f,
    0.920178222656250f,
    0.921429443359375f,
    0.924633789062500f,
    0.927636718750000f,
    0.930456542968750f,
    0.933117675781250f,
    0.935620117187500f,
    0.937988281250000f,
    0.940222167968750f,
    0.942346191406250f,
    0.944354248046875f,
    0.946258544921875f,
    0.948065185546875f,
    0.949786376953125f,
    0.951428222656250f,
    0.952984619140625f,
    0.954461669921875f,
    0.955859375000000f,
    0.957189941406250f,
    0.958453369140625f,
    0.959667968750000f,
    0.960815429687500f,
    0.961914062500000f,
    0.962963867187500f,
    0.963952636718750f,
    0.964892578125000f,
    0.965783691406250f,
    0.966632080078125f,
    0.967437744140625f,
    0.968206787109375f,
    0.968933105468750f,
    0.969622802734375f,
    0.970263671875000f,
    0.970867919921875f,
    0.971435546875000f,
    0.971972656250000f,
    0.972467041015625f,
    0.972937011718750f,
    0.973364257812500f,
    0.973754882812500f,
    0.974108886718750f,
    0.974432373046875f,
    0.974725341796875f,
    0.974981689453125f,
    0.975201416015625f,
    0.975378417968750f,
    0.975524902343750f,
    0.975634765625000f,
    0.975708007812500f,
    0.975738525390625f,
    0.975726318359375f,
    0.975677490234375f,
    0.975585937500000f,
    0.975445556640625f,
    0.981469726562500f,
    0.991290283203125f,
    0.991137695312500f,
    0.990954589843750f,
    0.990771484375000f,
    0.990600585937500f,
    0.990435791015625f,
    0.990264892578125f,
    0.990100097656250f,
    0.989941406250000f,
    0.989776611328125f,
    0.989611816406250f,
    0.989453125000000f,
    0.989294433593750f,
    0.989141845703125f,
    0.988995361328125f,
    0.988848876953125f,
    0.988690185546875f,
    0.988525390625000f,
    0.988372802734375f,
    0.988220214843750f,
    0.988085937500000f,
    0.987933349609375f,
    0.987774658203125f,
    0.987628173828125f,
    0.987487792968750f,
    0.987341308593750f,
    0.987182617187500f,
    0.987042236328125f,
    0.986907958984375f,
    0.986749267578125f,
    0.986596679687500f,
    0.986468505859375f,
    0.986309814453125f,
    0.986157226562500f,
    0.986029052734375f,
    0.985870361328125f,
    0.985717773437500f,
    0.985589599609375f,
    0.985424804687500f,
    0.985272216796875f,
    0.985131835937500f,
    0.984973144531250f,
    0.984826660156250f,
    0.984674072265625f,
    0.984509277343750f,
    0.984368896484375f,
    0.984204101562500f,
    0.984045410156250f,
    0.983892822265625f,
    0.983721923828125f,
    0.983569335937500f,
    0.983398437500000f,
    0.983227539062500f,
    0.983068847656250f,
    0.982885742187500f,
    0.982714843750000f,
    0.982537841796875f,
    0.982354736328125f,
    0.982189941406250f,
    0.981988525390625f,
    0.981805419921875f,
    0.981616210937500f,
    0.981408691406250f,
    0.981225585937500f,
    0.981011962890625f,
    0.980804443359375f,
    0.980609130859375f,
    0.980377197265625f,
    0.980157470703125f,
    0.979937744140625f,
    0.979693603515625f,
    0.979467773437500f,
    0.979217529296875f,
    0.978961181640625f,
    0.978723144531250f,
    0.978442382812500f,
    0.978167724609375f,
    0.977911376953125f,
    0.977606201171875f,
    0.977307128906250f,
    0.977026367187500f,
    0.977038574218750f,
    0.977111816406250f,
    0.977130126953125f,
    0.977203369140625f,
    0.977221679687500f,
    0.977294921875000f,
    0.977313232421875f,
    0.977386474609375f,
    0.977404785156250f,
    0.977465820312500f,
    0.977496337890625f,
    0.977551269531250f,
    0.977593994140625f,
    0.977636718750000f,
    0.977691650390625f,
    0.977722167968750f,
    0.977789306640625f,
    0.977819824218750f,
    0.977868652343750f,
    0.977929687500000f,
    0.977960205078125f,
    0.978009033203125f,
    0.978063964843750f,
    0.978100585937500f,
    0.978155517578125f,
    0.978216552734375f,
    0.978253173828125f,
    0.978302001953125f,
    0.978356933593750f,
    0.978424072265625f,
    0.978460693359375f,
    0.978509521484375f,
    0.978564453125000f,
    0.978619384765625f,
    0.978680419921875f,
    0.978735351562500f,
    0.978796386718750f,
    0.978857421875000f,
    0.978918457031250f,
    0.978973388671875f,
    0.979034423828125f,
    0.979089355468750f,
    0.979156494140625f,
    0.979223632812500f,
    0.979296875000000f,
    0.979357910156250f,
    0.979425048828125f,
    0.979504394531250f,
    0.979571533203125f,
    0.979650878906250f,
    0.979724121093750f,
    0.979809570312500f,
    0.979882812500000f,
    0.979962158203125f,
    0.980047607421875f,
    0.969848632812500f,
    0.957543945312500f,
    0.945434570312500f,
    0.933477783203125f,
    0.921643066406250f,
    0.918841552734375f,
    0.917797851562500f,
    0.916748046875000f,
    0.915679931640625f,
    0.914605712890625f,
    0.913525390625000f,
    0.912432861328125f,
    0.911340332031250f,
    0.910241699218750f,
    0.909143066406250f,
    0.908038330078125f,
    0.906933593750000f,
    0.905828857421875f,
    0.904724121093750f,
    0.903625488281250f,
    0.902526855468750f,
    0.901434326171875f,
    0.900347900390625f,
    0.899273681640625f,
    0.898205566406250f,
    0.897143554687500f,
    0.896099853515625f,
    0.895068359375000f
};

#include "hellwig_lib_rc1.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1 = clamp3(AP1, 0.0f, 16384.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in.x = ST2084_to_linear(in.x) / referenceLuminance;
        in.y = ST2084_to_linear(in.y) / referenceLuminance;
        in.z = ST2084_to_linear(in.z) / referenceLuminance;
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-peak
            if (hardClip)
            {
                out = clamp3(referenceLuminance * out, 0.0f, daniele_n);
            }
            else
            {
                out *= referenceLuminance;
            }
            
            if (asPQ)
            {
                out = vector_dot(P3D65_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out / referenceLuminance, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}