// DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)

__CONSTANT__ int toneCurve = 1;
__CONSTANT__ int compressChroma = 1;
__CONSTANT__ int gamutCompress = 1;
__CONSTANT__ int d60Sim = 0;
__CONSTANT__ int asPQ = 0;
__CONSTANT__ int ap1Clip = 1;
__CONSTANT__ int softClip = 0;
__CONSTANT__ int hardClip = 1;
__CONSTANT__ int invert = 0;
__CONSTANT__ int JMhOut = 0;

typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to sRGB matrix
    {  3.2409699419f, -1.5373831776f, -0.4986107603f},
    { -0.9692436363f,  1.8759675015f,  0.0415550574f},
    {  0.0556300797f, -0.2039769589f,  1.0569715142f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// sRGB to XYZ matrix
    {  0.4123907993f,  0.3575843394f,  0.1804807884f},
    {  0.2126390059f,  0.7151686788f,  0.0721923154f},
    {  0.0193308187f,  0.1191947798f,  0.9505321522f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_709D60 =
{
    {  0.4318156527f,  0.3556330533f,  0.1651973686f},
    {  0.2226549459f,  0.7112661067f,  0.0660789474f},
    {  0.0202413587f,  0.1185443511f,  0.8700394745f}
};

__CONSTANT__ float3x3 BT709_to_BT2020 =
{
    {  0.6274038959f, 0.3292830384f, 0.0433130657f},
    {  0.0690972894f, 0.9195403951f, 0.0113623156f},
    {  0.0163914389f, 0.0880133079f, 0.8955952532f}
};

__CONSTANT__ float limitJmax = 100.0f;
__CONSTANT__ float midJ = 34.0965348204f; // ~10 nits in Hellwig J
__CONSTANT__ float focusDist = 1.35f;

__CONSTANT__ float daniele_n = 100.0f; // peak white
__CONSTANT__ float daniele_m_2 = 1.0471037624f;
__CONSTANT__ float daniele_s_2 = 0.9198582542f;
__CONSTANT__ float daniele_u_2 = 0.9917990155f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float compr = 2.4f;
__CONSTANT__ float sat = 1.3f;
__CONSTANT__ float sat_thr = 0.005f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 54.0476312661f,  68.7457035890f,  0.7302962138f },
    { 53.7691170740f,  68.9407685377f,  1.7567935919f },
    { 53.4880853747f,  69.1494734731f,  2.8242870469f },
    { 53.2044046647f,  69.3730047674f,  3.9374311870f },
    { 52.9179234646f,  69.6127963030f,  5.1018093950f },
    { 52.6284648940f,  69.8706117438f,  6.3242025306f },
    { 52.3358191093f,  70.1486633341f,  7.6129643561f },
    { 52.0397324679f,  70.4497881332f,  8.9785600992f },
    { 51.7398914984f,  70.7777178630f,  10.4343634678f },
    { 51.4358982588f,  71.1375080217f,  11.9978809261f },
    { 51.1272306587f,  71.5362524286f,  13.6927197411f },
    { 50.8131747716f,  71.9843434267f,  15.5519364488f },
    { 50.4927004891f,  72.4978649845f,  17.6241658168f },
    { 50.1642093141f,  73.1036108822f,  19.9859936968f },
    { 49.8249456432f,  73.8512035088f,  22.7706695319f },
    { 49.4692848038f,  74.8496205424f,  26.2509880110f },
    { 50.5589209905f,  71.6861436289f,  27.8759787296f },
    { 51.6166013311f,  68.8219544726f,  29.5321198974f },
    { 52.6452577831f,  66.2217783384f,  31.2185777347f },
    { 53.6473649041f,  63.8567031116f,  32.9341114709f },
    { 54.6250375939f,  61.7027075000f,  34.6770971641f },
    { 55.5801030918f,  59.7395856345f,  36.4455495148f },
    { 56.5141551167f,  57.9501457020f,  38.2371444816f },
    { 57.4285953219f,  56.3196025745f,  40.0492445790f },
    { 58.3246655507f,  54.8351107491f,  41.8789280436f },
    { 59.2034732940f,  53.4854007561f,  43.7230224765f },
    { 60.0660120434f,  52.2604932410f,  45.5781430821f },
    { 60.9131777508f,  51.1514723109f,  47.4407351852f },
    { 61.7457822796f,  50.1503047688f,  49.3071203385f },
    { 62.5645645022f,  49.2496953455f,  51.1735450237f },
    { 63.3701995360f,  48.4429704827f,  53.0362307203f },
    { 64.1633064905f,  47.7239849640f,  54.8914239755f },
    { 64.9444550138f,  47.0870469406f,  56.7354450589f },
    { 65.7141708616f,  46.5268578245f,  58.5647338317f },
    { 66.4729406649f,  46.0384642004f,  60.3758915886f },
    { 67.2212160341f,  45.6172194343f,  62.1657178300f },
    { 67.9594171122f,  45.2587530614f,  63.9312411755f },
    { 68.6879356653f,  44.9589463641f,  65.6697439104f },
    { 69.4071377843f,  44.7139128199f,  67.3787799436f },
    { 70.1173662555f,  44.5199823238f,  69.0561862324f },
    { 70.8189426511f,  44.3736882877f,  70.7000879707f },
    { 71.5121691785f,  44.2717568822f,  72.3088980392f },
    { 72.1973303219f,  44.2110978348f,  73.8813113652f },
    { 72.8746943059f,  44.1887963235f,  75.4162949391f },
    { 73.5445144031f,  44.2021056114f,  76.9130742828f },
    { 74.2070301067f,  44.2484401580f,  78.3711171700f },
    { 74.8624681847f,  44.3253690203f,  79.7901153666f },
    { 75.5110436309f,  44.4306094134f,  81.1699651012f },
    { 76.1529605236f,  44.5620203534f,  82.5107468960f },
    { 76.7884128047f,  44.7175963378f,  83.8127053015f },
    { 77.4175849866f,  44.8954610497f,  85.0762289830f },
    { 78.0406527959f,  45.0938610871f,  86.3018315163f },
    { 78.6577837607f,  45.3111597376f,  87.4901331656f },
    { 79.2691377475f,  45.5458308187f,  88.6418438342f },
    { 79.8748674526f,  45.7964526150f,  89.7577473170f },
    { 80.4751188529f,  46.0617019377f,  90.8386869185f },
    { 81.0700316208f,  46.3403483359f,  91.8855524609f },
    { 81.6597395056f,  46.6312484824f,  92.8992686627f },
    { 82.2443706857f,  46.9333407554f,  93.8807848434f },
    { 82.8240480933f,  47.2456400314f,  94.8310658889f },
    { 83.3988897154f,  47.5672327040f,  95.7510843956f },
    { 83.9690088722f,  47.8972719358f,  96.6418139067f },
    { 84.5345144758f,  48.2349731478f,  97.5042231447f },
    { 85.0955112696f,  48.5796097509f,  98.3392711479f },
    { 85.6521000520f,  48.9305091147f,  99.1479032180f },
    { 86.2043778843f,  49.2870487740f,  99.9310475897f },
    { 86.7524382839f,  49.6486528647f,  100.6896127386f },
    { 87.2963714061f,  50.0147887841f,  101.4244852499f },
    { 87.8362642124f,  50.3849640671f,  102.1365281743f },
    { 88.3722006287f,  50.7587234683f,  102.8265798088f },
    { 88.9042616940f,  51.1356462423f,  103.4954528387f },
    { 89.4325256982f,  51.5153436106f,  104.1439337925f },
    { 89.9570683133f,  51.8974564061f,  104.7727827591f },
    { 90.4779627151f,  52.2816528843f,  105.3827333265f },
    { 90.9952796984f,  52.6676266915f,  105.9744927062f },
    { 91.5090877851f,  53.0550949807f,  106.5487420094f },
    { 91.3144320984f,  53.0913279567f,  107.1148894226f },
    { 91.1192381938f,  53.1331590370f,  107.6830560919f },
    { 90.9235016813f,  53.1806597269f,  108.2531419231f },
    { 90.7272181094f,  53.2339010806f,  108.8250446632f },
    { 90.5303829644f,  53.2929536660f,  109.3986599968f },
    { 90.3329916689f,  53.3578875288f,  109.9738816490f },
    { 90.1350395804f,  53.4287721592f,  110.5506014931f },
    { 89.9365219905f,  53.5056764592f,  111.1287096638f },
    { 89.7374341228f,  53.5886687115f,  111.7080946759f },
    { 89.5377711323f,  53.6778165508f,  112.2886435470f },
    { 89.3375281034f,  53.7731869358f,  112.8702419253f },
    { 89.1367000487f,  53.8748461240f,  113.4527742210f },
    { 88.9352819076f,  53.9828596477f,  114.0361237419f },
    { 88.7332685443f,  54.0972922931f,  114.6201728319f },
    { 88.5306547470f,  54.2182080808f,  115.2048030129f },
    { 88.3274352255f,  54.3456702487f,  115.7898951288f },
    { 88.1236046099f,  54.4797412382f,  116.3753294920f },
    { 87.9191574491f,  54.6204826816f,  116.9609860313f },
    { 87.7140882087f,  54.7679553932f,  117.5467444413f },
    { 87.5083912691f,  54.9222193623f,  118.1324843321f },
    { 87.3020609240f,  55.0833337497f,  118.7180853798f },
    { 87.0950913785f,  55.2513568859f,  119.3034274765f },
    { 86.8874767468f,  55.4263462732f,  119.8883908798f },
    { 86.6792110502f,  55.6083585904f,  120.4728563611f },
    { 86.4702882154f,  55.7974496996f,  121.0567053523f },
    { 86.2607020722f,  55.9936746572f,  121.6398200909f },
    { 86.0504463509f,  56.1970877268f,  122.2220837621f },
    { 85.8395146807f,  56.4077423955f,  122.8033806383f },
    { 85.6279005869f,  56.6256913934f,  123.3835962156f },
    { 85.4155974884f,  56.8509867153f,  123.9626173463f },
    { 85.2025986959f,  57.0836796460f,  124.5403323674f },
    { 84.9888974085f,  57.3238207881f,  125.1166312248f },
    { 84.7744867116f,  57.5714600930f,  125.6914055933f },
    { 84.5593595741f,  57.8266468940f,  126.2645489906f },
    { 84.3435088455f,  58.0894299436f,  126.8359568873f },
    { 84.1269272531f,  58.3598574517f,  127.4055268103f },
    { 83.9096073990f,  58.6379771278f,  127.9731584414f },
    { 83.6915417571f,  58.9238362257f,  128.5387537093f },
    { 83.4727226697f,  59.2174815900f,  129.1022168763f },
    { 83.2531423446f,  59.5189597059f,  129.6634546180f },
    { 83.0327928516f,  59.8283167510f,  130.2223760979f },
    { 82.8116661186f,  60.1455986496f,  130.7788930343f },
    { 82.5897539287f,  60.4708511293f,  131.3329197617f },
    { 82.3670479162f,  60.8041197799f,  131.8843732860f },
    { 82.1435395625f,  61.1454501141f,  132.4331733326f },
    { 81.9192201924f,  61.4948876308f,  132.9792423888f },
    { 81.6940809702f,  61.8524778798f,  133.5225057396f },
    { 81.4681128949f,  62.2182665295f,  134.0628914973f },
    { 81.2413067964f,  62.5922994351f,  134.6003306255f },
    { 81.0136533307f,  62.9746227096f,  135.1347569562f },
    { 80.7851429751f,  63.3652827967f,  135.6661072025f },
    { 80.5557660235f,  63.7643265444f,  136.1943209641f },
    { 80.3255125816f,  64.1718012815f,  136.7193407285f },
    { 80.0943725611f,  64.5877548950f,  137.2411118668f },
    { 79.8623356748f,  65.0122359095f,  137.7595826234f },
    { 79.6293914311f,  65.4452935676f,  138.2747041024f },
    { 79.3955291276f,  65.8869779129f,  138.7864302483f },
    { 79.1607378459f,  66.3373398734f,  139.2947178228f },
    { 78.9250064446f,  66.7964313474f,  139.7995263770f },
    { 78.6883235535f,  67.2643052902f,  140.3008182205f },
    { 78.8779102686f,  65.5148677671f,  141.1419715447f },
    { 79.0653783907f,  63.8818132600f,  141.9770169091f },
    { 79.2509615679f,  62.3503752585f,  142.8082292689f },
    { 79.4348474888f,  60.9087314985f,  143.6374326247f },
    { 79.6171896363f,  59.5472511055f,  144.4661133148f },
    { 79.7981154493f,  58.2579716696f,  145.2954984222f },
    { 79.9777321471f,  57.0342259911f,  146.1266114760f },
    { 80.1561309843f,  55.8703693385f,  146.9603129075f },
    { 80.3333904225f,  54.7615760476f,  147.7973299931f },
    { 80.5095785373f,  53.7036850917f,  148.6382793760f },
    { 80.6847548746f,  52.6930809557f,  149.4836842438f },
    { 80.8589719013f,  51.7266004339f,  150.3339875884f },
    { 81.0322761547f,  50.8014587744f,  151.1895625475f },
    { 81.2047091627f,  49.9151904762f,  152.0507205461f },
    { 81.3763081882f,  49.0656013313f,  152.9177177564f },
    { 81.5471068376f,  48.2507292017f,  153.7907602641f },
    { 81.7171355622f,  47.4688116568f,  154.6700082292f },
    { 81.8864220740f,  46.7182590520f,  155.5555792625f },
    { 82.0549916937f,  45.9976319650f,  156.4475511887f },
    { 82.2228676445f,  45.3056221515f,  157.3459643291f },
    { 82.3900713001f,  44.6410363654f,  158.2508234097f },
    { 82.5566223962f,  44.0027825293f,  159.1620991808f },
    { 82.7225392127f,  43.3898578456f,  160.0797298143f },
    { 82.8878387294f,  42.8013385228f,  161.0036221390f },
    { 83.0525367616f,  42.2363708514f,  161.9336527563f },
    { 83.2166480775f,  41.6941634182f,  162.8696690786f },
    { 83.3801865009f,  41.1739802825f,  163.8114903199f },
    { 83.5431650013f,  40.6751349746f,  164.7589084679f },
    { 83.7055957729f,  40.1969851947f,  165.7116892583f },
    { 83.8674903045f,  39.7389281193f,  166.6695731722f },
    { 84.0288594414f,  39.3003962294f,  167.6322764691f },
    { 84.1897134404f,  38.8808535966f,  168.5994922702f },
    { 84.3500620187f,  38.4797925674f,  169.5708917002f },
    { 84.5099143979f,  38.0967307985f,  170.5461250949f },
    { 84.6692793432f,  37.7312086035f,  171.5248232782f },
    { 84.8281651985f,  37.3827865743f,  172.5065989123f },
    { 84.9865799184f,  37.0510434494f,  173.4910479192f },
    { 85.1445310967f,  36.7355742036f,  174.4777509730f },
    { 85.3020259928f,  36.4359883356f,  175.4662750585f },
    { 85.4590715546f,  36.1519083371f,  176.4561750903f },
    { 85.6156744404f,  35.8829683243f,  177.4469955863f },
    { 85.7718410384f,  35.6288128184f,  178.4382723857f },
    { 85.9275774841f,  35.3890956633f,  179.4295344026f },
    { 86.0828896770f,  35.1634790655f,  180.4203054047f },
    { 86.2377832955f,  34.9516327504f,  181.4101058053f },
    { 86.3922638100f,  34.7532332215f,  182.3984544554f },
    { 86.5463364964f,  34.5679631160f,  183.3848704261f },
    { 86.7000064466f,  34.3955106485f,  184.3688747660f },
    { 86.8532785802f,  34.2355691352f,  185.3499922229f },
    { 87.0061576535f,  34.0878365913f,  186.3277529169f },
    { 87.1586482691f,  33.9520153958f,  187.3016939538f },
    { 87.3107548843f,  33.8278120169f,  188.2713609673f },
    { 87.4624818185f,  33.7149367927f,  189.2363095804f },
    { 87.6138332611f,  33.6131037609f,  190.1961067776f },
    { 87.7648132775f,  33.5220305334f,  191.1503321780f },
    { 87.9154258162f,  33.4414382090f,  192.0985792054f },
    { 88.0656747139f,  33.3710513218f,  193.0404561479f },
    { 88.2155637015f,  33.3105978185f,  193.9755871037f },
    { 88.3650964087f,  33.2598090619f,  194.9036128112f },
    { 88.5142763692f,  33.2184198562f,  195.8241913603f },
    { 87.9773221667f,  32.9658997506f,  196.7526941598f },
    { 87.4364100700f,  32.7199119689f,  197.7044875044f },
    { 86.8914574610f,  32.4808697726f,  198.6799817203f },
    { 86.3423788320f,  32.2492053184f,  199.6795585722f },
    { 85.7890856419f,  32.0253699955f,  200.7035663255f },
    { 85.2314861647f,  31.8098346906f,  201.7523144691f },
    { 84.6694853268f,  31.6030899701f,  202.8260681201f },
    { 84.1029845341f,  31.4056461671f,  203.9250421403f },
    { 83.5318814875f,  31.2180333629f,  205.0493950061f },
    { 82.9560699859f,  31.0408012507f,  206.1992224877f },
    { 82.3754397149f,  30.8745188707f,  207.3745512052f },
    { 81.7898760212f,  30.7197742068f,  208.5753321448f },
    { 81.1992596710f,  30.5771736369f,  209.8014342351f },
    { 80.6034665901f,  30.4473412290f,  211.0526380953f },
    { 80.0023675856f,  30.3309178806f,  212.3286300843f },
    { 79.3958280460f,  30.2285602983f,  213.6289967923f },
    { 78.7837076191f,  30.1409398225f,  214.9532201264f },
    { 78.1658598642f,  30.0687411027f,  216.3006731508f },
    { 77.5421318772f,  30.0126606348f,  217.6706168459f },
    { 76.9123638855f,  29.9734051792f,  219.0621979485f },
    { 76.2763888097f,  29.9516900802f,  220.4744480314f },
    { 75.6340317885f,  29.9482375174f,  221.9062839641f },
    { 74.9851096636f,  29.9637747216f,  223.3565098802f },
    { 74.3294304200f,  29.9990321980f,  224.8238207481f },
    { 73.6667925762f,  30.0547420000f,  226.3068076102f },
    { 72.9969845205f,  30.1316361065f,  227.8039645163f },
    { 72.3197837853f,  30.2304449563f,  229.3136971335f },
    { 71.6349562542f,  30.3518961990f,  230.8343329694f },
    { 70.9422552928f,  30.4967137209f,  232.3641330964f },
    { 70.2414207942f,  30.6656170088f,  233.9013052205f },
    { 69.5321781295f,  30.8593209122f,  235.4440178925f },
    { 68.8142369905f,  31.0785358636f,  236.9904156247f },
    { 68.0872901120f,  31.3239686152f,  238.5386346448f },
    { 67.3510118564f,  31.5963235475f,  240.0868190008f },
    { 66.6050566437f,  31.8963046022f,  241.6331367192f },
    { 65.8490572046f,  32.2246178903f,  243.1757957246f },
    { 65.0826226323f,  32.5819750241f,  244.7130592394f },
    { 64.3053362041f,  32.9690972229f,  246.2432604101f },
    { 63.5167529378f,  33.3867202421f,  247.7648159404f },
    { 62.7163968434f,  33.8356001834f,  249.2762385531f },
    { 61.9037578217f,  34.3165202515f,  250.7761481555f },
    { 61.0782881539f,  34.8302985338f,  252.2632816305f },
    { 60.2393985122f,  35.3777969032f,  253.7365012379f },
    { 59.3864534114f,  35.9599311654f,  255.1948016606f },
    { 58.5187660015f,  36.5776826093f,  256.6373157884f },
    { 57.6355920814f,  37.2321111626f,  258.0633193855f },
    { 56.7361231861f,  37.9243704122f,  259.4722348389f },
    { 55.8194785660f,  38.6557248261f,  260.8636342357f },
    { 54.8846958351f,  39.4275696041f,  262.2372420710f },
    { 53.9307200050f,  40.2414537175f,  263.5929379423f },
    { 52.9563905541f,  41.0991068530f,  264.9307596498f },
    { 51.9604260825f,  42.0024711988f,  266.2509072044f },
    { 50.9414059781f,  42.9537392944f,  267.5537483408f },
    { 49.8977483526f,  43.9553995592f,  268.8398262787f },
    { 48.8276832751f,  45.0102916460f,  270.1098706636f },
    { 47.7292200189f,  46.1216745143f,  271.3648128979f },
    { 46.6001066018f,  47.2933111690f,  272.6058074785f },
    { 45.4377792809f,  48.5295755279f,  273.8342615512f },
    { 44.2392987797f,  49.8355891055f,  275.0518757960f },
    { 43.0012687249f,  51.2173985358f,  276.2607011365f },
    { 43.4868077334f,  50.9581013710f,  278.0199299140f },
    { 43.9652373389f,  50.7470887301f,  279.7477740937f },
    { 44.4368635595f,  50.5812705087f,  281.4431590554f },
    { 44.9019706672f,  50.4577321889f,  283.1051826347f },
    { 45.3608233076f,  50.3737241688f,  284.7331128788f },
    { 45.8136683601f,  50.3266524436f,  286.3263833214f },
    { 46.2607365770f,  50.3140703222f,  287.8845861942f },
    { 46.7022440328f,  50.3336709328f,  289.4074639903f },
    { 47.1383934095f,  50.3832803306f,  290.8948997763f },
    { 47.5693751405f,  50.4608510618f,  292.3469066224f },
    { 47.9953684312f,  50.5644560811f,  293.7636164830f },
    { 48.4165421731f,  50.6922829456f,  295.1452688206f },
    { 48.8330557628f,  50.8426282338f,  296.4921992243f },
    { 49.2450598406f,  51.0138921547f,  297.8048282303f },
    { 49.6526969550f,  51.2045733262f,  299.0836505123f },
    { 50.0561021644f,  51.4132637115f,  300.3292245701f },
    { 50.4554035821f,  51.6386437087f,  301.5421630135f },
    { 50.8507228707f,  51.8794773946f,  302.7231235039f },
    { 51.2421756926f,  52.1346079234f,  303.8728003943f },
    { 51.6298721200f,  52.4029530861f,  304.9919170847f },
    { 52.0139170101f,  52.6835010338f,  306.0812190909f },
    { 52.3944103476f,  52.9753061685f,  307.1414678139f },
    { 52.7714475594f,  53.2774852067f,  308.1734349836f },
    { 53.1451198028f,  53.5892134143f,  309.1778977436f },
    { 53.5155142314f,  53.9097210176f,  310.1556343388f },
    { 53.8827142393f,  54.2382897875f,  311.1074203629f },
    { 54.2467996864f,  54.5742497963f,  312.0340255226f },
    { 54.6078471069f,  54.9169763455f,  312.9362108748f },
    { 54.9659299023f,  55.2658870596f,  313.8147264911f },
    { 55.3211185192f,  55.6204391432f,  314.6703095103f },
    { 55.6734806154f,  55.9801267951f,  315.5036825350f },
    { 56.0230812135f,  56.3444787752f,  316.3155523386f },
    { 56.3699828436f,  56.7130561178f,  317.1066088426f },
    { 56.7142456769f,  57.0854499847f,  317.8775243363f },
    { 57.0559276493f,  57.4612796528f,  318.6289529042f },
    { 57.3950845770f,  57.8401906283f,  319.3615300377f },
    { 57.7317702652f,  58.2218528828f,  320.0758724041f },
    { 58.0660366086f,  58.6059592031f,  320.7725777510f },
    { 58.3979336861f,  58.9922236499f,  321.4522249276f },
    { 58.7275098495f,  59.3803801173f,  322.1153740029f },
    { 59.0548118066f,  59.7701809900f,  322.7625664665f },
    { 59.3798846990f,  60.1613958890f,  323.3943254990f },
    { 59.7027721755f,  60.5538105027f,  324.0111562967f },
    { 60.0235164612f,  60.9472254975f,  324.6135464437f },
    { 60.3421584218f,  61.3414555018f,  325.2019663193f },
    { 60.6587376252f,  61.7363281602f,  325.7768695334f },
    { 60.9732923987f,  62.1316832517f,  326.3386933841f },
    { 61.2858598835f,  62.5273718690f,  326.8878593289f },
    { 61.5964760857f,  62.9232556538f,  327.4247734671f },
    { 61.9051759251f,  63.3192060851f,  327.9498270274f },
    { 62.2119932808f,  63.7151038159f,  328.4633968567f },
    { 62.5169610342f,  64.1108380558f,  328.9658459088f },
    { 62.8201111106f,  64.5063059965f,  329.4575237279f },
    { 63.1214745176f,  64.9014122761f,  329.9387669267f },
    { 63.4210813823f,  65.2960684806f,  330.4098996565f },
    { 63.7189609859f,  65.6901926793f,  330.8712340676f },
    { 64.0151417969f,  66.0837089924f,  331.3230707599f },
    { 64.3096515030f,  66.4765471882f,  331.7656992212f },
    { 64.6025170405f,  66.8686423068f,  332.1993982542f },
    { 64.8937646232f,  67.2599343111f,  332.6244363906f },
    { 64.6787420048f,  67.2029959907f,  333.0469446806f },
    { 64.4628010335f,  67.1485064676f,  333.4752206330f },
    { 64.2459291088f,  67.0965404660f,  333.9093880280f },
    { 64.0281132978f,  67.0471750515f,  334.3495753081f },
    { 63.8093403211f,  67.0004897219f,  334.7959158824f },
    { 63.5895965369f,  66.9565665029f,  335.2485484586f },
    { 63.3688679257f,  66.9154900500f,  335.7076174051f },
    { 63.1471400725f,  66.8773477560f,  336.1732731478f },
    { 62.9243981486f,  66.8422298660f,  336.6456726041f },
    { 62.7006268918f,  66.8102295990f,  337.1249796591f },
    { 62.4758105857f,  66.7814432796f,  337.6113656889f },
    { 62.2499330368f,  66.7559704769f,  338.1050101365f },
    { 62.0229775501f,  66.7339141556f,  338.6061011457f },
    { 61.7949269035f,  66.7153808375f,  339.1148362620f },
    { 61.5657633194f,  66.7004807769f,  339.6314232067f },
    { 61.3354684341f,  66.6893281498f,  340.1560807347f },
    { 61.1040232653f,  66.6820412605f,  340.6890395870f },
    { 60.8714081763f,  66.6787427665f,  341.2305435487f },
    { 60.6376028370f,  66.6795599250f,  341.7808506287f },
    { 60.4025861820f,  66.6846248637f,  342.3402343764f },
    { 60.1663363644f,  66.6940748805f,  342.9089853549f },
    { 59.9288307049f,  66.7080527745f,  343.4874127927f },
    { 59.6900456371f,  66.7267072153f,  344.0758464412f },
    { 59.4499566455f,  66.7501931562f,  344.6746386667f },
    { 59.2085381989f,  66.7786722976f,  345.2841668147f },
    { 58.9657636752f,  66.8123136109f,  345.9048358882f },
    { 58.7216052782f,  66.8512939331f,  346.5370815911f },
    { 58.4760339455f,  66.8957986441f,  347.1813737964f },
    { 58.2290192440f,  66.9460224446f,  347.8382205123f },
    { 57.9805292535f,  67.0021702526f,  348.5081724322f },
    { 57.7305304347f,  67.0644582426f,  349.1918281757f },
    { 57.4789874800f,  67.1331150590f,  349.8898403463f },
    { 57.2258631424f,  67.2083832402f,  350.6029225647f },
    { 56.9711180408f,  67.2905208998f,  351.3318576702f },
    { 56.7147104342f,  67.3798037275f,  352.0775073295f },
    { 56.4565959619f,  67.4765273836f,  352.8408233524f },
    { 56.1967273383f,  67.5810103868f,  353.6228610916f },
    { 55.9350539967f,  67.6935976234f,  354.4247954025f },
    { 55.6715216664f,  67.8146646448f,  355.2479397767f },
    { 55.4060718703f,  67.9446229739f,  356.0937694380f },
    { 55.1386413191f,  68.0839267181f,  356.9639494330f },
    { 54.8691611789f,  68.2330808861f,  357.8603690793f },
    { 54.5975561716f,  68.3926519555f,  358.7851845913f },
    { 54.3237434626f,  68.5632814499f,  359.7408723507f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    166.785f,
    168.475f,
    170.129f,
    171.753f,
    173.340f,
    174.878f,
    176.367f,
    177.802f,
    179.181f,
    180.505f,
    181.763f,
    182.965f,
    184.106f,
    185.187f,
    186.212f,
    187.177f,
    188.086f,
    188.947f,
    189.758f,
    190.527f,
    191.254f,
    191.949f,
    192.615f,
    193.250f,
    193.872f,
    194.360f,
    187.091f,
    180.402f,
    174.237f,
    168.524f,
    163.226f,
    158.301f,
    153.711f,
    149.426f,
    145.416f,
    141.663f,
    138.135f,
    134.821f,
    131.702f,
    128.766f,
    125.995f,
    123.376f,
    120.898f,
    118.555f,
    116.339f,
    114.233f,
    112.244f,
    110.345f,
    108.551f,
    106.842f,
    105.219f,
    103.680f,
    102.209f,
    100.818f,
    99.487f,
    98.224f,
    97.021f,
    95.874f,
    94.781f,
    93.744f,
    92.761f,
    91.821f,
    90.930f,
    90.082f,
    89.276f,
    88.513f,
    87.787f,
    87.103f,
    86.450f,
    85.840f,
    85.260f,
    84.711f,
    84.198f,
    83.716f,
    83.264f,
    82.843f,
    82.452f,
    82.086f,
    81.750f,
    81.445f,
    81.165f,
    80.908f,
    80.682f,
    80.481f,
    80.304f,
    80.151f,
    80.023f,
    79.919f,
    79.840f,
    79.791f,
    79.761f,
    79.755f,
    79.773f,
    79.816f,
    79.889f,
    79.980f,
    80.096f,
    80.243f,
    80.408f,
    80.603f,
    80.817f,
    81.061f,
    81.335f,
    81.635f,
    81.958f,
    82.312f,
    82.690f,
    83.099f,
    83.539f,
    84.009f,
    84.509f,
    85.046f,
    85.614f,
    86.212f,
    86.847f,
    87.518f,
    88.226f,
    88.977f,
    89.764f,
    90.601f,
    91.473f,
    92.395f,
    93.359f,
    94.379f,
    95.447f,
    96.570f,
    97.748f,
    98.993f,
    100.293f,
    101.660f,
    103.101f,
    104.614f,
    106.201f,
    107.880f,
    109.637f,
    111.493f,
    113.446f,
    115.503f,
    117.670f,
    119.965f,
    122.382f,
    124.939f,
    127.649f,
    130.518f,
    133.563f,
    136.792f,
    140.222f,
    143.878f,
    141.687f,
    138.110f,
    134.729f,
    131.525f,
    128.491f,
    125.616f,
    122.888f,
    120.300f,
    117.841f,
    115.497f,
    113.269f,
    111.151f,
    109.131f,
    107.202f,
    105.371f,
    103.619f,
    101.947f,
    100.354f,
    98.828f,
    97.375f,
    95.984f,
    94.659f,
    93.390f,
    92.175f,
    91.016f,
    89.911f,
    88.849f,
    87.836f,
    86.871f,
    85.950f,
    85.065f,
    84.222f,
    83.417f,
    82.654f,
    81.921f,
    81.226f,
    80.560f,
    79.926f,
    79.327f,
    78.754f,
    78.217f,
    77.698f,
    77.216f,
    76.758f,
    76.324f,
    75.916f,
    75.537f,
    75.177f,
    74.847f,
    74.536f,
    74.249f,
    73.987f,
    73.743f,
    73.523f,
    73.328f,
    73.151f,
    72.992f,
    72.858f,
    72.742f,
    72.650f,
    72.577f,
    72.522f,
    72.491f,
    72.479f,
    72.485f,
    72.516f,
    72.565f,
    72.632f,
    72.717f,
    72.827f,
    72.961f,
    73.108f,
    73.279f,
    73.474f,
    73.688f,
    73.926f,
    74.182f,
    74.463f,
    74.768f,
    75.092f,
    75.446f,
    75.818f,
    76.215f,
    76.642f,
    77.094f,
    77.570f,
    78.070f,
    78.601f,
    79.163f,
    79.749f,
    80.371f,
    81.024f,
    81.708f,
    82.422f,
    83.173f,
    83.960f,
    84.784f,
    85.645f,
    86.548f,
    87.488f,
    88.477f,
    89.508f,
    90.588f,
    91.711f,
    92.889f,
    94.122f,
    95.404f,
    96.747f,
    98.157f,
    99.622f,
    101.154f,
    102.759f,
    104.437f,
    106.195f,
    108.032f,
    109.949f,
    111.963f,
    114.069f,
    116.272f,
    118.585f,
    121.002f,
    120.929f,
    119.934f,
    118.988f,
    118.085f,
    117.230f,
    116.418f,
    115.643f,
    114.911f,
    114.221f,
    113.568f,
    112.952f,
    112.372f,
    111.823f,
    111.316f,
    110.840f,
    110.394f,
    109.985f,
    109.607f,
    109.265f,
    108.948f,
    108.661f,
    108.411f,
    108.185f,
    107.990f,
    107.825f,
    107.684f,
    107.581f,
    107.501f,
    107.446f,
    107.422f,
    107.428f,
    107.458f,
    107.520f,
    107.611f,
    107.727f,
    107.874f,
    108.044f,
    108.246f,
    108.472f,
    108.728f,
    109.015f,
    109.332f,
    109.674f,
    110.046f,
    110.449f,
    110.883f,
    111.346f,
    111.841f,
    112.366f,
    112.921f,
    113.507f,
    114.124f,
    114.777f,
    115.460f,
    116.180f,
    116.931f,
    117.719f,
    118.536f,
    119.397f,
    120.288f,
    121.216f,
    122.186f,
    123.187f,
    124.225f,
    125.305f,
    126.422f,
    127.582f,
    128.772f,
    130.005f,
    131.281f,
    132.593f,
    133.942f,
    135.327f,
    136.755f,
    138.220f,
    139.722f,
    141.254f,
    142.822f,
    144.421f,
    146.057f,
    147.711f,
    149.396f,
    151.099f,
    152.826f,
    154.565f,
    156.317f,
    158.075f,
    159.833f,
    161.584f,
    163.336f,
    165.070f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 61.3051297231f,  110.2006267945f,  0.5891365528f },
    { 61.0695374074f,  110.5603548638f,  1.2503259821f },
    { 60.8319417166f,  110.9274758064f,  1.9339628932f },
    { 60.5922374527f,  111.3021256931f,  2.6424973537f },
    { 60.3503045400f,  111.6844602651f,  3.3788235665f },
    { 60.1060044124f,  112.0746643304f,  4.1463953456f },
    { 59.8591751483f,  112.4729659456f,  4.9493824361f },
    { 59.6096247726f,  112.8796581467f,  5.7928866534f },
    { 59.3571218045f,  113.2951328895f,  6.6832481317f },
    { 59.1013815221f,  113.7199353460f,  7.6284918358f },
    { 58.8420453075f,  114.1548534005f,  8.6390010196f },
    { 58.5786482716f,  114.6010707961f,  9.7285753334f },
    { 58.3105658683f,  115.0604419306f,  10.9161789592f },
    { 58.0369200525f,  115.5360161028f,  12.2290179906f },
    { 57.7563999708f,  116.0331226339f,  13.7084261956f },
    { 57.4668779178f,  116.5618865827f,  15.4224770652f },
    { 57.1644363719f,  117.1441348475f,  17.4979337245f },
    { 56.8401051368f,  117.8386179305f,  20.2273113248f },
    { 56.4589933392f,  118.9205378224f,  24.7521440678f },
    { 57.3429126212f,  114.5499828111f,  26.0899588644f },
    { 58.2021027967f,  110.5110987097f,  27.4538913190f },
    { 59.0389317527f,  106.7699135198f,  28.8445225162f },
    { 59.8553887545f,  103.2982110117f,  30.2621704450f },
    { 60.6531652136f,  100.0722826427f,  31.7069019463f },
    { 61.4337145392f,  97.0719995751f,  33.1785398326f },
    { 62.1982973298f,  94.2801094358f,  34.6766670178f },
    { 62.9480160653f,  91.6816942904f,  36.2006291018f },
    { 63.6838421341f,  89.2637465079f,  37.7495365791f },
    { 64.4066371691f,  87.0148323644f,  39.3222676296f },
    { 65.1171700914f,  84.9248220194f,  40.9174722849f },
    { 65.8161308735f,  82.9846704839f,  42.5335786170f },
    { 66.5041417630f,  81.1862383516f,  44.1688014598f },
    { 67.1817665165f,  79.5221439886f,  45.8211540328f },
    { 67.8495180614f,  77.9856409729f,  47.4884626922f },
    { 68.5078648999f,  76.5705160799f,  49.1683848824f },
    { 69.1572364998f,  75.2710042152f,  50.8584302089f },
    { 69.7980278628f,  74.0817174992f,  52.5559843973f },
    { 70.4306034179f,  72.9975863029f,  54.2583357580f },
    { 71.0553003599f,  72.0138104670f,  55.9627036496f },
    { 71.6724315255f,  71.1258192573f,  57.6662683211f },
    { 72.2822878850f,  70.3292388460f,  59.3662014407f },
    { 72.8851407095f,  69.6198662770f,  61.0596965712f },
    { 73.4812434654f,  68.9936490066f,  62.7439988492f },
    { 74.0708334764f,  68.4466692063f,  64.4164331516f },
    { 74.6541333872f,  67.9751320919f,  66.0744301016f },
    { 75.2313524581f,  67.5753576110f,  67.7155493575f },
    { 75.8026877130f,  67.2437748760f,  69.3374997432f },
    { 76.3683249614f,  66.9769187891f,  70.9381559113f },
    { 76.9284397110f,  66.7714283565f,  72.5155713628f },
    { 77.4831979848f,  66.6240462489f,  74.0679877798f },
    { 78.0327570545f,  66.5316192156f,  75.5938407510f },
    { 78.5772661015f,  66.4910990209f,  77.0917620753f },
    { 79.1168668135f,  66.4995436207f,  78.5605789162f },
    { 79.6516939234f,  66.5541183527f,  79.9993101455f },
    { 80.1818756999f,  66.6520969641f,  81.4071602570f },
    { 80.7075343916f,  66.7908623406f,  82.7835112556f },
    { 81.2287866330f,  66.9679068488f,  84.1279129289f },
    { 81.7457438143f,  67.1808322312f,  85.4400718978f },
    { 82.2585124199f,  67.4273490297f,  86.7198398184f },
    { 82.7671943391f,  67.7052755320f,  87.9672010724f },
    { 83.2718871499f,  68.0125362595f,  89.1822602469f },
    { 83.7726843821f,  68.3471600254f,  90.3652296579f },
    { 84.2696757573f,  68.7072776058f,  91.5164171335f },
    { 84.7629474127f,  69.0911190692f,  92.6362142261f },
    { 85.2525821059f,  69.4970108163f,  93.7250849875f },
    { 85.7386594056f,  69.9233723829f,  94.7835554038f },
    { 86.2212558681f,  70.3687130541f,  95.8122035533f },
    { 86.7004452010f,  70.8316283417f,  96.8116505290f },
    { 87.1762984152f,  71.3107963668f,  97.7825521372f },
    { 87.6488839666f,  71.8049741913f,  98.7255913730f },
    { 88.1182678880f,  72.3129941325f,  99.6414716520f },
    { 88.5845139124f,  72.8337600948f,  100.5309107713f },
    { 89.0476835874f,  73.3662439452f,  101.3946355617f },
    { 89.5078363832f,  73.9094819546f,  102.2333771893f },
    { 89.9650297927f,  74.4625713266f,  103.0478670598f },
    { 90.4193194261f,  75.0246668267f,  103.8388332777f },
    { 90.8707590989f,  75.5949775245f,  104.6069976144f },
    { 91.3194009153f,  76.1727636583f,  105.3530729341f },
    { 91.7652953458f,  76.7573336282f,  106.0777610366f },
    { 91.5010168191f,  76.8348502913f,  106.7926551121f },
    { 91.2356823168f,  76.9253729171f,  107.5106753151f },
    { 90.9692792066f,  77.0291128087f,  108.2316218154f },
    { 90.7017945984f,  77.1462799260f,  108.9552896607f },
    { 90.4332153370f,  77.2770827433f,  109.6814690949f },
    { 90.1635279944f,  77.4217281151f,  110.4099458977f },
    { 89.8927188619f,  77.5804211510f,  111.1405017446f },
    { 89.6207739414f,  77.7533650996f,  111.8729145859f },
    { 89.3476789374f,  77.9407612440f,  112.6069590432f },
    { 89.0734192472f,  78.1428088080f,  113.3424068216f },
    { 88.7979799525f,  78.3597048753f,  114.0790271360f },
    { 88.5213458088f,  78.5916443222f,  114.8165871498f },
    { 88.2435012361f,  78.8388197634f,  115.5548524234f },
    { 87.9644303079f,  79.1014215136f,  116.2935873707f },
    { 87.6841167405f,  79.3796375643f,  117.0325557221f },
    { 87.4025438817f,  79.6736535757f,  117.7715209898f },
    { 87.1196946987f,  79.9836528870f,  118.5102469364f },
    { 86.8355517662f,  80.3098165419f,  119.2484980406f },
    { 86.5500972534f,  80.6523233330f,  119.9860399610f },
    { 86.2633129105f,  81.0113498633f,  120.7226399943f },
    { 85.9751800549f,  81.3870706263f,  121.4580675258f },
    { 85.6856795566f,  81.7796581037f,  122.1920944698f },
    { 85.3947918232f,  82.1892828827f,  122.9244956992f },
    { 85.1024967838f,  82.6161137912f,  123.6550494609f },
    { 84.8087738726f,  83.0603180512f,  124.3835377755f },
    { 84.5136020115f,  83.5220614521f,  125.1097468207f },
    { 84.2169595924f,  84.0015085413f,  125.8334672955f },
    { 83.9188244578f,  84.4988228340f,  126.5544947645f },
    { 83.6191738813f,  85.0141670408f,  127.2726299812f },
    { 83.3179845469f,  85.5477033137f,  127.9876791893f },
    { 83.0152325273f,  86.0995935101f,  128.6994544001f },
    { 82.7108932612f,  86.6699994741f,  129.4077736475f },
    { 82.4049415297f,  87.2590833359f,  130.1124612176f },
    { 82.0973514309f,  87.8670078279f,  130.8133478547f },
    { 81.7880963541f,  88.4939366185f,  131.5102709418f },
    { 81.4771489522f,  89.1400346624f,  132.2030746573f },
    { 81.1644811129f,  89.8054685678f,  132.8916101064f },
    { 80.8500639283f,  90.4904069805f,  133.5757354291f },
    { 80.5338676630f,  91.1950209847f,  134.2553158840f },
    { 80.2158617205f,  91.9194845199f,  134.9302239095f },
    { 79.8960146081f,  92.6639748159f,  135.6003391619f },
    { 79.5742938995f,  93.4286728430f,  136.2655485327f },
    { 79.2506661956f,  94.2137637810f,  136.9257461448f },
    { 78.9250970834f,  95.0194375048f,  137.5808333295f },
    { 78.5975510920f,  95.8458890885f,  138.2307185843f },
    { 78.2679916470f,  96.6933193279f,  138.8753175142f },
    { 77.9363810212f,  97.5619352829f,  139.5145527555f },
    { 77.6026802841f,  98.4519508388f,  140.1483538858f },
    { 77.2668492463f,  99.3635872909f,  140.7766573191f },
    { 76.9288464031f,  100.2970739494f,  141.3994061892f },
    { 76.5886288724f,  101.2526487697f,  142.0165502211f },
    { 76.2461523305f,  102.2305590072f,  142.6280455928f },
    { 75.9013709435f,  103.2310618994f,  143.2338547875f },
    { 75.5542372940f,  104.2544253775f,  143.8339464391f },
    { 75.2047023038f,  105.3009288086f,  144.4282951704f },
    { 74.8527151513f,  106.3708637728f,  145.0168814263f },
    { 74.4982231839f,  107.4645348759f,  145.5996913028f },
    { 74.1411718243f,  108.5822606030f,  146.1767163727f },
    { 73.7815044709f,  109.7243742145f,  146.7479535094f },
    { 73.4191623911f,  110.8912246894f,  147.3134047090f },
    { 73.6492982806f,  106.9690129397f,  148.8051356817f },
    { 73.8665446102f,  103.7865043776f,  150.1229328195f },
    { 74.0753233362f,  101.0835091053f,  151.3285579587f },
    { 74.2779661594f,  98.7229096611f,  152.4546308928f },
    { 74.4758767148f,  96.6222132046f,  153.5207802297f },
    { 74.6699758151f,  94.7273385655f,  154.5398552022f },
    { 74.8609053511f,  93.0006149945f,  155.5207792011f },
    { 75.0491335382f,  91.4145886774f,  156.4700264025f },
    { 75.2350141572f,  89.9485369836f,  157.3924547106f },
    { 75.4188221734f,  88.5863727844f,  158.2918074990f },
    { 75.6007762973f,  87.3153171357f,  159.1710319230f },
    { 75.7810538902f,  86.1250223576f,  160.0324895329f },
    { 75.9598011620f,  85.0069720667f,  160.8781005643f },
    { 76.1371403571f,  83.9540584274f,  161.7094457374f },
    { 76.3131749461f,  82.9602766898f,  162.5278399034f },
    { 76.4879934599f,  82.0204996216f,  163.3343864960f },
    { 76.6616723746f,  81.1303077470f,  164.1300185629f },
    { 76.8342783203f,  80.2858594290f,  164.9155302098f },
    { 77.0058697953f,  79.4837899588f,  165.6916010596f },
    { 77.1764985169f,  78.7211321267f,  166.4588155350f },
    { 77.3462104962f,  77.9952529531f,  167.2176782455f },
    { 77.5150469046f,  77.3038027442f,  167.9686264015f },
    { 77.6830447773f,  76.6446736690f,  168.7120399300f },
    { 77.8502375920f,  76.0159657747f,  169.4482497928f },
    { 78.0166557464f,  75.4159588777f,  170.1775448860f },
    { 78.1823269565f,  74.8430891363f,  170.9001778056f },
    { 78.3472765918f,  74.2959293926f,  171.6163697004f },
    { 78.5115279575f,  73.7731725690f,  172.3263143848f },
    { 78.6751025345f,  73.2736175618f,  173.0301818445f },
    { 78.8380201855f,  72.7961571899f,  173.7281212419f },
    { 79.0002993306f,  72.3397678469f,  174.4202635073f },
    { 79.1619571003f,  71.9035005713f,  175.1067235819f },
    { 79.3230094674f,  71.4864733074f,  175.7876023702f },
    { 79.4834713622f,  71.0878641689f,  176.4629884443f },
    { 79.6433567729f,  70.7069055522f,  177.1329595393f },
    { 79.8026788347f,  70.3428789729f,  177.7975838686f },
    { 79.9614499072f,  69.9951105208f,  178.4569212846f },
    { 80.1196816435f,  69.6629668463f,  179.1110243070f },
    { 80.2773850514f,  69.3458516036f,  179.7599390343f },
    { 80.4345705479f,  69.0432022914f,  180.4037059550f },
    { 80.5912480075f,  68.7544874367f,  181.0423606705f },
    { 80.7474268058f,  68.4792040788f,  181.6759345401f },
    { 80.9031158589f,  68.2168755151f,  182.3044552579f },
    { 81.0583236580f,  67.9670492775f,  182.9279473691f },
    { 81.2130583013f,  67.7292953098f,  183.5464327315f },
    { 81.3673275225f,  67.5032043240f,  184.1599309305f },
    { 81.5211387172f,  67.2883863146f,  184.7684596498f },
    { 81.6744989657f,  67.0844692114f,  185.3720350043f },
    { 81.8274150552f,  66.8910976573f,  185.9706718381f },
    { 81.9798934989f,  66.7079318966f,  186.5643839916f },
    { 82.1319405539f,  66.5346467611f,  187.1531845399f },
    { 82.2835622375f,  66.3709307455f,  187.7370860064f },
    { 82.4347643426f,  66.2164851609f,  188.3161005524f },
    { 82.5855524509f,  66.0710233600f,  188.8902401468f },
    { 82.7359319457f,  65.9342700249f,  189.4595167154f },
    { 82.8859080238f,  65.8059605139f,  190.0239422743f },
    { 83.0354857061f,  65.6858402592f,  190.5835290459f },
    { 83.1846698472f,  65.5736642115f,  191.1382895620f },
    { 83.3334651453f,  65.4691963273f,  191.6882367527f },
    { 83.4818761500f,  65.3722090950f,  192.2333840237f },
    { 82.9822910757f,  64.8475839948f,  192.7831573497f },
    { 82.4790649309f,  64.3240715907f,  193.3467594859f },
    { 81.9721225394f,  63.8018661630f,  193.9246634508f },
    { 81.4613861245f,  63.2811753025f,  194.5173597122f },
    { 80.9467751815f,  62.7622208081f,  195.1253566163f },
    { 80.4282063424f,  62.2452396442f,  195.7491807835f },
    { 79.9055932317f,  61.7304849628f,  196.3893774620f },
    { 79.3788463126f,  61.2182271929f,  197.0465108287f },
    { 78.8478727233f,  60.7087552013f,  197.7211642260f },
    { 78.3125761022f,  60.2023775285f,  198.4139403212f },
    { 77.7728564009f,  59.6994237046f,  199.1254611735f },
    { 77.2286096839f,  59.2002456474f,  199.8563681919f },
    { 76.6797279152f,  58.7052191477f,  200.6073219653f },
    { 76.1260987283f,  58.2147454457f,  201.3790019434f },
    { 75.5676051806f,  57.7292529003f,  202.1721059457f },
    { 75.0041254881f,  57.2491987569f,  202.9873494718f },
    { 74.4355327419f,  56.7750710149f,  203.8254647863f },
    { 73.8616946014f,  56.3073903980f,  204.6871997470f },
    { 73.2824729644f,  55.8467124287f,  205.5733163428f },
    { 72.6977236107f,  55.3936296092f,  206.4845889080f },
    { 72.1072958171f,  54.9487737082f,  207.4218019730f },
    { 71.5110319404f,  54.5128181530f,  208.3857477161f },
    { 70.9087669657f,  54.0864805270f,  209.3772229740f },
    { 70.3003280162f,  53.6705251675f,  210.3970257725f },
    { 69.6855338198f,  53.2657658619f,  211.4459513387f },
    { 69.0641941289f,  52.8730686367f,  212.5247875577f },
    { 68.4361090875f,  52.4933546325f,  213.6343098421f },
    { 67.8010685397f,  52.1276030580f,  214.7752753865f },
    { 67.1588512730f,  51.7768542150f,  215.9484167914f },
    { 66.5092241887f,  51.4422125845f,  217.1544350475f },
    { 65.8519413906f,  51.1248499668f,  218.3939918908f },
    { 65.1867431819f,  50.8260086659f,  219.6677015550f },
    { 64.5133549590f,  50.5470047132f,  220.9761219696f },
    { 63.8314859883f,  50.2892311285f,  222.3197454813f },
    { 63.1408280518f,  50.0541612204f,  223.6989892053f },
    { 62.4410539419f,  49.8433519367f,  225.1141851506f },
    { 61.7318157866f,  49.6584472883f,  226.5655703008f },
    { 61.0127431795f,  49.5011818819f,  228.0532768771f },
    { 60.2834410861f,  49.3733846187f,  229.5773230530f },
    { 59.5434874952f,  49.2769826406f,  231.1376044395f },
    { 58.7924307717f,  49.2140056382f,  232.7338867015f },
    { 58.0297866687f,  49.1865906738f,  234.3657997119f },
    { 57.2550349389f,  49.1969877255f,  236.0328336870f },
    { 56.4676154803f,  49.2475662161f,  237.7343377769f },
    { 55.6669239351f,  49.3408228696f,  239.4695216092f },
    { 54.8523066426f,  49.4793913306f,  241.2374602960f },
    { 54.0230548278f,  49.6660540919f,  243.0371034155f },
    { 53.1783978786f,  49.9037574245f,  244.8672884770f },
    { 52.3174955295f,  50.1956301717f,  246.7267593660f },
    { 51.4394287274f,  50.5450074995f,  248.6141902586f },
    { 50.5431888964f,  50.9554609774f,  250.5282155003f },
    { 49.6276652439f,  51.4308367419f,  252.4674659766f },
    { 48.6916296518f,  51.9753039903f,  254.4306125824f },
    { 47.7337185666f,  52.5934167340f,  256.4164175602f },
    { 46.7524111222f,  53.2901926735f,  258.4237947467f },
    { 45.7460024897f,  54.0712143767f,  260.4518802234f },
    { 44.7125711130f,  54.9427598330f,  262.5001155644f },
    { 43.6499380148f,  55.9119722181f,  264.5683469555f },
    { 42.5556156859f,  56.9870828230f,  266.6569450960f },
    { 41.4267430833f,  58.1777073644f,  268.7669533000f },
    { 42.1351474425f,  57.5333296293f,  271.8160929137f },
    { 42.8265805442f,  57.0610028244f,  274.8048328867f },
    { 43.5022249197f,  56.7460531252f,  277.7233064185f },
    { 44.1631305750f,  56.5746168965f,  280.5630709240f },
    { 44.8102349048f,  56.5336164890f,  283.3172222973f },
    { 45.4443789216f,  56.6107544658f,  285.9804255798f },
    { 46.0663206004f,  56.7945151609f,  288.5488739651f },
    { 46.6767459399f,  57.0741659459f,  291.0201915351f },
    { 47.2762782008f,  57.4397534939f,  293.3932962596f },
    { 47.8654856741f,  57.8820926460f,  295.6682390249f },
    { 48.4448882554f,  58.3927471980f,  297.8460323914f },
    { 49.0149630424f,  58.9640030862f,  299.9284800286f },
    { 49.5761491263f,  59.5888351512f,  301.9180148569f },
    { 50.1288517153f,  60.2608689885f,  303.8175511962f },
    { 50.6734457000f,  60.9743394746f,  305.6303539087f },
    { 51.2102787501f,  61.7240474564f,  307.3599256974f },
    { 51.7396740160f,  62.5053159027f,  309.0099123982f },
    { 52.2619324947f,  63.3139465800f,  310.5840252105f },
    { 52.7773351102f,  64.1461780722f,  312.0859782828f },
    { 53.2861445488f,  64.9986457411f,  313.5194398097f },
    { 53.7886068837f,  65.8683440260f,  314.8879947317f },
    { 54.2849530180f,  66.7525913204f,  316.1951171965f },
    { 54.7753999707f,  67.6489975336f,  317.4441510819f },
    { 55.2601520249f,  68.5554343464f,  318.6382970657f },
    { 55.7394017570f,  69.4700080988f,  319.7806049265f },
    { 56.2133309609f,  70.3910351971f,  320.8739699536f },
    { 56.6821114803f,  71.3170198959f,  321.9211325307f },
    { 57.1459059603f,  72.2466342915f,  322.9246801177f },
    { 57.6048685271f,  73.1787003532f,  323.8870510048f },
    { 58.0591454040f,  74.1121738213f,  324.8105393314f },
    { 58.5088754721f,  75.0461298010f,  325.6973009688f },
    { 58.9541907794f,  75.9797498901f,  326.5493599524f },
    { 59.3952170064f,  76.9123106904f,  327.3686152180f },
    { 59.8320738913f,  77.8431735594f,  328.1568474558f },
    { 60.2648756185f,  78.7717754751f,  328.9157259426f },
    { 60.6937311760f,  79.6976208936f,  329.6468152468f },
    { 61.1187446831f,  80.6202744933f,  330.3515817343f },
    { 61.5400156919f,  81.5393547106f,  331.0313998221f },
    { 61.9576394653f,  82.4545279767f,  331.6875579469f },
    { 62.3717072334f,  83.3655035829f,  332.3212642293f },
    { 62.7823064308f,  84.2720291001f,  332.9336518230f },
    { 63.1895209152f,  85.1738862945f,  333.5257839489f },
    { 63.5934311716f,  86.0708874828f,  334.0986586172f },
    { 63.9941144999f,  86.9628722782f,  334.6532130457f },
    { 64.3916451908f,  87.8497046843f,  335.1903277865f },
    { 64.7860946884f,  88.7312704987f,  335.7108305730f },
    { 65.1775317418f,  89.6074749906f,  336.2154999025f },
    { 65.5660225467f,  90.4782408247f,  336.7050683676f },
    { 65.9516308775f,  91.3435062018f,  337.1802257536f },
    { 66.3344182100f,  92.2032231951f,  337.6416219147f },
    { 66.7144438374f,  93.0573562586f,  338.0898694452f },
    { 67.0917649778f,  93.9058808905f,  338.5255461581f },
    { 67.4664368757f,  94.7487824349f,  338.9491973860f },
    { 67.8385128962f,  95.5860550055f,  339.3613381157f },
    { 68.2080446148f,  96.4177005210f,  339.7624549697f },
    { 68.5750819006f,  97.2437278374f,  340.1530080449f },
    { 68.9396729951f,  98.0641519696f,  340.5334326191f },
    { 69.3018645863f,  98.8789933911f,  340.9041407363f },
    { 69.6617018782f,  99.6882774047f,  341.2655226782f },
    { 70.0192286571f,  100.4920335767f,  341.6179483316f },
    { 69.8312801136f,  100.6247090998f,  341.9666611748f },
    { 69.6425864532f,  100.7612069253f,  342.3184761683f },
    { 69.4531370769f,  100.9015902418f,  342.6734610852f },
    { 69.2629210801f,  101.0459232847f,  343.0316871928f },
    { 69.0719272373f,  101.1942713482f,  343.3932295084f },
    { 68.8801439872f,  101.3467007960f,  343.7581670779f },
    { 68.6875594159f,  101.5032790721f,  344.1265832788f },
    { 68.4941612392f,  101.6640747098f,  344.4985661526f },
    { 68.2999367834f,  101.8291573408f,  344.8742087668f },
    { 68.1048729649f,  101.9985977016f,  345.2536096124f },
    { 67.9089562681f,  102.1724676402f,  345.6368730393f },
    { 67.7121727216f,  102.3508401203f,  346.0241097349f },
    { 67.5145078724f,  102.5337892238f,  346.4154372511f },
    { 67.3159467580f,  102.7213901521f,  346.8109805853f },
    { 67.1164738759f,  102.9137192248f,  347.2108728215f },
    { 66.9160731513f,  103.1108538761f,  347.6152558410f },
    { 66.7147279004f,  103.3128726487f,  348.0242811096f },
    { 66.5124207920f,  103.5198551849f,  348.4381105533f },
    { 66.3091338041f,  103.7318822150f,  348.8569175331f },
    { 66.1048481769f,  103.9490355414f,  349.2808879337f },
    { 65.8995443611f,  104.1713980203f,  349.7102213821f },
    { 65.6932019606f,  104.3990535390f,  350.1451326142f },
    { 65.4857996691f,  104.6320869889f,  350.5858530140f },
    { 65.2773152001f,  104.8705842352f,  351.0326323485f },
    { 65.0677252082f,  105.1146320823f,  351.4857407326f },
    { 64.8570052017f,  105.3643182347f,  351.9454708588f },
    { 64.6451294447f,  105.6197312548f,  352.4121405382f },
    { 64.4320708459f,  105.8809605182f,  352.8860956037f },
    { 64.2178008339f,  106.1480961659f,  353.3677132425f },
    { 64.0022892150f,  106.4212290581f,  353.8574058340f },
    { 63.7855040112f,  106.7004507292f,  354.3556253903f },
    { 63.5674112743f,  106.9858533497f,  354.8628687148f },
    { 63.3479748717f,  107.2775296999f,  355.3796834269f },
    { 63.1271562378f,  107.5755731631f,  355.9066750306f },
    { 62.9049140853f,  107.8800777494f,  356.4445152562f },
    { 62.6812040650f,  108.1911381656f,  356.9939519608f },
    { 62.4559783649f,  108.5088499545f,  357.5558209546f },
    { 62.2291852325f,  108.8333097331f,  358.1310602226f },
    { 62.0007684030f,  109.1646155765f,  358.7207271565f },
    { 61.7706664055f,  109.5028676097f,  359.3260195995f },
    { 61.5388117179f,  109.8481689018f,  359.9483017771f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.888238525390625f,
    0.887377929687500f,
    0.886529541015625f,
    0.885699462890625f,
    0.884893798828125f,
    0.884100341796875f,
    0.883319091796875f,
    0.882568359375000f,
    0.881835937500000f,
    0.881127929687500f,
    0.880426025390625f,
    0.879754638671875f,
    0.879113769531250f,
    0.878472900390625f,
    0.877868652343750f,
    0.877276611328125f,
    0.876708984375000f,
    0.876165771484375f,
    0.875646972656250f,
    0.875134277343750f,
    0.874676513671875f,
    0.874188232421875f,
    0.873748779296875f,
    0.873345947265625f,
    0.872906494140625f,
    0.872521972656250f,
    0.872198486328125f,
    0.874047851562500f,
    0.876690673828125f,
    0.879083251953125f,
    0.881420898437500f,
    0.883666992187500f,
    0.885748291015625f,
    0.887841796875000f,
    0.889733886718750f,
    0.891638183593750f,
    0.893432617187500f,
    0.895166015625000f,
    0.896868896484375f,
    0.898474121093750f,
    0.900091552734375f,
    0.901574707031250f,
    0.903100585937500f,
    0.904510498046875f,
    0.905932617187500f,
    0.907287597656250f,
    0.908630371093750f,
    0.909936523437500f,
    0.911206054687500f,
    0.912469482421875f,
    0.913677978515625f,
    0.914898681640625f,
    0.916052246093750f,
    0.917236328125000f,
    0.918341064453125f,
    0.919488525390625f,
    0.920562744140625f,
    0.921661376953125f,
    0.922717285156250f,
    0.923779296875000f,
    0.924822998046875f,
    0.925848388671875f,
    0.926879882812500f,
    0.927868652343750f,
    0.928894042968750f,
    0.929858398437500f,
    0.930847167968750f,
    0.931817626953125f,
    0.932775878906250f,
    0.933758544921875f,
    0.934686279296875f,
    0.935650634765625f,
    0.936590576171875f,
    0.937518310546875f,
    0.938476562500000f,
    0.939392089843750f,
    0.940319824218750f,
    0.941265869140625f,
    0.942175292968750f,
    0.943090820312500f,
    0.944024658203125f,
    0.944946289062500f,
    0.945849609375000f,
    0.946771240234375f,
    0.947698974609375f,
    0.948620605468750f,
    0.949523925781250f,
    0.950427246093750f,
    0.951342773437500f,
    0.952252197265625f,
    0.953167724609375f,
    0.954071044921875f,
    0.954974365234375f,
    0.955865478515625f,
    0.956744384765625f,
    0.957604980468750f,
    0.958453369140625f,
    0.959283447265625f,
    0.960089111328125f,
    0.960870361328125f,
    0.961608886718750f,
    0.962255859375000f,
    0.962854003906250f,
    0.963342285156250f,
    0.955017089843750f,
    0.931811523437500f,
    0.907879638671875f,
    0.895483398437500f,
    0.897955322265625f,
    0.900268554687500f,
    0.902435302734375f,
    0.904467773437500f,
    0.906384277343750f,
    0.908184814453125f,
    0.909881591796875f,
    0.911486816406250f,
    0.912994384765625f,
    0.914428710937500f,
    0.915777587890625f,
    0.917059326171875f,
    0.918273925781250f,
    0.919421386718750f,
    0.920507812500000f,
    0.921533203125000f,
    0.922509765625000f,
    0.923437500000000f,
    0.924310302734375f,
    0.925140380859375f,
    0.925921630859375f,
    0.926660156250000f,
    0.927362060546875f,
    0.928015136718750f,
    0.928637695312500f,
    0.929217529296875f,
    0.929760742187500f,
    0.930261230468750f,
    0.930731201171875f,
    0.931164550781250f,
    0.931561279296875f,
    0.931927490234375f,
    0.932250976562500f,
    0.934265136718750f,
    0.936895751953125f,
    0.939318847656250f,
    0.941595458984375f,
    0.943737792968750f,
    0.945758056640625f,
    0.947656250000000f,
    0.949420166015625f,
    0.951092529296875f,
    0.952679443359375f,
    0.954174804687500f,
    0.955596923828125f,
    0.956933593750000f,
    0.958190917968750f,
    0.959387207031250f,
    0.960522460937500f,
    0.961602783203125f,
    0.962628173828125f,
    0.963604736328125f,
    0.964538574218750f,
    0.965417480468750f,
    0.966247558593750f,
    0.967041015625000f,
    0.967791748046875f,
    0.968505859375000f,
    0.969189453125000f,
    0.969830322265625f,
    0.970446777343750f,
    0.971026611328125f,
    0.971575927734375f,
    0.972100830078125f,
    0.972589111328125f,
    0.973059082031250f,
    0.973492431640625f,
    0.973907470703125f,
    0.974291992187500f,
    0.974652099609375f,
    0.974987792968750f,
    0.975299072265625f,
    0.975585937500000f,
    0.975848388671875f,
    0.976086425781250f,
    0.976306152343750f,
    0.976495361328125f,
    0.976666259765625f,
    0.976806640625000f,
    0.976928710937500f,
    0.977020263671875f,
    0.977093505859375f,
    0.977136230468750f,
    0.977154541015625f,
    0.977148437500000f,
    0.977111816406250f,
    0.977044677734375f,
    0.976947021484375f,
    0.979437255859375f,
    0.990411376953125f,
    0.990185546875000f,
    0.989959716796875f,
    0.989733886718750f,
    0.989514160156250f,
    0.989294433593750f,
    0.989074707031250f,
    0.988867187500000f,
    0.988647460937500f,
    0.988421630859375f,
    0.988201904296875f,
    0.987982177734375f,
    0.987768554687500f,
    0.987567138671875f,
    0.987365722656250f,
    0.987139892578125f,
    0.986926269531250f,
    0.986724853515625f,
    0.986529541015625f,
    0.986309814453125f,
    0.986096191406250f,
    0.985894775390625f,
    0.985699462890625f,
    0.985479736328125f,
    0.985272216796875f,
    0.985076904296875f,
    0.984863281250000f,
    0.984649658203125f,
    0.984454345703125f,
    0.984240722656250f,
    0.984027099609375f,
    0.983825683593750f,
    0.983612060546875f,
    0.983392333984375f,
    0.983190917968750f,
    0.982971191406250f,
    0.982751464843750f,
    0.982543945312500f,
    0.982318115234375f,
    0.982092285156250f,
    0.981884765625000f,
    0.981640625000000f,
    0.981414794921875f,
    0.981195068359375f,
    0.980950927734375f,
    0.980718994140625f,
    0.980480957031250f,
    0.980230712890625f,
    0.979986572265625f,
    0.979736328125000f,
    0.979479980468750f,
    0.979223632812500f,
    0.978961181640625f,
    0.978686523437500f,
    0.978417968750000f,
    0.978137207031250f,
    0.977844238281250f,
    0.977563476562500f,
    0.977264404296875f,
    0.976953125000000f,
    0.976641845703125f,
    0.976330566406250f,
    0.975988769531250f,
    0.975646972656250f,
    0.975311279296875f,
    0.974951171875000f,
    0.974572753906250f,
    0.974194335937500f,
    0.973815917968750f,
    0.973400878906250f,
    0.972973632812500f,
    0.972540283203125f,
    0.972094726562500f,
    0.971630859375000f,
    0.971136474609375f,
    0.970629882812500f,
    0.970104980468750f,
    0.969567871093750f,
    0.969000244140625f,
    0.968395996093750f,
    0.968280029296875f,
    0.968377685546875f,
    0.968432617187500f,
    0.968518066406250f,
    0.968585205078125f,
    0.968658447265625f,
    0.968750000000000f,
    0.968811035156250f,
    0.968890380859375f,
    0.968963623046875f,
    0.969036865234375f,
    0.969122314453125f,
    0.969189453125000f,
    0.969262695312500f,
    0.969354248046875f,
    0.969421386718750f,
    0.969494628906250f,
    0.969580078125000f,
    0.969659423828125f,
    0.969732666015625f,
    0.969812011718750f,
    0.969897460937500f,
    0.969982910156250f,
    0.970056152343750f,
    0.970135498046875f,
    0.970220947265625f,
    0.970306396484375f,
    0.970397949218750f,
    0.970489501953125f,
    0.970574951171875f,
    0.970660400390625f,
    0.970751953125000f,
    0.970843505859375f,
    0.970935058593750f,
    0.971032714843750f,
    0.971136474609375f,
    0.971234130859375f,
    0.971325683593750f,
    0.971429443359375f,
    0.971533203125000f,
    0.971643066406250f,
    0.971752929687500f,
    0.971856689453125f,
    0.971978759765625f,
    0.972088623046875f,
    0.972210693359375f,
    0.972332763671875f,
    0.972460937500000f,
    0.972583007812500f,
    0.972717285156250f,
    0.972851562500000f,
    0.966888427734375f,
    0.955664062500000f,
    0.944659423828125f,
    0.933856201171875f,
    0.923229980468750f,
    0.916235351562500f,
    0.915081787109375f,
    0.913934326171875f,
    0.912799072265625f,
    0.911663818359375f,
    0.910540771484375f,
    0.909423828125000f,
    0.908312988281250f,
    0.907208251953125f,
    0.906115722656250f,
    0.905035400390625f,
    0.903961181640625f,
    0.902886962890625f,
    0.901831054687500f,
    0.900787353515625f,
    0.899749755859375f,
    0.898718261718750f,
    0.897705078125000f,
    0.896697998046875f,
    0.895703125000000f,
    0.894720458984375f,
    0.893756103515625f,
    0.892797851562500f,
    0.891857910156250f,
    0.890930175781250f,
    0.890020751953125f,
    0.889123535156250f
};

#include "hellwig_lib_rc1.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1 = clamp3(AP1, 0.0f, 16384.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in = float3spow(in, 2.4f);
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_709D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-1
            if (hardClip)
            {
                out = clamp3(out, 0.0f, 1.0f);
            }
            
            if (asPQ)
            {
                out = referenceLuminance * vector_dot(BT709_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}