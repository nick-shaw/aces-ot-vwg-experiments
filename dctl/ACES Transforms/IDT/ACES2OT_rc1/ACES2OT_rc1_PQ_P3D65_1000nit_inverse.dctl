DEFINE_ACES_PARAM(IS_PARAMETRIC_ACES_TRANSFORM: 0)

// DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(asPQ, Encode as P3D65 PQ, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
// DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 1)
// DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)

__CONSTANT__ int toneCurve = 1;
__CONSTANT__ int compressChroma = 1;
__CONSTANT__ int gamutCompress = 1;
__CONSTANT__ int d60Sim = 0;
__CONSTANT__ int asPQ = 1;
__CONSTANT__ int ap1Clip = 1;
__CONSTANT__ int softClip = 0;
__CONSTANT__ int hardClip = 1;
__CONSTANT__ int invert = 1;
__CONSTANT__ int JMhOut = 0;

typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// P3D65 to XYZ matrix
    { 0.4865709486f,  0.2656676932f,  0.1982172852f },
    { 0.2289745641f,  0.6917385218f,  0.0792869141f },
    {-0.0000000000f,  0.0451133819f,  1.0439443689f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float3x3 P3D65_to_BT2020 =
{
    { 0.7538330344f,  0.1985973691f,  0.0475695966f },
    { 0.0457438490f,  0.9417772198f,  0.0124789312f },
    {-0.0012103404f,  0.0176017173f,  0.9836086231f }
};

__CONSTANT__ float limitJmax = 283.249899f;
__CONSTANT__ float midJ = 40.8168834391f; // ~15 nits in Hellwig J
__CONSTANT__ float focusDist = 3.7125f;

__CONSTANT__ float daniele_n = 1000.0f; // peak white
__CONSTANT__ float daniele_m_2 = 10.1729113787f;
__CONSTANT__ float daniele_s_2 = 5.8959268851f;
__CONSTANT__ float daniele_u_2 = 0.9869191713f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 0.403f;
__CONSTANT__ float sat_thr = 0.0005f;
__CONSTANT__ float compr = 10.32f;
__CONSTANT__ float chromaCompressScale = 2.4845958f; // pow(0.03379 * daniele_n, 0.30596) - 0.45135;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 163.9628719030f,  205.0692976684f,  0.6897637722f },
    { 163.1386701083f,  205.8388195962f,  1.5805236740f },
    { 162.3063864604f,  206.6389049391f,  2.5075674356f },
    { 161.4655882392f,  207.4715487465f,  3.4752695483f },
    { 160.6157765267f,  208.3391585860f,  4.4889055645f },
    { 159.7563679986f,  209.2447043371f,  5.5549203793f },
    { 158.8866694019f,  210.1919398090f,  6.6813061892f },
    { 158.0058407468f,  211.1857398816f,  7.8781498062f },
    { 157.1128404125f,  212.2326305016f,  9.1584513969f },
    { 156.2063399331f,  213.3416552991f,  10.5393980380f },
    { 155.2845850908f,  214.5258626255f,  12.0444418655f },
    { 154.3451552084f,  215.8050166124f,  13.7069012916f },
    { 153.3845117252f,  217.2109447521f,  15.5767078943f },
    { 152.3970560837f,  218.7992777606f,  17.7344576139f },
    { 151.3728351567f,  220.6795579709f,  20.3255208421f },
    { 150.2903691378f,  223.1146361754f,  23.6661485261f },
    { 149.0790224515f,  227.0772080771f,  28.7959761284f },
    { 151.9100254016f,  218.0355012686f,  30.3898476637f },
    { 154.6557031837f,  209.8189548246f,  32.0174460620f },
    { 157.3241866351f,  202.3356878068f,  33.6765303273f },
    { 159.9222873237f,  195.5097307085f,  35.3648585584f },
    { 162.4557886255f,  189.2774405805f,  37.0800827088f },
    { 164.9296579952f,  183.5848560295f,  38.8196924074f },
    { 167.3482052307f,  178.3857100233f,  40.5809887320f },
    { 169.7152027475f,  173.6399132788f,  42.3610778426f },
    { 172.0339785282f,  169.3123811161f,  44.1568787853f },
    { 174.3074890253f,  165.3721156699f,  45.9651419635f },
    { 176.5383771018f,  161.7914812013f,  47.7824758603f },
    { 178.7290186308f,  158.5456277102f,  49.6053801085f },
    { 180.8815603777f,  155.6120300428f,  51.4302832312f },
    { 182.9979510972f,  152.9701180393f,  53.2535834647f },
    { 185.0799672892f,  150.6009791779f,  55.0716911241f },
    { 187.1292347049f,  148.4871193956f,  56.8810710171f },
    { 189.1472464400f,  146.6122708434f,  58.6782835030f },
    { 191.1353782620f,  144.9612375977f,  60.4600229211f },
    { 193.0949016777f,  143.5197720584f,  62.2231522938f },
    { 195.0269951410f,  142.2744760767f,  63.9647334296f },
    { 196.9327537185f,  141.2127218885f,  65.6820517946f },
    { 198.8131974685f,  140.3225887701f,  67.3726357808f },
    { 200.6692787395f,  139.5928120235f,  69.0342702467f },
    { 202.5018885568f,  139.0127414876f,  70.6650044408f },
    { 204.3118622340f,  138.5723072753f,  72.2631546140f },
    { 206.0999843242f,  138.2619908695f,  73.8273017880f },
    { 207.8669930040f,  138.0728000893f,  75.3562852630f },
    { 209.6135839701f,  137.9962467604f,  76.8491925190f },
    { 211.3404139129f,  138.0243261998f,  78.3053461978f },
    { 213.0481036243f,  138.1494978553f,  79.7242888476f },
    { 214.7372407856f,  138.3646666343f,  81.1057660831f },
    { 216.4083824755f,  138.6631646067f,  82.4497087560f },
    { 218.0620574330f,  139.0387328933f,  83.7562146665f },
    { 219.6987681042f,  139.4855036402f,  85.0255302688f },
    { 221.3189924973f,  139.9979820507f,  86.2580327447f },
    { 222.9231858695f,  140.5710284930f,  87.4542127429f },
    { 224.5117822619f,  141.1998407361f,  88.6146580112f },
    { 226.0851959021f,  141.8799363809f,  89.7400380801f },
    { 227.6438224853f,  142.6071355658f,  90.8310901030f },
    { 229.1880403492f,  143.3775440247f,  91.8886059094f },
    { 230.7182115525f,  144.1875365708f,  92.9134202856f },
    { 232.2346828663f,  145.0337410740f,  93.9064004692f },
    { 233.7377866875f,  145.9130229868f,  94.8684368175f },
    { 235.2278418819f,  146.8224704658f,  95.8004345931f },
    { 236.7051545631f,  147.7593801218f,  96.7033067968f },
    { 238.1700188131f,  148.7212434250f,  97.5779679723f },
    { 239.6227173511f,  149.7057337767f,  98.4253289010f },
    { 241.0635221531f,  150.7106942562f,  99.2462921058f },
    { 242.4926950288f,  151.7341260379f,  100.0417480834f },
    { 243.9104881576f,  152.7741774720f,  100.8125721880f },
    { 245.3171445890f,  153.8291338143f,  101.5596220920f },
    { 246.7128987082f,  154.8974075862f,  102.2837357569f },
    { 248.0979766721f,  155.9775295435f,  102.9857298484f },
    { 249.4725968165f,  157.0681402305f,  103.6663985404f },
    { 250.8369700367f,  158.1679820916f,  104.3265126534f },
    { 252.1913001456f,  159.2758921155f,  104.9668190803f },
    { 253.5357842077f,  160.3907949821f,  105.5880404580f },
    { 254.8706128545f,  161.5116966859f,  106.1908750465f },
    { 256.1959705792f,  162.6376786070f,  106.7759967818f },
    { 257.5120360158f,  163.7678920037f,  107.3440554747f },
    { 256.9262401566f,  163.8804407243f,  107.9034560184f },
    { 256.3384417108f,  164.0101965447f,  108.4653364318f },
    { 255.7486215042f,  164.1574230306f,  109.0296053837f },
    { 255.1567600504f,  164.3223838588f,  109.5961689605f },
    { 254.5628375444f,  164.5053427111f,  110.1649307385f },
    { 253.9668338548f,  164.7065631711f,  110.7357918629f },
    { 253.3687285159f,  164.9263086235f,  111.3086511338f },
    { 252.7685007206f,  165.1648421562f,  111.8834050975f },
    { 252.1661293114f,  165.4224264666f,  112.4599481453f },
    { 251.5615927729f,  165.6993237712f,  113.0381726176f },
    { 250.9548692225f,  165.9957957201f,  113.6179689140f },
    { 250.3459364021f,  166.3121033163f,  114.1992256094f },
    { 249.7347716685f,  166.6485068409f,  114.7818295752f },
    { 249.1213519844f,  167.0052657833f,  115.3656661053f },
    { 248.5056539081f,  167.3826387784f,  115.9506190476f },
    { 247.8876535840f,  167.7808835507f,  116.5365709394f },
    { 247.2673267320f,  168.2002568652f,  117.1234031465f },
    { 246.6446486367f,  168.6410144861f,  117.7109960073f },
    { 246.0195941367f,  169.1034111439f,  118.2992289782f },
    { 245.3921376126f,  169.5877005108f,  118.8879807835f },
    { 244.7622529758f,  170.0941351845f,  119.4771295670f },
    { 244.1299136558f,  170.6229666826f,  120.0665530448f },
    { 243.4950925880f,  171.1744454448f,  120.6561286611f },
    { 242.8577622005f,  171.7488208467f,  121.2457337434f },
    { 242.2178944005f,  172.3463412228f,  121.8352456590f },
    { 241.5754605607f,  172.9672539006f,  122.4245419710f },
    { 240.9304315044f,  173.6118052451f,  123.0135005944f },
    { 240.2827774910f,  174.2802407149f,  123.6019999505f },
    { 239.6324682004f,  174.9728049289f,  124.1899191200f },
    { 238.9794727168f,  175.6897417453f,  124.7771379945f },
    { 238.3237595125f,  176.4312943516f,  125.3635374251f },
    { 237.6652964304f,  177.1977053670f,  125.9489993683f },
    { 237.0040506664f,  177.9892169559f,  126.5334070287f },
    { 236.3399887508f,  178.8060709551f,  127.1166449980f },
    { 235.6730765292f,  179.6485090115f,  127.6985993895f },
    { 235.0032791428f,  180.5167727331f,  128.2791579687f },
    { 234.3305610076f,  181.4111038523f,  128.8582102788f },
    { 233.6548857934f,  182.3317444012f,  129.4356477612f },
    { 232.9762164009f,  183.2789369002f,  130.0113638704f },
    { 232.2945149394f,  184.2529245584f,  130.5852541834f },
    { 231.6097427024f,  185.2539514870f,  131.1572165032f },
    { 230.9218601431f,  186.2822629250f,  131.7271509565f },
    { 230.2308268481f,  187.3381054784f,  132.2949600844f },
    { 229.5366015108f,  188.4217273710f,  132.8605489273f },
    { 228.8391419032f,  189.5333787085f,  133.4238251036f },
    { 228.1384048472f,  190.6733117561f,  133.9846988810f },
    { 227.4343461838f,  191.8417812276f,  134.5430832416f },
    { 226.7269207420f,  193.0390445884f,  135.0988939409f },
    { 226.0160823054f,  194.2653623717f,  135.6520495591f },
    { 225.3017835786f,  195.5209985072f,  136.2024715470f },
    { 224.5839761507f,  196.8062206638f,  136.7500842641f },
    { 223.8626104589f,  198.1213006055f,  137.2948150121f },
    { 223.1376357489f,  199.4665145611f,  137.8365940599f },
    { 222.4090000349f,  200.8421436078f,  138.3753546643f },
    { 221.6766500568f,  202.2484740697f,  138.9110330838f },
    { 220.9405312363f,  203.6857979300f,  139.4435685866f },
    { 220.2005876306f,  205.1544132587f,  139.9729034533f },
    { 219.4567618838f,  206.6546246563f,  140.4989829738f },
    { 218.7089951768f,  208.1867437121f,  141.0217554394f },
    { 217.9572271740f,  209.7510894806f,  141.5411721296f },
    { 218.5974699952f,  202.5636762556f,  142.6758180264f },
    { 219.2209800960f,  196.2299590424f,  143.7555197450f },
    { 219.8313299177f,  190.5535299623f,  144.7947937743f },
    { 220.4309123998f,  185.4030252093f,  145.8033300347f },
    { 221.0214215975f,  180.6856191219f,  146.7879509697f },
    { 221.6041081418f,  176.3329357684f,  147.7536547971f },
    { 222.1799262237f,  172.2929426787f,  148.7042165965f },
    { 222.7496234928f,  168.5249926019f,  149.6425563135f },
    { 223.3137987833f,  164.9966394753f,  150.5709752202f },
    { 223.8729406829f,  161.6815108230f,  151.4913139700f },
    { 224.4274541690f,  158.5578382169f,  152.4050617761f },
    { 224.9776795269f,  155.6074134192f,  153.3134339614f },
    { 225.5239061121f,  152.8148288597f,  154.2174283782f },
    { 226.0663825731f,  150.1669133512f,  155.1178673255f },
    { 226.6053245853f,  147.6523051254f,  156.0154292712f },
    { 227.1409207960f,  145.2611235126f,  156.9106732609f },
    { 227.6733374613f,  142.9847128208f,  157.8040579829f },
    { 228.2027221095f,  140.8154399484f,  158.6959568676f },
    { 228.7292064683f,  138.7465325904f,  159.5866701989f },
    { 229.2529088295f,  136.7719485310f,  160.4764349501f },
    { 229.7739359768f,  134.8862690363f,  161.3654328635f },
    { 230.2923847719f,  133.0846111410f,  162.2537971629f },
    { 230.8083434696f,  131.3625549034f,  163.1416181922f },
    { 231.3218928162f,  129.7160826293f,  164.0289482033f },
    { 231.8331069735f,  128.1415277513f,  164.9158054659f },
    { 232.3420543010f,  126.6355315624f,  165.8021778310f },
    { 232.8487980216f,  125.1950063853f,  166.6880258561f },
    { 233.3533967921f,  123.8171040533f,  167.5732855709f },
    { 233.8559051933f,  122.4991888046f,  168.4578709518f },
    { 234.3563741546f,  121.2388138662f,  169.3416761553f },
    { 234.8548513227f,  120.0337011401f,  170.2245775530f },
    { 235.3513813824f,  118.8817235125f,  171.1064356002f },
    { 235.8460063389f,  117.7808893934f,  171.9870965662f },
    { 236.3387657648f,  116.7293291602f,  172.8663941455f },
    { 236.8296970187f,  115.7252832357f,  173.7441509688f },
    { 237.3188354388f,  114.7670915751f,  174.6201800257f },
    { 237.8062145142f,  113.8531843715f,  175.4942860100f },
    { 238.2918660381f,  112.9820738208f,  176.3662665961f },
    { 238.7758202448f,  112.1523468103f,  177.2359136526f },
    { 239.2581059316f,  111.3626584151f,  178.1030143973f },
    { 239.7387505696f,  110.6117261034f,  178.9673524985f },
    { 240.2177804020f,  109.8983245670f,  179.8287091230f },
    { 240.6952205343f,  109.2212811020f,  180.6868639345f },
    { 241.1710950151f,  108.5794714775f,  181.5415960425f },
    { 241.6454269091f,  107.9718162361f,  182.3926849020f },
    { 242.1182383646f,  107.3972773792f,  183.2399111652f },
    { 242.5895506736f,  106.8548553938f,  184.0830574846f },
    { 243.0593843280f,  106.3435865835f,  184.9219092675f },
    { 243.5277590697f,  105.8625406724f,  185.7562553821f },
    { 243.9946939375f,  105.4108186507f,  186.5858888141f },
    { 244.4602073094f,  104.9875508384f,  187.4106072749f },
    { 244.9243169421f,  104.5918951423f,  188.2302137609f },
    { 245.3870400072f,  104.2230354870f,  189.0445170637f },
    { 245.8483931239f,  103.8801804013f,  189.8533322317f },
    { 246.3083923904f,  103.5625617432f,  190.6564809839f },
    { 246.7670534118f,  103.2694335500f,  191.4537920759f },
    { 247.2243913268f,  103.0000709976f,  192.2451016199f },
    { 247.6804208320f,  102.7537694610f,  193.0302533587f },
    { 248.1351562046f,  102.5298436615f,  193.8090988951f },
    { 248.5886113233f,  102.3276268935f,  194.5814978790f },
    { 247.2005627392f,  101.5294526059f,  195.3609749905f },
    { 245.8019397094f,  100.7421021633f,  196.1602023490f },
    { 244.3925272599f,  99.9663873183f,  196.9797011520f },
    { 242.9721031408f,  99.2031644196f,  197.8199931243f },
    { 241.5404374789f,  98.4533363854f,  198.6815983971f },
    { 240.0972924082f,  97.7178546905f,  199.5650331124f },
    { 238.6424216774f,  96.9977213526f,  200.4708067336f },
    { 237.1755702320f,  96.2939909027f,  201.3994190460f },
    { 235.6964737701f,  95.6077723240f,  202.3513568308f },
    { 234.2048582678f,  94.9402309391f,  203.3270902006f },
    { 232.7004394743f,  94.2925902236f,  204.3270685871f },
    { 231.1829223714f,  93.6661335245f,  205.3517163758f },
    { 229.6520005971f,  93.0622056561f,  206.4014281897f },
    { 228.1073558283f,  92.4822143473f,  207.4765638291f },
    { 226.5486571196f,  91.9276315114f,  208.5774428838f },
    { 224.9755601950f,  91.3999943083f,  209.7043390446f },
    { 223.3877066878f,  90.9009059702f,  210.8574741497f },
    { 221.7847233230f,  90.4320363601f,  212.0370120163f },
    { 220.1662210391f,  89.9951222358f,  213.2430521208f },
    { 218.5317940416f,  89.5919671937f,  214.4756232042f },
    { 216.8810187828f,  89.2244412703f,  215.7346768965f },
    { 215.2134528602f,  88.8944801864f,  217.0200814700f },
    { 213.5286338255f,  88.6040842239f,  218.3316158432f },
    { 211.8260778958f,  88.3553167368f,  219.6689639765f },
    { 210.1052785562f,  88.1503023072f,  221.0317098092f },
    { 208.3657050423f,  87.9912245710f,  222.4193329007f },
    { 206.6068006913f,  87.8803237544f,  223.8312049425f },
    { 204.8279811453f,  87.8198939768f,  225.2665873131f },
    { 203.0286323918f,  87.8122803980f,  226.7246298410f },
    { 201.2081086234f,  87.8598763065f,  228.2043709356f },
    { 199.3657298936f,  87.9651202664f,  229.7047392276f },
    { 197.5007795474f,  88.1304934655f,  231.2245568382f },
    { 195.6125013980f,  88.3585174286f,  232.7625443696f },
    { 193.7000966178f,  88.6517522820f,  234.3173276702f },
    { 191.7627203098f,  89.0127957795f,  235.8874463916f },
    { 189.7994777153f,  89.4442833203f,  237.4713643067f },
    { 187.8094200130f,  89.9488892106f,  239.0674813160f },
    { 185.7915396512f,  90.5293294397f,  240.6741470201f },
    { 183.7447651508f,  91.1883662634f,  242.2896756980f },
    { 181.6679553016f,  91.9288149063f,  243.9123624885f },
    { 179.5598926654f,  92.7535527184f,  245.5405005494f },
    { 177.4192762803f,  93.6655311488f,  247.1723989432f },
    { 175.2447134431f,  94.6677909335f,  248.8064009953f },
    { 173.0347104243f,  95.7634809388f,  250.4409028755f },
    { 170.7876619406f,  96.9558811621f,  252.0743721732f },
    { 168.5018391752f,  98.2484304723f,  253.7053662721f },
    { 166.1753760941f,  99.6447597805f,  255.3325503795f },
    { 163.8062537525f,  101.1487314769f,  256.9547151281f },
    { 161.3922822181f,  102.7644861665f,  258.5707937477f },
    { 158.9310796529f,  104.4964979946f,  260.1798788933f },
    { 156.4200479895f,  106.3496402009f,  261.7812393271f },
    { 153.8563444970f,  108.3292630056f,  263.3743367735f },
    { 151.2368483553f,  110.4412865527f,  264.9588434179f },
    { 148.5581211216f,  112.6923124704f,  266.5346606945f },
    { 145.8163596675f,  115.0897587548f,  268.1019402336f },
    { 143.0073397545f,  117.6420242440f,  269.6611081185f },
    { 140.1263478626f,  120.3586911287f,  271.2128939804f },
    { 137.1680981363f,  123.2507770179f,  272.7583669697f },
    { 134.1266302648f,  126.3310524716f,  274.2989813585f },
    { 130.9951826493f,  129.6144463176f,  275.8366355651f },
    { 132.4438993729f,  128.9682821570f,  277.9013743846f },
    { 133.8698086186f,  128.4881700868f,  279.9275022835f },
    { 135.2739312535f,  128.1630041275f,  281.9125337949f },
    { 136.6572131541f,  127.9821926343f,  283.8543602985f },
    { 138.0205327307f,  127.9356495300f,  285.7512491171f },
    { 139.3647075073f,  128.0137874251f,  287.6018346844f },
    { 140.6904998986f,  128.2075112242f,  289.4051031042f },
    { 141.9986223002f,  128.5082112172f,  291.1603714833f },
    { 143.2897415893f,  128.9077549963f,  292.8672633949f },
    { 144.5644831175f,  129.3984778192f,  294.5256817487f },
    { 145.8234342632f,  129.9731712591f,  296.1357802097f },
    { 147.0671476026f,  130.6250701510f,  297.6979341505f },
    { 148.2961437473f,  131.3478379622f,  299.2127119497f },
    { 149.5109138909f,  132.1355507947f,  300.6808472825f },
    { 150.7119220998f,  132.9826802727f,  302.1032128828f },
    { 151.8996073796f,  133.8840755904f,  303.4807961178f },
    { 153.0743855423f,  134.8349449921f,  304.8146765861f },
    { 154.2366508988f,  135.8308369471f,  306.1060058488f },
    { 155.3867777950f,  136.8676212560f,  307.3559893165f },
    { 156.5251220088f,  137.9414702969f,  308.5658702536f },
    { 157.6520220246f,  139.0488405926f,  309.7369158097f },
    { 158.7678001964f,  140.1864548429f,  310.8704049575f },
    { 159.8727638119f,  141.3512845431f,  311.9676181930f },
    { 160.9672060682f,  142.5405332754f,  313.0298288452f },
    { 162.0514069671f,  143.7516207414f,  314.0582958357f },
    { 163.1256341384f,  144.9821675770f,  315.0542577313f },
    { 164.1901435982f,  146.2299809768f,  316.0189279405f },
    { 165.2451804480f,  147.4930411351f,  316.9534909095f },
    { 166.2909795207f,  148.7694885031f,  317.8590991881f },
    { 167.3277659781f,  150.0576118471f,  318.7368712434f },
    { 168.3557558637f,  151.3558370869f,  319.5878899131f },
    { 169.3751566161f,  152.6627168881f,  320.4132014011f },
    { 170.3861675452f,  153.9769209751f,  321.2138147285f },
    { 171.3889802751f,  155.2972271333f,  321.9907015643f },
    { 172.3837791560f,  156.6225128605f,  322.7447963693f },
    { 173.3707416489f,  157.9517476342f,  323.4769967954f },
    { 174.3500386829f,  159.2839857555f,  324.1881642909f },
    { 175.3218349908f,  160.6183597327f,  324.8791248688f },
    { 176.2862894207f,  161.9540741707f,  325.5506700013f },
    { 177.2435552298f,  163.2904001297f,  326.2035576110f },
    { 178.1937803575f,  164.6266699206f,  326.8385131312f },
    { 179.1371076828f,  165.9622723059f,  327.4562306145f },
    { 180.0736752657f,  167.2966480762f,  328.0573738712f },
    { 181.0036165733f,  168.6292859733f,  328.6425776227f },
    { 181.9270606926f,  169.9597189346f,  329.2124486577f },
    { 182.8441325315f,  171.2875206331f,  329.7675669804f },
    { 183.7549530068f,  172.6123022909f,  330.3084869440f },
    { 184.6596392223f,  173.9337097439f,  330.8357383623f },
    { 185.5583046363f,  175.2514207387f,  331.3498275944f },
    { 186.4510592201f,  176.5651424426f,  331.8512385995f },
    { 187.3380096073f,  177.8746091499f,  332.3404339582f },
    { 188.2192592352f,  179.1795801689f,  332.8178558589f },
    { 189.0949084784f,  180.4798378754f,  333.2839270474f },
    { 189.9650547753f,  181.7751859185f,  333.7390517405f },
    { 190.8297927483f,  183.0654475670f,  334.1836165011f },
    { 191.6892143167f,  184.3504641858f,  334.6179910769f },
    { 192.5434088053f,  185.6300938297f,  335.0425292023f },
    { 193.3924630459f,  186.9042099482f,  335.4575693639f },
    { 194.2364614749f,  188.1727001892f,  335.8634355309f },
    { 195.0754862254f,  189.4354652963f,  336.2604378514f },
    { 194.4490197137f,  189.5317954665f,  336.6528400563f },
    { 193.8196545935f,  189.6361686366f,  337.0499332947f },
    { 193.1873493717f,  189.7487884978f,  337.4518171207f },
    { 192.5520614155f,  189.8698643100f,  337.8585953743f },
    { 191.9137469023f,  189.9996110856f,  338.2703764881f },
    { 191.2723607653f,  190.1382497808f,  338.6872738227f },
    { 190.6278566367f,  190.2860074970f,  339.1094060343f },
    { 189.9801867863f,  190.4431176919f,  339.5368974761f },
    { 189.3293020560f,  190.6098204010f,  339.9698786396f },
    { 188.6751517902f,  190.7863624716f,  340.4084866391f },
    { 188.0176837599f,  190.9729978089f,  340.8528657445f },
    { 187.3568440831f,  191.1699876374f,  341.3031679687f },
    { 186.6925771372f,  191.3776007766f,  341.7595537155f },
    { 186.0248254660f,  191.5961139355f,  342.2221924968f },
    { 185.3535296784f,  191.8258120252f,  342.6912637259f },
    { 184.6786283396f,  192.0669884945f,  343.1669575986f },
    { 184.0000578524f,  192.3199456888f,  343.6494760720f },
    { 183.3177523285f,  192.5849952380f,  344.1390339564f },
    { 182.6316434487f,  192.8624584743f,  344.6358601321f },
    { 181.9416603098f,  193.1526668879f,  345.1401989133f },
    { 181.2477292570f,  193.4559626235f,  345.6523115760f },
    { 180.5497737007f,  193.7726990247f,  346.1724780768f },
    { 179.8477139142f,  194.1032412356f,  346.7009989899f },
    { 179.1414668102f,  194.4479668674f,  347.2381976967f },
    { 178.4309456943f,  194.8072667437f,  347.7844228676f },
    { 177.7160599903f,  195.1815457376f,  348.3400512841f },
    { 176.9967149341f,  195.5712237192f,  348.9054910573f },
    { 176.2728112310f,  195.9767366360f,  349.4811853120f },
    { 175.5442446711f,  196.3985377539f,  350.0676164181f },
    { 174.8109056945f,  196.8370990935f,  350.6653108692f },
    { 174.0726788988f,  197.2929131063f,  351.2748449316f },
    { 173.3294424779f,  197.7664946466f,  351.8968512114f },
    { 172.5810675795f,  198.2583833115f,  352.5320263271f },
    { 171.8274175643f,  198.7691462411f,  353.1811399155f },
    { 171.0683471495f,  199.2993814996f,  353.8450452605f },
    { 170.3037014083f,  199.8497221947f,  354.5246919091f },
    { 169.5333145971f,  200.4208415431f,  355.2211407363f },
    { 168.7570087670f,  201.0134591585f,  355.9355820564f },
    { 167.9745921103f,  201.6283489357f,  356.6693575520f },
    { 167.1858569708f,  202.2663490343f,  357.4239870333f },
    { 166.3905774296f,  202.9283746591f,  358.2012013727f },
    { 165.5885063450f,  203.6154346033f,  359.0029834160f },
    { 164.7793716817f,  204.3286529191f,  359.8316193291f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    398.645f,
    402.710f,
    406.677f,
    410.547f,
    414.301f,
    417.932f,
    421.429f,
    424.792f,
    428.009f,
    431.085f,
    434.015f,
    436.798f,
    439.441f,
    441.943f,
    444.312f,
    446.552f,
    448.676f,
    450.690f,
    452.600f,
    454.419f,
    456.158f,
    457.831f,
    459.442f,
    461.005f,
    462.537f,
    464.038f,
    464.020f,
    447.296f,
    431.873f,
    417.609f,
    404.382f,
    392.090f,
    380.640f,
    369.946f,
    359.949f,
    350.586f,
    341.803f,
    333.545f,
    325.781f,
    318.463f,
    311.560f,
    305.042f,
    298.877f,
    293.048f,
    287.531f,
    282.300f,
    277.338f,
    272.632f,
    268.164f,
    263.916f,
    259.882f,
    256.049f,
    252.399f,
    248.926f,
    245.624f,
    242.480f,
    239.490f,
    236.639f,
    233.929f,
    231.354f,
    228.900f,
    226.569f,
    224.347f,
    222.241f,
    220.233f,
    218.335f,
    216.534f,
    214.825f,
    213.208f,
    211.676f,
    210.236f,
    208.875f,
    207.593f,
    206.390f,
    205.267f,
    204.211f,
    203.235f,
    202.325f,
    201.483f,
    200.714f,
    200.006f,
    199.371f,
    198.798f,
    198.285f,
    197.833f,
    197.449f,
    197.125f,
    196.857f,
    196.655f,
    196.509f,
    196.429f,
    196.405f,
    196.442f,
    196.539f,
    196.692f,
    196.912f,
    197.186f,
    197.528f,
    197.925f,
    198.389f,
    198.914f,
    199.506f,
    200.159f,
    200.879f,
    201.666f,
    202.521f,
    203.442f,
    204.437f,
    205.505f,
    206.647f,
    207.867f,
    209.161f,
    210.541f,
    212.006f,
    213.550f,
    215.186f,
    216.913f,
    218.738f,
    220.660f,
    222.687f,
    224.817f,
    227.057f,
    229.419f,
    231.897f,
    234.503f,
    237.238f,
    240.118f,
    243.140f,
    246.313f,
    249.652f,
    253.156f,
    256.842f,
    260.718f,
    264.795f,
    269.086f,
    273.602f,
    278.357f,
    283.368f,
    288.654f,
    294.226f,
    300.116f,
    306.342f,
    312.933f,
    319.910f,
    327.307f,
    335.156f,
    343.500f,
    343.713f,
    334.778f,
    326.343f,
    318.372f,
    310.828f,
    303.687f,
    296.912f,
    290.491f,
    284.387f,
    278.595f,
    273.083f,
    267.841f,
    262.848f,
    258.093f,
    253.564f,
    249.243f,
    245.117f,
    241.187f,
    237.427f,
    233.844f,
    230.420f,
    227.142f,
    224.017f,
    221.027f,
    218.170f,
    215.436f,
    212.830f,
    210.333f,
    207.947f,
    205.664f,
    203.485f,
    201.404f,
    199.414f,
    197.516f,
    195.703f,
    193.976f,
    192.334f,
    190.759f,
    189.270f,
    187.848f,
    186.499f,
    185.217f,
    184.003f,
    182.849f,
    181.763f,
    180.737f,
    179.773f,
    178.870f,
    178.021f,
    177.228f,
    176.489f,
    175.806f,
    175.177f,
    174.597f,
    174.072f,
    173.596f,
    173.169f,
    172.791f,
    172.461f,
    172.186f,
    171.954f,
    171.771f,
    171.631f,
    171.545f,
    171.503f,
    171.509f,
    171.564f,
    171.661f,
    171.808f,
    172.003f,
    172.247f,
    172.534f,
    172.876f,
    173.260f,
    173.700f,
    174.182f,
    174.719f,
    175.305f,
    175.946f,
    176.636f,
    177.380f,
    178.180f,
    179.034f,
    179.944f,
    180.914f,
    181.940f,
    183.032f,
    184.180f,
    185.394f,
    186.670f,
    188.019f,
    189.429f,
    190.918f,
    192.474f,
    194.104f,
    195.819f,
    197.607f,
    199.481f,
    201.440f,
    203.485f,
    205.627f,
    207.861f,
    210.199f,
    212.634f,
    215.179f,
    217.841f,
    220.612f,
    223.505f,
    226.520f,
    229.675f,
    232.959f,
    236.389f,
    239.972f,
    243.707f,
    247.607f,
    251.678f,
    255.927f,
    260.364f,
    264.996f,
    269.836f,
    274.133f,
    271.960f,
    269.885f,
    267.914f,
    266.046f,
    264.270f,
    262.585f,
    260.992f,
    259.485f,
    258.069f,
    256.732f,
    255.481f,
    254.303f,
    253.210f,
    252.191f,
    251.245f,
    250.378f,
    249.579f,
    248.853f,
    248.193f,
    247.607f,
    247.089f,
    246.637f,
    246.252f,
    245.935f,
    245.685f,
    245.496f,
    245.374f,
    245.319f,
    245.325f,
    245.398f,
    245.532f,
    245.734f,
    245.996f,
    246.326f,
    246.716f,
    247.174f,
    247.699f,
    248.285f,
    248.938f,
    249.664f,
    250.452f,
    251.306f,
    252.228f,
    253.223f,
    254.285f,
    255.414f,
    256.622f,
    257.898f,
    259.247f,
    260.669f,
    262.170f,
    263.751f,
    265.405f,
    267.139f,
    268.958f,
    270.856f,
    272.833f,
    274.902f,
    277.051f,
    279.291f,
    281.616f,
    284.033f,
    286.536f,
    289.136f,
    291.827f,
    294.617f,
    297.491f,
    300.470f,
    303.540f,
    306.708f,
    309.967f,
    313.324f,
    316.772f,
    320.319f,
    323.950f,
    327.673f,
    331.482f,
    335.376f,
    339.343f,
    343.384f,
    347.491f,
    351.660f,
    355.878f,
    360.138f,
    364.435f,
    368.756f,
    373.090f,
    377.423f,
    381.744f,
    386.041f,
    390.302f,
    394.507f
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.892938232421875f,
    0.891931152343750f,
    0.890942382812500f,
    0.889978027343750f,
    0.889025878906250f,
    0.888098144531250f,
    0.887194824218750f,
    0.886309814453125f,
    0.885455322265625f,
    0.884619140625000f,
    0.883801269531250f,
    0.883013916015625f,
    0.882263183593750f,
    0.881518554687500f,
    0.880816650390625f,
    0.880126953125000f,
    0.879473876953125f,
    0.878839111328125f,
    0.878234863281250f,
    0.877636718750000f,
    0.877093505859375f,
    0.876544189453125f,
    0.876013183593750f,
    0.875543212890625f,
    0.875073242187500f,
    0.874566650390625f,
    0.874108886718750f,
    0.873706054687500f,
    0.873358154296875f,
    0.873565673828125f,
    0.875848388671875f,
    0.878021240234375f,
    0.880157470703125f,
    0.882067871093750f,
    0.883978271484375f,
    0.885772705078125f,
    0.887487792968750f,
    0.889190673828125f,
    0.890747070312500f,
    0.892321777343750f,
    0.893780517578125f,
    0.895227050781250f,
    0.896624755859375f,
    0.897961425781250f,
    0.899291992187500f,
    0.900537109375000f,
    0.901812744140625f,
    0.902978515625000f,
    0.904174804687500f,
    0.905303955078125f,
    0.906433105468750f,
    0.907519531250000f,
    0.908587646484375f,
    0.909643554687500f,
    0.910650634765625f,
    0.911682128906250f,
    0.912640380859375f,
    0.913635253906250f,
    0.914562988281250f,
    0.915509033203125f,
    0.916418457031250f,
    0.917321777343750f,
    0.918225097656250f,
    0.919085693359375f,
    0.919976806640625f,
    0.920800781250000f,
    0.921649169921875f,
    0.922479248046875f,
    0.923291015625000f,
    0.924121093750000f,
    0.924890136718750f,
    0.925689697265625f,
    0.926464843750000f,
    0.927221679687500f,
    0.927996826171875f,
    0.928735351562500f,
    0.929467773437500f,
    0.930212402343750f,
    0.930926513671875f,
    0.931628417968750f,
    0.932336425781250f,
    0.933032226562500f,
    0.933691406250000f,
    0.934356689453125f,
    0.935015869140625f,
    0.935662841796875f,
    0.936267089843750f,
    0.936865234375000f,
    0.937451171875000f,
    0.938012695312500f,
    0.938555908203125f,
    0.939074707031250f,
    0.939556884765625f,
    0.940002441406250f,
    0.940405273437500f,
    0.940759277343750f,
    0.941058349609375f,
    0.941284179687500f,
    0.941442871093750f,
    0.941510009765625f,
    0.941485595703125f,
    0.941290283203125f,
    0.940948486328125f,
    0.940429687500000f,
    0.933209228515625f,
    0.914770507812500f,
    0.895776367187500f,
    0.876123046875000f,
    0.871221923828125f,
    0.874163818359375f,
    0.876928710937500f,
    0.879541015625000f,
    0.882012939453125f,
    0.884344482421875f,
    0.886560058593750f,
    0.888653564453125f,
    0.890649414062500f,
    0.892541503906250f,
    0.894348144531250f,
    0.896063232421875f,
    0.897698974609375f,
    0.899261474609375f,
    0.900750732421875f,
    0.902172851562500f,
    0.903527832031250f,
    0.904827880859375f,
    0.906066894531250f,
    0.907250976562500f,
    0.908380126953125f,
    0.909460449218750f,
    0.910491943359375f,
    0.911480712890625f,
    0.912420654296875f,
    0.913317871093750f,
    0.914172363281250f,
    0.914984130859375f,
    0.915753173828125f,
    0.916485595703125f,
    0.917181396484375f,
    0.917834472656250f,
    0.918450927734375f,
    0.919024658203125f,
    0.920770263671875f,
    0.923956298828125f,
    0.926947021484375f,
    0.929766845703125f,
    0.932427978515625f,
    0.934936523437500f,
    0.937304687500000f,
    0.939550781250000f,
    0.941680908203125f,
    0.943695068359375f,
    0.945611572265625f,
    0.947436523437500f,
    0.949169921875000f,
    0.950817871093750f,
    0.952386474609375f,
    0.953869628906250f,
    0.955273437500000f,
    0.956622314453125f,
    0.957897949218750f,
    0.959124755859375f,
    0.960290527343750f,
    0.961401367187500f,
    0.962457275390625f,
    0.963458251953125f,
    0.964410400390625f,
    0.965313720703125f,
    0.966174316406250f,
    0.966992187500000f,
    0.967773437500000f,
    0.968505859375000f,
    0.969207763671875f,
    0.969854736328125f,
    0.970471191406250f,
    0.971051025390625f,
    0.971594238281250f,
    0.972100830078125f,
    0.972576904296875f,
    0.973016357421875f,
    0.973406982421875f,
    0.973773193359375f,
    0.974102783203125f,
    0.974395751953125f,
    0.974658203125000f,
    0.974877929687500f,
    0.975061035156250f,
    0.975207519531250f,
    0.975317382812500f,
    0.975390625000000f,
    0.975421142578125f,
    0.975402832031250f,
    0.975354003906250f,
    0.975262451171875f,
    0.975109863281250f,
    0.981506347656250f,
    0.991326904296875f,
    0.991168212890625f,
    0.990979003906250f,
    0.990802001953125f,
    0.990631103515625f,
    0.990460205078125f,
    0.990295410156250f,
    0.990124511718750f,
    0.989959716796875f,
    0.989801025390625f,
    0.989636230468750f,
    0.989471435546875f,
    0.989312744140625f,
    0.989154052734375f,
    0.989001464843750f,
    0.988854980468750f,
    0.988708496093750f,
    0.988543701171875f,
    0.988385009765625f,
    0.988232421875000f,
    0.988085937500000f,
    0.987945556640625f,
    0.987780761718750f,
    0.987628173828125f,
    0.987487792968750f,
    0.987347412109375f,
    0.987188720703125f,
    0.987036132812500f,
    0.986901855468750f,
    0.986749267578125f,
    0.986596679687500f,
    0.986456298828125f,
    0.986309814453125f,
    0.986151123046875f,
    0.986010742187500f,
    0.985864257812500f,
    0.985711669921875f,
    0.985571289062500f,
    0.985418701171875f,
    0.985260009765625f,
    0.985119628906250f,
    0.984960937500000f,
    0.984808349609375f,
    0.984667968750000f,
    0.984497070312500f,
    0.984344482421875f,
    0.984191894531250f,
    0.984027099609375f,
    0.983874511718750f,
    0.983703613281250f,
    0.983538818359375f,
    0.983380126953125f,
    0.983203125000000f,
    0.983044433593750f,
    0.982867431640625f,
    0.982690429687500f,
    0.982525634765625f,
    0.982330322265625f,
    0.982159423828125f,
    0.981970214843750f,
    0.981774902343750f,
    0.981597900390625f,
    0.981390380859375f,
    0.981195068359375f,
    0.980999755859375f,
    0.980780029296875f,
    0.980578613281250f,
    0.980352783203125f,
    0.980126953125000f,
    0.979919433593750f,
    0.979675292968750f,
    0.979437255859375f,
    0.979205322265625f,
    0.978942871093750f,
    0.978692626953125f,
    0.978430175781250f,
    0.978149414062500f,
    0.977880859375000f,
    0.977593994140625f,
    0.977288818359375f,
    0.977056884765625f,
    0.977081298828125f,
    0.977148437500000f,
    0.977166748046875f,
    0.977239990234375f,
    0.977258300781250f,
    0.977325439453125f,
    0.977343750000000f,
    0.977410888671875f,
    0.977435302734375f,
    0.977496337890625f,
    0.977526855468750f,
    0.977575683593750f,
    0.977618408203125f,
    0.977655029296875f,
    0.977716064453125f,
    0.977746582031250f,
    0.977807617187500f,
    0.977838134765625f,
    0.977880859375000f,
    0.977941894531250f,
    0.977972412109375f,
    0.978027343750000f,
    0.978076171875000f,
    0.978112792968750f,
    0.978161621093750f,
    0.978222656250000f,
    0.978253173828125f,
    0.978302001953125f,
    0.978363037109375f,
    0.978417968750000f,
    0.978454589843750f,
    0.978503417968750f,
    0.978558349609375f,
    0.978613281250000f,
    0.978674316406250f,
    0.978735351562500f,
    0.978790283203125f,
    0.978845214843750f,
    0.978900146484375f,
    0.978961181640625f,
    0.979022216796875f,
    0.979077148437500f,
    0.979132080078125f,
    0.979193115234375f,
    0.979266357421875f,
    0.979339599609375f,
    0.979394531250000f,
    0.979467773437500f,
    0.979541015625000f,
    0.979608154296875f,
    0.979687500000000f,
    0.979766845703125f,
    0.979840087890625f,
    0.979919433593750f,
    0.979998779296875f,
    0.969836425781250f,
    0.957556152343750f,
    0.945465087890625f,
    0.933532714843750f,
    0.921716308593750f,
    0.917895507812500f,
    0.916839599609375f,
    0.915777587890625f,
    0.914703369140625f,
    0.913616943359375f,
    0.912524414062500f,
    0.911431884765625f,
    0.910327148437500f,
    0.909216308593750f,
    0.908105468750000f,
    0.906994628906250f,
    0.905877685546875f,
    0.904766845703125f,
    0.903656005859375f,
    0.902551269531250f,
    0.901446533203125f,
    0.900347900390625f,
    0.899261474609375f,
    0.898175048828125f,
    0.897106933593750f,
    0.896044921875000f,
    0.894995117187500f,
    0.893963623046875f
};

#include "hellwig_lib_rc1.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1 = clamp3(AP1, 0.0f, 16384.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in.x = ST2084_to_linear(in.x) / referenceLuminance;
        in.y = ST2084_to_linear(in.y) / referenceLuminance;
        in.z = ST2084_to_linear(in.z) / referenceLuminance;
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);
    
            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-peak
            if (hardClip)
            {
                out = clamp3(referenceLuminance * out, 0.0f, daniele_n);
            }
            else
            {
                out *= referenceLuminance;
            }
        
            if (asPQ)
            {
                out = vector_dot(P3D65_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out / referenceLuminance, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}